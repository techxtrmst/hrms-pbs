{% extends 'core/base.html' %}
{% load static %}

{% block title %}Leave Dashboard | Petabytz{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: 1px solid rgba(255, 255, 255, 0.2);
        --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
        --hover-transform: translateY(-5px);
    }

    body {
        font-family: 'Outfit', sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
    }

    /* Hero Section */
    .dashboard-hero {
        background: white;
        padding: 2rem;
        border-radius: 24px;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
    }

    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle at center, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(30%, -30%);
    }

    .hero-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
        letter-spacing: -0.02em;
    }

    .hero-subtitle {
        color: #64748b;
        font-size: 1rem;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: var(--hover-transform);
        box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1);
        border-color: transparent;
    }

    .stat-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
        transition: transform 0.3s ease;
    }

    .stat-card:hover .stat-icon-wrapper {
        transform: scale(1.1) rotate(5deg);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
        background: -webkit-linear-gradient(45deg, #1e293b, #475569);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .stat-label {
        color: #64748b;
        font-weight: 500;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .progress-track {
        height: 6px;
        background: #f1f5f9;
        border-radius: 10px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .progress-bar-custom {
        height: 100%;
        border-radius: 10px;
        transition: width 1s ease-out;
    }

    /* Casual Leave Styling */
    .cl-card .stat-icon-wrapper {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
    }

    .cl-card:hover {
        border-bottom: 4px solid #6366f1;
    }

    .cl-bar {
        background: var(--primary-gradient);
    }

    /* Sick Leave Styling */
    .sl-card .stat-icon-wrapper {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .sl-card:hover {
        border-bottom: 4px solid #10b981;
    }

    .sl-bar {
        background: var(--success-gradient);
    }

    /* Apply Button */
    .btn-apply-float {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 50px;
        font-weight: 600;
        box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        /* Ensure z-index works */
        z-index: 10;
        /* Place above hero decorations */
        cursor: pointer;
        /* Ensure cursor indicates clickability */
    }

    .btn-apply-float:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.5);
        color: white;
    }

    /* Table Section */
    .table-container {
        background: white;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var(--card-shadow);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
    }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.75rem;
    }

    .custom-table th {
        color: #94a3b8;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .custom-table td {
        background: #f8fafc;
        padding: 1.25rem 1rem;
        vertical-align: middle;
        transition: all 0.2s;
    }

    .custom-table td:first-child {
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
    }

    .custom-table td:last-child {
        border-top-right-radius: 12px;
        border-bottom-right-radius: 12px;
    }

    .custom-table tr:hover td {
        background: white;
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 16px;
        border-radius: 30px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-pending {
        background: #fff7ed;
        color: #c2410c;
    }

    .status-approved {
        background: #f0fdf4;
        color: #15803d;
    }

    .status-rejected {
        background: #fef2f2;
        color: #b91c1c;
    }

    /* Modal Animation */
    .modal.fade .modal-dialog {
        transform: scale(0.95) translateY(20px);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal.show .modal-dialog {
        transform: scale(1) translateY(0);
    }

    .modal-content-premium {
        border: none;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
    }

    .modal-header-premium {
        background: #f8fafc;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-body-premium {
        padding: 2rem;
    }

    /* Form Controls */
    .form-floating-custom>.form-control {
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        padding: 1rem 1rem;
        height: auto;
        font-size: 1rem;
    }

    .form-floating-custom>.form-control:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .form-label-custom {
        font-weight: 500;
        color: #64748b;
        margin-bottom: 0.5rem;
        display: block;
    }

    .notice-box {
        background: #eff6ff;
        border-left: 4px solid #6366f1;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        color: #4338ca;
        display: flex;
        gap: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">

    <!-- Hero Section -->
    <div class="dashboard-hero d-flex justify-content-between align-items-center animate__animated animate__fadeInDown">
        <div>
            <h1 class="hero-title">Welcome back, {{ user.first_name }}! ðŸ‘‹</h1>
            <p class="hero-subtitle mb-0">Here's an overview of your leave balance and activity.</p>
        </div>
        <div>
            <button class="btn-apply-float" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
                <i class="fas fa-plus-circle text-lg"></i>
                <span>New Request</span>
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
        <!-- Casual Leave -->
        <div class="stat-card cl-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-icon-wrapper">
                        <i class="fas fa-mug-hot"></i>
                    </div>
                </div>
                <div class="text-end">
                    <div class="stat-value">{{ balance.casual_leave_balance|floatformat:1 }}</div>
                </div>
            </div>
            <div class="stat-label">
                <span>Casual Leave</span>
                <span>Days Available</span>
            </div>
            <div class="progress-track">
                <!-- Calculating percentage for visual bar (Assuming 12 is max) -->
                <div class="progress-bar-custom cl-bar"
                    style="width: {% widthratio balance.casual_leave_balance 12 100 %}%"></div>
            </div>
        </div>

        <!-- Sick Leave -->
        <div class="stat-card sl-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-icon-wrapper">
                        <i class="fas fa-first-aid"></i>
                    </div>
                </div>
                <div class="text-end">
                    <div class="stat-value">{{ balance.sick_leave_balance|floatformat:1 }}</div>
                </div>
            </div>
            <div class="stat-label">
                <span>Sick Leave</span>
                <span>Days Available</span>
            </div>
            <div class="progress-track">
                <div class="progress-bar-custom sl-bar"
                    style="width: {% widthratio balance.sick_leave_balance 12 100 %}%"></div>
            </div>
        </div>

        <!-- Unpaid Leave Indicator (Optional visual) -->
        <div class="stat-card" style="border-left: 4px solid #94a3b8;">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-icon-wrapper" style="background: #f1f5f9; color: #64748b;">
                        <i class="fas fa-user-clock"></i>
                    </div>
                </div>
                <div class="text-end">
                    <div class="stat-value" style="-webkit-text-fill-color: #64748b;">
                        {{ balance.unpaid_leave|floatformat:1|default:"0" }}</div>
                </div>
            </div>
            <div class="stat-label">
                <span>Unpaid Leaves</span>
                <span>Taken this year</span>
            </div>
            <div class="progress-track">
                <div class="progress-bar-custom" style="width: 100%; background: #cbd5e1;"></div>
            </div>
        </div>
    </div>

    <!-- Recent History Section -->
    <div class="table-container animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="section-header">
            <h2 class="section-title">Recent Activity</h2>
            <a href="{% url 'leave_history' %}" class="btn btn-outline-primary rounded-pill px-4 btn-sm fw-bold">View
                Full History</a>
        </div>

        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>Dates</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in recent_requests %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <div
                                    style="width: 40px; height: 40px; border-radius: 10px; background: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                    {% if req.leave_type == 'CL' %}
                                    <i class="fas fa-mug-hot text-primary"></i>
                                    {% elif req.leave_type == 'SL' %}
                                    <i class="fas fa-first-aid text-success"></i>
                                    {% else %}
                                    <i class="fas fa-circle text-muted"></i>
                                    {% endif %}
                                </div>
                                <div class="fw-bold" title="{{ req.reason }}">
                                    {{ req.get_leave_type_display }}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="fw-medium">{{ req.start_date|date:"d M" }} - {{ req.end_date|date:"d M, Y" }}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">{{ req.total_days }} Days</span>
                        </td>
                        <td>
                            {% if req.status == 'PENDING' %}
                            <span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>
                            {% elif req.status == 'APPROVED' %}
                            <span class="status-badge status-approved"><i class="fas fa-check-circle"></i>
                                Approved</span>
                            {% else %}
                            <span class="status-badge status-rejected"><i class="fas fa-times-circle"></i>
                                Rejected</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if req.status == 'PENDING' %}
                            <form method="post" action="{% url 'cancel_my_leave_request' req.id %}"
                                onsubmit="return confirm('Are you sure you want to cancel this request?');"
                                class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-link text-danger p-0 text-decoration-none"
                                    title="Cancel Request">
                                    Cancel
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted small">--</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <i class="far fa-calendar-check fa-3x text-muted mb-3 opacity-50"></i>
                                <span class="text-muted">No recent leave requests found</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Premium Apply Leave Modal -->
<div class="modal fade" id="applyLeaveModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-premium">
            <form method="post" action="{% url 'my_leaves' %}" id="leaveForm" novalidate>
                {% csrf_token %}
                <div class="modal-header modal-header-premium">
                    <div>
                        <h5 class="modal-title fw-bold">New Leave Request</h5>
                        <p class="text-muted small mb-0">Fill in the details below to submit your request.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body modal-body-premium">

                    <div class="notice-box">
                        <i class="fas fa-info-circle mt-1"></i>
                        <div>
                            You can apply for <strong>Casual Leave</strong>, <strong>Sick Leave</strong>, or
                            <strong>Unpaid Leave (LOP)</strong>.
                            <br>Unpaid Leave will result in Loss of Pay for the selected duration.
                        </div>
                    </div>

                    <div class="row g-4">
                        <!-- Leave Type -->
                        <div class="col-12">
                            <label class="form-label-custom">Select Leave Type</label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input type="radio" class="btn-check" name="leave_type" id="type_cl" value="CL"
                                        checked>
                                    <label
                                        class="btn btn-outline-primary w-100 p-3 h-100 d-flex flex-column align-items-center gap-2 rounded-3"
                                        for="type_cl">
                                        <i class="fas fa-mug-hot fs-4"></i>
                                        <span class="fw-bold">Casual Leave</span>
                                    </label>
                                </div>
                                <div class="col-md-4">
                                    <input type="radio" class="btn-check" name="leave_type" id="type_sl" value="SL">
                                    <label
                                        class="btn btn-outline-success w-100 p-3 h-100 d-flex flex-column align-items-center gap-2 rounded-3"
                                        for="type_sl">
                                        <i class="fas fa-first-aid fs-4"></i>
                                        <span class="fw-bold">Sick Leave</span>
                                    </label>
                                </div>
                                <div class="col-md-4">
                                    <input type="radio" class="btn-check" name="leave_type" id="type_ul" value="UL">
                                    <label
                                        class="btn btn-outline-secondary w-100 p-3 h-100 d-flex flex-column align-items-center gap-2 rounded-3"
                                        for="type_ul">
                                        <i class="fas fa-ban fs-4"></i>
                                        <span class="fw-bold">Unpaid Leave</span>
                                        <small class="text-muted">(LOP)</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="col-md-6">
                            <label class="form-label-custom">Start Date</label>
                            <input type="date" name="start_date" id="start_date"
                                class="form-control form-control-lg rounded-3 fs-6">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">End Date</label>
                            <input type="date" name="end_date" id="end_date"
                                class="form-control form-control-lg rounded-3 fs-6">
                        </div>

                        <!-- Duration Preview -->
                        <div class="col-12">
                            <div class="bg-light rounded-3 p-3 d-flex justify-content-between align-items-center">
                                <span class="text-muted fw-medium">Estimated Duration:</span>
                                <span class="fw-bold text-primary fs-5" id="durationCalc">0 Days</span>
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="col-12">
                            <label class="form-label-custom">Reason for Leave</label>
                            <textarea name="reason" id="reasonInput" class="form-control rounded-3" rows="3"
                                placeholder="Please describe why you are requesting this leave..."
                                style="resize: none;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-top-0 px-4 pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit"
                        class="btn btn-primary rounded-pill px-5 fw-bold btn-apply-float shadow-none">Submit
                        Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Balances
        const clBalance = parseFloat("{{ balance.casual_leave_balance|default:0 }}");
        const slBalance = parseFloat("{{ balance.sick_leave_balance|default:0 }}");

        // Elements
        const clRadio = document.getElementById('type_cl');
        const slRadio = document.getElementById('type_sl');
        const ulRadio = document.getElementById('type_ul');

        // Helper to disable option
        function disableOption(radio, balance) {
            if (balance <= 0 && radio) {
                radio.disabled = true;
                const label = document.querySelector(`label[for="${radio.id}"]`);
                if (label) {
                    label.classList.add('opacity-50', 'pe-none'); // Bootstrap utility classes
                    label.setAttribute('title', 'Insufficient Balance');
                }
            }
        }

        // Apply restrictions
        disableOption(clRadio, clBalance);
        disableOption(slRadio, slBalance);

        // Auto-select Unpaid Leave if no balance (or if currently selected option is disabled)
        if ((clBalance <= 0 && slBalance <= 0) || (clRadio.checked && clBalance <= 0) || (slRadio.checked && slBalance <= 0)) {
            if (ulRadio) {
                ulRadio.click();
            }
        }

        const startInput = document.getElementById('start_date');
        const endInput = document.getElementById('end_date');
        const reasonInput = document.getElementById('reasonInput');
        const durationDisplay = document.getElementById('durationCalc');

        function calculateDuration() {
            const startStr = startInput.value;
            const endStr = endInput.value;

            if (startStr && endStr) {
                const start = new Date(startStr);
                const end = new Date(endStr);

                if (end >= start) {
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    durationDisplay.innerText = diffDays + (diffDays === 1 ? ' Day' : ' Days');
                    durationDisplay.classList.remove('text-danger');
                    durationDisplay.classList.add('text-primary');
                } else {
                    durationDisplay.innerText = 'Invalid Date Range';
                    durationDisplay.classList.add('text-danger');
                    durationDisplay.classList.remove('text-primary');
                }
            } else {
                durationDisplay.innerText = '0 Days';
            }
        }

        startInput.addEventListener('change', calculateDuration);
        endInput.addEventListener('change', calculateDuration);

        // Form Validation on Submit
        document.getElementById('leaveForm').addEventListener('submit', function (e) {
            const startStr = startInput.value;
            const endStr = endInput.value;
            const reason = reasonInput.value.trim();

            if (!startStr || !endStr) {
                e.preventDefault();
                alert('Please select both Start and End dates.');
                return;
            }

            if (!reason) {
                e.preventDefault();
                alert('Please provide a reason for your leave.');
                return;
            }

            const start = new Date(startStr);
            const end = new Date(endStr);

            if (end < start) {
                e.preventDefault();
                alert('End date cannot be before start date.');
            }
        });
    });
</script>
{% endblock %}