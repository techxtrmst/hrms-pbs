{% extends 'core/base.html' %}
{% load static %}

{% block title %}Apply Leave | HRMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    :root {
        --keka-primary: #5b47fb;
        --keka-primary-light: #eef2ff;
        --keka-text: #1f2937;
        --keka-muted: #6b7280;
        --keka-border: #e5e7eb;
    }

    body {
        background-color: #f3f4f6;
        font-family: 'Inter', sans-serif;
    }

    .leave-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        max-width: 600px;
        margin: 40px auto;
        overflow: hidden;
    }

    .leave-header {
        padding: 24px 32px;
        border-bottom: 1px solid var(--keka-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .leave-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--keka-text);
        margin: 0;
    }

    .btn-close-custom {
        background: transparent;
        border: none;
        color: var(--keka-muted);
        font-size: 1.25rem;
        cursor: pointer;
        transition: color 0.2s;
    }

    .btn-close-custom:hover {
        color: var(--keka-text);
    }

    .leave-body {
        padding: 32px;
    }

    .info-box {
        background-color: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
        align-items: start;
    }

    .info-icon {
        color: #0369a1;
        font-size: 1.1rem;
        margin-top: 2px;
    }

    .info-text {
        font-size: 0.9rem;
        color: #0c4a6e;
        line-height: 1.5;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }

    .form-control,
    .form-select {
        border-radius: 8px;
        border: 1px solid var(--keka-border);
        padding: 10px 12px;
        font-size: 0.95rem;
        width: 100%;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--keka-primary);
        box-shadow: 0 0 0 3px rgba(91, 71, 251, 0.1);
        outline: none;
    }

    .date-input-group {
        position: relative;
    }

    .date-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--keka-muted);
        pointer-events: none;
    }

    .leave-footer {
        padding: 20px 32px;
        background-color: #f9fafb;
        border-top: 1px solid var(--keka-border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn-cancel {
        background: white;
        border: 1px solid var(--keka-border);
        color: var(--keka-text);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        background-color: #f3f4f6;
    }

    .btn-submit {
        background-color: var(--keka-primary);
        color: white;
        border: none;
        padding: 8px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-submit:hover {
        background-color: #4338ca;
        transform: translateY(-1px);
    }

    textarea.form-control {
        resize: none;
        min-height: 100px;
    }

    .form-error {
        color: #dc2626;
        font-size: 0.85rem;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="leave-card">
        <div class="leave-header">
            <h1 class="leave-title">Apply Leave</h1>
            <a href="{% url 'employee_profile' %}" class="btn-close-custom"><i class="fas fa-times"></i></a>
        </div>

        <form method="post" enctype="multipart/form-data" id="leaveForm">
            {% csrf_token %}
            <div class="leave-body">

                {% if form.errors %}
                <div class="alert alert-danger mb-4">
                    <ul class="mb-0 ps-3">
                        {% for field in form %}
                        {% for error in field.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Info Box -->
                <div class="info-box">
                    <i class="fas fa-info-circle info-icon"></i>
                    <div class="info-text">
                        You can apply for <strong>Casual Leave</strong>, <strong>Sick Leave</strong>, or <strong>Unpaid
                            Leave (LOP)</strong>.
                        Note that if you have no balance, you should select Unpaid Leave.
                        Different leave types cannot be combined in a single request.
                    </div>
                </div>

                <!-- Leave Type -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.leave_type.id_for_label }}">Leave Type</label>
                    {{ form.leave_type }}
                    <!-- Note: Ensure form.leave_type renders a select with class 'form-select' via widget tweaks or JS -->
                </div>

                <!-- Dates Row -->
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label class="form-label">From Date</label>
                        <div class="date-input-group">
                            {{ form.start_date }}
                            <i class="far fa-calendar date-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="form-label">To Date</label>
                        <div class="date-input-group">
                            {{ form.end_date }}
                            <i class="far fa-calendar date-icon"></i>
                        </div>
                    </div>
                </div>

                <!-- Duration Section (Hidden by default or dynamic) -->
                <div class="form-group">
                    <label class="form-label">Duration</label>
                    <div class="d-flex gap-4 mt-2">
                        {% for radio in form.duration %}
                        <div class="form-check">
                            {{ radio.tag }}
                            <label class="form-check-label" for="{{ radio.id_for_label }}">
                                {{ radio.choice_label }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Reason -->
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    {{ form.reason }}
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label class="form-label">Supporting Document (Optional)</label>
                    {{ form.supporting_document }}
                </div>
            </div>

            <div class="leave-footer">
                <a href="{% url 'employee_profile' %}" class="btn-cancel">Cancel</a>
                <button type="submit" class="btn-submit">Request Leave</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const clBalance = parseFloat("{{ cl_balance|default:0 }}");
        const elBalance = parseFloat("{{ el_balance|default:0 }}");

        // Auto-select Unpaid Leave if no balance
        if (clBalance <= 0 && elBalance <= 0) {
            const leaveTypeSelect = document.querySelector('select[name="leave_type"]');
            if (leaveTypeSelect) {
                leaveTypeSelect.value = 'UL';
                // Trigger change event if there are listeners
                leaveTypeSelect.dispatchEvent(new Event('change'));
            }
        }

        // Initialize Flatpickr
        flatpickr("input[name='start_date'], input[name='end_date']", {
            dateFormat: "Y-m-d",
            minDate: "today",
            allowInput: true
        });

        // Add Bootstrap classes to Django form fields
        const inputs = document.querySelectorAll('input[type="text"], input[type="date"], select, textarea, input[type="file"]');
        inputs.forEach(input => {
            if (input.type === 'file' || input.type === 'checkbox' || input.type === 'radio') {
                if (input.type === 'file') input.classList.add('form-control');
                if (input.type === 'radio') input.classList.add('form-check-input');
            } else {
                if (input.tagName === 'SELECT') {
                    input.classList.add('form-select');
                } else {
                    input.classList.add('form-control');
                }
            }

            // Placeholder logic
            if (input.name === 'reason') {
                input.placeholder = "Type your reason here...";
            }
            if (input.tagName === 'SELECT') {
                // Check if it has a placeholder option, otherwise maybe add one via JS? 
                // Django usually handles empty label if configured.
            }
        });

        // Dynamic Leave Type Logic (Optional)
        const leaveTypeSelect = document.querySelector('select[name="leave_type"]');
        leaveTypeSelect.addEventListener('change', function () {
            if (this.value === 'UL') {
                // visual feedback for LOP
                // maybe show a warning text?
            }
        });
    });
</script>
{% endblock %}