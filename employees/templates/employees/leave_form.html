{% extends 'core/base.html' %}
{% load static %}

{% block title %}Apply Leave | HRMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    :root {
        --keka-primary: #5b47fb;
        --keka-primary-light: #eef2ff;
        --keka-text: #1f2937;
        --keka-muted: #6b7280;
        --keka-border: #e5e7eb;
    }

    body {
        background-color: #f3f4f6;
        font-family: 'Inter', sans-serif;
    }

    .leave-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        max-width: 600px;
        margin: 40px auto;
        overflow: hidden;
    }

    .leave-header {
        padding: 24px 32px;
        border-bottom: 1px solid var(--keka-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .leave-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--keka-text);
        margin: 0;
    }

    .btn-close-custom {
        background: transparent;
        border: none;
        color: var(--keka-muted);
        font-size: 1.25rem;
        cursor: pointer;
        transition: color 0.2s;
    }

    .btn-close-custom:hover {
        color: var(--keka-text);
    }

    .leave-body {
        padding: 32px;
    }

    .info-box {
        background-color: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
        align-items: start;
    }

    .info-icon {
        color: #0369a1;
        font-size: 1.1rem;
        margin-top: 2px;
    }

    .info-text {
        font-size: 0.9rem;
        color: #0c4a6e;
        line-height: 1.5;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }

    .form-control,
    .form-select {
        border-radius: 8px;
        border: 1px solid var(--keka-border);
        padding: 10px 12px;
        font-size: 0.95rem;
        width: 100%;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--keka-primary);
        box-shadow: 0 0 0 3px rgba(91, 71, 251, 0.1);
        outline: none;
    }

    .date-input-group {
        position: relative;
    }

    .date-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--keka-muted);
        pointer-events: none;
    }

    .leave-footer {
        padding: 20px 32px;
        background-color: #f9fafb;
        border-top: 1px solid var(--keka-border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn-cancel {
        background: white;
        border: 1px solid var(--keka-border);
        color: var(--keka-text);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        background-color: #f3f4f6;
    }

    .btn-submit {
        background-color: var(--keka-primary);
        color: white;
        border: none;
        padding: 8px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-submit:hover {
        background-color: #4338ca;
        transform: translateY(-1px);
    }

    .btn-submit:disabled {
        background-color: #9ca3af;
        color: #6b7280;
        cursor: not-allowed;
        transform: none;
    }

    .btn-submit:disabled:hover {
        background-color: #9ca3af;
        transform: none;
    }

    textarea.form-control {
        resize: none;
        min-height: 100px;
    }

    .form-error {
        color: #dc2626;
        font-size: 0.85rem;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="leave-card">
        <div class="leave-header">
            <h1 class="leave-title">Apply Leave</h1>
            <a href="{% url 'employee_profile' %}" class="btn-close-custom"><i class="fas fa-times"></i></a>
        </div>

        <form method="post" enctype="multipart/form-data" id="leaveForm">
            {% csrf_token %}
            <div class="leave-body">

                {% if form.errors %}
                <div class="alert alert-danger mb-4">
                    <ul class="mb-0 ps-3">
                        {% for field in form %}
                        {% for error in field.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if validation_warning and show_confirmation %}
                <div class="alert alert-danger mb-4" id="validationWarning">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-triangle me-2 mt-1" style="color: #dc2626; font-size: 1.2rem;"></i>
                        <div>
                            <strong style="color: #dc2626;">⚠️ LEAVE BALANCE INSUFFICIENT</strong><br>
                            <div class="mt-2" style="font-size: 0.95rem;">
                                {{ validation_warning.message }}
                            </div>
                            <div class="mt-2 p-2 bg-light rounded" style="font-size: 0.9rem;">
                                <strong>Details:</strong><br>
                                • Requested: <span class="text-primary">{{ validation_warning.requested_days }} days</span><br>
                                • Available: <span class="text-success">{{ validation_warning.available_balance }} days</span><br>
                                • Will be LOP: <span class="text-danger">{{ validation_warning.shortfall }} days</span>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-secondary me-2" onclick="cancelLeaveApplication()">
                                    <i class="fas fa-times me-1"></i>Cancel Application
                                </button>
                                <button type="button" class="btn btn-warning" onclick="confirmLOPApplication()">
                                    <i class="fas fa-check me-1"></i>I Understand - Proceed with LOP
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Real-time validation alert -->
                <div class="alert alert-info mb-4" id="balanceInfo" style="display: none;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-2 mt-1"></i>
                        <div id="balanceInfoText"></div>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="info-box">
                    <i class="fas fa-info-circle info-icon"></i>
                    <div class="info-text">
                        <strong>Current Leave Balances:</strong><br>
                        Casual Leave: <span class="fw-bold text-primary">{{ cl_balance|floatformat:1 }}</span> days |
                        Sick Leave: <span class="fw-bold text-primary">{{ sl_balance|floatformat:1 }}</span> days
                        <br><br>
                        <small>If you don't have sufficient balance, the excess days will be processed as <strong>Unpaid Leave (LOP)</strong>.</small>
                    </div>
                </div>

                <!-- Leave Type -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.leave_type.id_for_label }}">Leave Type</label>
                    {{ form.leave_type }}
                    <!-- Note: Ensure form.leave_type renders a select with class 'form-select' via widget tweaks or JS -->
                </div>

                <!-- Dates Row -->
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label class="form-label">From Date</label>
                        <div class="date-input-group">
                            {{ form.start_date }}
                            <i class="far fa-calendar date-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="form-label">To Date</label>
                        <div class="date-input-group">
                            {{ form.end_date }}
                            <i class="far fa-calendar date-icon"></i>
                        </div>
                    </div>
                </div>

                <!-- Duration Section -->
                <div class="form-group" id="durationSection">
                    <label class="form-label">Duration</label>
                    {{ form.duration }}
                    <small class="text-muted mt-1" id="durationHelp">
                        First Half and Second Half options are only available for single-day leaves.
                    </small>
                </div>

                <!-- Reason -->
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    {{ form.reason }}
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label class="form-label">Supporting Document (Optional)</label>
                    {{ form.supporting_document }}
                </div>
            </div>

            <div class="leave-footer">
                <a href="{% url 'employee_profile' %}" class="btn-cancel">Cancel</a>
                <button type="submit" class="btn-submit" id="submitBtn">
                    <span id="submitText">Request Leave</span>
                    <span id="loadingText" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-1"></i>Submitting...
                    </span>
                </button>
                <input type="hidden" name="confirm_lop" id="confirmLopInput" value="false">
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const clBalance = parseFloat("{{ cl_balance|default:0 }}");
        const slBalance = parseFloat("{{ sl_balance|default:0 }}");

        // Form elements with null checks
        const leaveTypeSelect = document.querySelector('select[name="leave_type"]');
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        const durationSelect = document.querySelector('select[name="duration"]');
        const balanceInfo = document.getElementById('balanceInfo');
        const balanceInfoText = document.getElementById('balanceInfoText');
        const submitBtn = document.getElementById('submitBtn');

        // Check if required elements exist
        if (!leaveTypeSelect || !startDateInput || !endDateInput || !balanceInfo || !balanceInfoText || !submitBtn || !durationSelect) {
            console.error('Required form elements not found');
            return;
        }

        // Auto-select Unpaid Leave if no balance
        if (clBalance <= 0 && slBalance <= 0) {
            if (leaveTypeSelect) {
                leaveTypeSelect.value = 'UL';
                leaveTypeSelect.dispatchEvent(new Event('change'));
            }
        }

        // Initialize Flatpickr
        flatpickr("input[name='start_date'], input[name='end_date']", {
            dateFormat: "Y-m-d",
            minDate: "today",
            allowInput: true,
            onChange: function() {
                setTimeout(validateLeaveBalance, 100);
            }
        });

        // Add Bootstrap classes to Django form fields
        const inputs = document.querySelectorAll('input[type="text"], input[type="date"], select, textarea, input[type="file"]');
        inputs.forEach(input => {
            if (input.type === 'file' || input.type === 'checkbox' || input.type === 'radio') {
                if (input.type === 'file') input.classList.add('form-control');
                if (input.type === 'radio') input.classList.add('form-check-input');
            } else {
                if (input.tagName === 'SELECT') {
                    input.classList.add('form-select');
                } else {
                    input.classList.add('form-control');
                }
            }

            if (input.name === 'reason') {
                input.placeholder = "Type your reason here...";
            }
        });

        // Event listeners for real-time validation (with null checks)
        if (leaveTypeSelect) {
            leaveTypeSelect.addEventListener('change', validateLeaveBalance);
        }
        if (startDateInput) {
            startDateInput.addEventListener('change', function() {
                updateDurationOptions();
                validateLeaveBalance();
            });
        }
        if (endDateInput) {
            endDateInput.addEventListener('change', function() {
                updateDurationOptions();
                validateLeaveBalance();
            });
        }
        if (durationSelect) {
            durationSelect.addEventListener('change', validateLeaveBalance);
        }

        // Function to update duration options based on date selection
        function updateDurationOptions() {
            if (!startDateInput || !endDateInput || !durationSelect) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const durationHelp = document.getElementById('durationHelp');
            
            if (!durationHelp) return;
            
            if (startDate && endDate) {
                const isSingleDay = startDate === endDate;
                
                if (isSingleDay) {
                    // Enable all options for single-day leaves
                    Array.from(durationSelect.options).forEach(option => {
                        option.disabled = false;
                    });
                    
                    durationHelp.textContent = 'Select Full Day, First Half (Morning), or Second Half (Afternoon).';
                    durationHelp.className = 'text-muted mt-1';
                } else {
                    // Disable half-day options for multi-day leaves
                    Array.from(durationSelect.options).forEach(option => {
                        if (option.value === 'FIRST_HALF' || option.value === 'SECOND_HALF') {
                            option.disabled = true;
                        } else {
                            option.disabled = false;
                        }
                    });
                    
                    // Auto-select Full Day for multi-day leaves
                    durationSelect.value = 'FULL';
                    
                    durationHelp.textContent = 'Multi-day leaves are automatically set to Full Day.';
                    durationHelp.className = 'text-info mt-1';
                }
            } else {
                // Enable all options when dates are not selected
                Array.from(durationSelect.options).forEach(option => {
                    option.disabled = false;
                });
                
                durationHelp.textContent = 'First Half and Second Half options are only available for single-day leaves.';
                durationHelp.className = 'text-muted mt-1';
            }
        }

        // Initial duration options update - ensure all options are visible by default
        setTimeout(() => {
            updateDurationOptions();
        }, 100);

        function validateLeaveBalance() {
            if (!leaveTypeSelect || !startDateInput || !endDateInput || !balanceInfo || !balanceInfoText || !submitBtn || !durationSelect) {
                return;
            }
            
            const leaveType = leaveTypeSelect.value;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const duration = durationSelect.value || 'FULL';

            if (!leaveType || !startDate || !endDate) {
                balanceInfo.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            // Make AJAX request to check balance
            fetch('{% url "api_check_leave_balance" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    leave_type: leaveType,
                    start_date: startDate,
                    end_date: endDate,
                    duration: duration
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Validation response:', data);
                
                if (data.status === 'success') {
                    const validation = data.validation;
                    const requestedDays = data.requested_days;
                    
                    if (validation.will_be_lop && leaveType !== 'UL') {
                        balanceInfo.className = 'alert alert-warning mb-4';
                        balanceInfoText.innerHTML = `
                            <strong>⚠️ Insufficient Leave Balance:</strong><br>
                            ${validation.message}<br>
                            <small><strong>Requested:</strong> ${requestedDays} days | <strong>Available:</strong> ${validation.available_balance} days | <strong>Will be LOP:</strong> ${validation.shortfall} days</small>
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="cancelLeaveApplication()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                                <button type="button" class="btn btn-sm btn-warning" onclick="confirmLOPApplication()">
                                    <i class="fas fa-check me-1"></i>Proceed with LOP
                                </button>
                            </div>
                        `;
                        balanceInfo.style.display = 'block';
                        
                        // Disable submit button until user confirms
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Confirm LOP to Proceed';
                        
                    } else if (leaveType === 'UL') {
                        balanceInfo.className = 'alert alert-info mb-4';
                        balanceInfoText.innerHTML = `
                            <strong>Unpaid Leave (LOP):</strong><br>
                            ${requestedDays} days will be processed as Loss of Pay.
                        `;
                        balanceInfo.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Request Leave';
                        
                    } else {
                        balanceInfo.className = 'alert alert-success mb-4';
                        balanceInfoText.innerHTML = `
                            <strong>✅ Leave Available:</strong><br>
                            You have sufficient ${validation.leave_type_display || 'leave'} balance for ${requestedDays} days.
                        `;
                        balanceInfo.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Request Leave';
                    }
                } else {
                    console.error('Validation failed:', data.message);
                    balanceInfo.style.display = 'none';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Request Leave';
                }
            })
            .catch(error => {
                console.error('Error checking leave balance:', error);
                balanceInfo.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Request Leave';
            });
        }

        // Initial validation
        setTimeout(validateLeaveBalance, 500);

        // Prevent double submission
        let isSubmitting = false;
        const submitText = document.getElementById('submitText');
        const loadingText = document.getElementById('loadingText');

        // Prevent form submission if LOP confirmation is required
        const leaveForm = document.getElementById('leaveForm');
        if (leaveForm) {
            leaveForm.addEventListener('submit', function(e) {
                const confirmLopInput = document.getElementById('confirmLopInput');
                const confirmLopValue = confirmLopInput ? confirmLopInput.value : 'false';
                
                if (submitBtn && submitBtn.disabled && confirmLopValue !== 'true') {
                    e.preventDefault();
                    alert('Please confirm the LOP (Loss of Pay) to proceed with your leave application.');
                    return false;
                }

                // Prevent double submission
                if (isSubmitting) {
                    e.preventDefault();
                    return false;
                }

                // Disable button and show loading state
                isSubmitting = true;
                if (submitBtn) {
                    submitBtn.disabled = true;
                    if (submitText) submitText.style.display = 'none';
                    if (loadingText) loadingText.style.display = 'inline';
                    submitBtn.style.opacity = '0.7';
                    submitBtn.style.cursor = 'not-allowed';
                }
            });
        }
    });

    // Functions for confirmation dialog
    function cancelLeaveApplication() {
        window.location.href = '{% url "employee_profile" %}';
    }

    function confirmLOPApplication() {
        // Set confirmation value
        const confirmLopInput = document.getElementById('confirmLopInput');
        if (confirmLopInput) {
            confirmLopInput.value = 'true';
        }
        
        // Enable submit button if it was disabled
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Request Leave (with LOP)';
        }
        
        // Hide the server-side validation warning
        const validationWarning = document.getElementById('validationWarning');
        if (validationWarning) {
            validationWarning.style.display = 'none';
        }
        
        // Update the balance info to show confirmation
        const balanceInfo = document.getElementById('balanceInfo');
        const balanceInfoText = document.getElementById('balanceInfoText');
        if (balanceInfo && balanceInfoText) {
            balanceInfoText.innerHTML = `
                <strong>✅ LOP Confirmed:</strong><br>
                Your leave application will proceed with Loss of Pay for the excess days.
                <br><small>You can now submit your leave request.</small>
            `;
            balanceInfo.className = 'alert alert-success mb-4';
            balanceInfo.style.display = 'block';
        }
        
        // Auto-submit the form
        const leaveForm = document.getElementById('leaveForm');
        if (leaveForm) {
            leaveForm.submit();
        }
    }
</script>
{% endblock %}