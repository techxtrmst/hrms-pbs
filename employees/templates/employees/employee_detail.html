{% extends 'core/base.html' %}
{% load static %}

{% block title %}Employee Details | {{ employee.user.get_full_name }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    /* Keka-style Profile Header */
    .profile-header-card {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border-radius: 16px;
        padding: 2.5rem;
        color: white;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.2);
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .profile-header-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 100%;
        background: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" stroke="rgba(255,255,255,0.1)" stroke-width="2" fill="none"/></svg>') no-repeat right center;
        background-size: cover;
        opacity: 0.5;
    }

    .emp-avatar-lg {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        border: 4px solid rgba(255, 255, 255, 0.3);
        margin-right: 1.5rem;
        overflow: hidden;
    }

    .emp-info h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .emp-designation {
        font-size: 1rem;
        opacity: 0.9;
        font-weight: 500;
        margin-bottom: 1rem;
        display: block;
    }

    .emp-meta span {
        background: rgba(255, 255, 255, 0.15);
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    /* Stats Cards */
    .stats-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #f1f5f9;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        transition: transform 0.2s;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-title {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .stat-value {
        color: #1e293b;
        font-size: 1.75rem;
        font-weight: 800;
    }

    .bg-soft-primary {
        background: #e0e7ff;
        color: #4338ca;
    }

    .bg-soft-success {
        background: #dcfce7;
        color: #15803d;
    }

    .bg-soft-warning {
        background: #fef9c3;
        color: #a16207;
    }

    .bg-soft-info {
        background: #e0f2fe;
        color: #0369a1;
    }

    .bg-soft-danger {
        background: #fee2e2;
        color: #b91c1c;
    }

    /* Map Section */
    .map-container {
        height: 400px;
        border-radius: 16px;
        overflow: hidden;
        border: 4px solid white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Attendance Table */
    .modern-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
    }

    .modern-table thead th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .modern-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
        color: #334155;
        vertical-align: middle;
    }

    .modern-table tr:last-child td {
        border-bottom: none;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-present {
        background: #dcfce7;
        color: #166534;
    }

    .status-wfh {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-leave {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-absent {
        background: #f1f5f9;
        color: #64748b;
    }

    /* Exit Banner */
    .exit-banner {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 2px solid #fca5a5;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(239, 68, 68, 0.1);
    }

    .exit-banner-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        color: #991b1b;
    }

    .exit-banner-content i {
        font-size: 1.5rem;
        margin-top: 0.25rem;
    }

    .exit-details {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .exit-type-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .exit-resigned {
        background: #fef3c7;
        color: #92400e;
    }

    .exit-absconded {
        background: #fee2e2;
        color: #991b1b;
    }

    .exit-terminated {
        background: #fecaca;
        color: #7f1d1d;
    }

    .exit-date {
        color: #7f1d1d;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* ID Proof Button Styling */
    .btn-id-proof {
        position: relative;
        z-index: 10;
        background: white !important;
        color: #4f46e5 !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        padding: 0.5rem 1rem !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
        text-decoration: none !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .btn-id-proof:hover {
        background: #f8f9ff !important;
        color: #4338ca !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3) !important;
        border-color: #4f46e5 !important;
    }

    .btn-id-proof:active {
        transform: translateY(0) !important;
    }
</style>

{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Exit Banner -->
    {% if not employee.is_active %}
    <div class="exit-banner">
        <div class="exit-banner-content">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>This employee is no longer part of the organization</strong>
                <div class="exit-details">
                    <span class="exit-type-badge exit-{{ employee.employment_status|lower }}">
                        {{ employee.get_employment_status_display }}
                    </span>
                    <span class="exit-date">Last Working Date: {{ employee.exit_date|date:"d M, Y" }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Profile Header -->
    <div class="profile-header-card d-flex align-items-center">
        <div class="emp-avatar-lg">
            {% if employee.profile_picture %}
            <img src="{{ employee.profile_picture.url }}" alt="{{ employee.user.get_full_name }}"
                style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            {{ employee.user.first_name|first|upper }}{{ employee.user.last_name|first|upper }}
            {% endif %}
        </div>
        <div class="emp-info">
            <h2>{{ employee.user.get_full_name }}</h2>
            <span class="emp-designation">{{ employee.designation|default:"Employee" }}</span>
            <div class="emp-meta">
                <span><i class="fas fa-building"></i> {{ employee.department|default:"Dept N/A" }}</span>
                <span><i class="fas fa-envelope"></i> {{ employee.user.email }}</span>
                <span><i class="fas fa-id-badge"></i> {{ employee.badge_id|default:"-" }}</span>
            </div>
        </div>
        <div class="ms-auto me-4 text-end">
            <h4 class="mb-1 text-white-50">Attendance Overview</h4>
            <div class="h5 mb-0">{{ current_month }} {{ current_year }}</div>
        </div>

        <!-- ID Proof Button (Admin Only) -->
        {% if user.role == 'COMPANY_ADMIN' or user.role == 'SUPERADMIN' %}
        <a href="{% url 'employee_id_proofs' employee.pk %}" class="btn-id-proof">
            <i class="fas fa-id-card"></i> ID Proofs
        </a>
        {% endif %}
    </div>

    <!-- Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-2"> <!-- Adjusted col size for 5 cards -->
            <div class="stats-card">
                <div class="stats-icon bg-soft-primary"><i class="fas fa-calendar-alt"></i></div>
                <div class="stat-title">Total Days</div>
                <div class="stat-value">{{ stats.total }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-icon bg-soft-success"><i class="fas fa-check-circle"></i></div>
                <div class="stat-title">Present</div>
                <div class="stat-value">{{ stats.present }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon bg-soft-info"><i class="fas fa-laptop-house"></i></div>
                <div class="stat-title">Work From Home</div>
                <div class="stat-value">{{ stats.wfh }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-icon bg-soft-warning"><i class="fas fa-umbrella-beach"></i></div>
                <div class="stat-title">On Leave</div>
                <div class="stat-value">{{ stats.leave }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon bg-soft-danger"><i class="fas fa-user-slash"></i></div>
                <div class="stat-title">Absent</div>
                <div class="stat-value">{{ stats.absent }}</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Attendance Table -->
        <div class="col-lg-7">
            <div class="modern-table">
                <div class="p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-history me-2 text-primary"></i> Attendance Log
                    </h5>
                    <!-- Month Filter stub -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            {{ current_month }}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?month=1&year={{ current_year }}">January</a></li>
                            <!-- Using simple links for now, could be dynamic -->
                            <li><a class="dropdown-item" href="?month={{ 12 }}&year={{ current_year }}">December</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Logs</th>
                                <th>Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for att in attendance_history %}
                            <tr>
                                <td class="fw-bold">{{ att.date|date:"D, d M" }}</td>
                                <td>
                                    {% if att.status == 'PRESENT' %}
                                    <span class="status-badge status-present">Present</span>
                                    {% elif att.status == 'WFH' %}
                                    <span class="status-badge status-wfh">WFH</span>
                                    {% elif att.status == 'LEAVE' %}
                                    <span class="status-badge status-leave">Leave</span>
                                    {% else %}
                                    <span class="status-badge status-absent">{{ att.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'attendance_map' att.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-map-marked-alt me-1"></i> View Map
                                    </a>
                                </td>
                                <td>
                                    {{ att.effective_hours|default:"-" }}
                                    {% if not att.clock_out and att.clock_in %}
                                    <span class="badge bg-success-soft text-success ms-1"
                                        style="font-size: 0.6em;">Active</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">No attendance records found for this
                                    month.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-map-marked-alt me-2 text-info"></i> Movement Activity</h5>
                    <small class="text-muted">Tracking for {{ map_date|date:"d M, Y" }}</small>
                </div>
                <div class="card-body p-0">
                    <div id="activityMap" class="map-container" style="height: 500px; border: none;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Exit Action Modal -->
<div class="modal fade" id="exitModal" tabindex="-1" aria-labelledby="exitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exitModalLabel">Employee Exit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="exitForm">
                {% csrf_token %}
                <input type="hidden" id="exitType" name="exit_type">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will mark the employee as exited and disable their login
                        access.
                    </div>

                    <div class="mb-3">
                        <label for="exitDate" class="form-label">Last Working Date <span
                                class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="exitDate" name="exit_date" required>
                    </div>

                    <div class="mb-3">
                        <label for="exitNote" class="form-label">Exit Reason/Note <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="exitNote" name="exit_note" rows="4"
                            placeholder="Provide detailed reason for exit..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Submit Exit</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

{{ map_data|json_script:"map-data-initial" }}

<script>
    let map;
    let markersLayer;
    let pathLayer;

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Map
        map = L.map('activityMap').setView([20.5937, 78.9629], 5); // Default Center

        // Google Layers
        const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Maps'
        });

        const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Maps'
        });

        // OSM Layer (optional)
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        });

        // Add Google Streets by default (like Keka)
        googleStreets.addTo(map);

        // Layer Control
        const baseMaps = {
            "Google Streets": googleStreets,
            "Satellite": googleHybrid,
            "OpenStreetMap": osm
        };
        L.control.layers(baseMaps).addTo(map);

        markersLayer = L.layerGroup().addTo(map);
        pathLayer = L.layerGroup().addTo(map);

        // Load initial data if available
        const initialData = JSON.parse(document.getElementById('map-data-initial').textContent);
        if (initialData && initialData.length > 0) {
            drawMap(initialData);
        } else {
            setTimeout(() => { map.invalidateSize(); }, 200);
        }

        // Event delegation for view map buttons
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.view-map-btn');
            if (btn) {
                const id = btn.dataset.attendanceId;
                const date = btn.dataset.date;
                console.log("Button Clicked:", id, date);
                if (id) viewMap(id, date);
            }
        });
    });

    function drawMap(mapData) {
        console.log('=== drawMap called ===');
        console.log('mapData:', mapData);
        console.log('mapData type:', typeof mapData);
        console.log('mapData length:', mapData ? mapData.length : 'null/undefined');

        // Parse if string (sometimes Django sends JSON as string)
        if (typeof mapData === 'string') {
            console.log('mapData is a string, parsing JSON...');
            try {
                mapData = JSON.parse(mapData);
                console.log('Successfully parsed mapData:', mapData);
            } catch (e) {
                console.error('Failed to parse mapData:', e);
                alert('Error parsing location data');
                return;
            }
        }

        // Ensure map handles container size updates
        map.invalidateSize();

        // Clear existing
        markersLayer.clearLayers();
        pathLayer.clearLayers();

        if (!mapData || mapData.length === 0) {
            console.error('No location data - mapData is empty or null');
            alert("No location data available for this record.");
            return;
        }

        console.log(`Processing ${mapData.length} location points...`);
        const latlngs = [];


        // Create custom icons for different marker types - LARGE and VISIBLE like Keka
        const createCustomIcon = (color, iconClass, size = 40) => {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <i class="${iconClass}" style="color: white; font-size: ${size / 2.5}px;"></i>
                </div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
                popupAnchor: [0, -size / 2]
            });
        };

        mapData.forEach((point, index) => {
            latlngs.push([point.lat, point.lng]);

            // Custom Icon based on type - LARGER markers for better visibility
            let icon;
            let markerColor;

            if (point.type === 'start') {
                icon = createCustomIcon('#10b981', 'fas fa-play', 50); // Larger for start - 50px
                markerColor = '#10b981';
            } else if (point.type === 'end') {
                icon = createCustomIcon('#ef4444', 'fas fa-stop', 50); // Larger for end - 50px
                markerColor = '#ef4444';
            } else {
                icon = createCustomIcon('#3b82f6', 'fas fa-circle', 40); // Tracking points - 40px
                markerColor = '#3b82f6';
            }

            // Create marker with custom icon
            const marker = L.marker([point.lat, point.lng], { icon: icon })
                .addTo(markersLayer)
                .bindPopup(`
                    <div class="text-center" style="min-width: 220px; padding: 10px;">
                        <strong style="color: ${markerColor}; font-size: 18px; display: block; margin-bottom: 8px;">${point.type_display || point.title}</strong>
                        <div class="my-2" style="font-size: 15px; color: #333;"><i class="far fa-clock me-2"></i> ${point.time_display || ''}</div>
                        <small class="text-muted" style="font-size: 12px;"><i class="fas fa-map-marker-alt me-1"></i> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</small>
                    </div>
                `);

            // Auto-open popup for start marker only
            if (point.type === 'start') {
                setTimeout(() => marker.openPopup(), 600);
            }
        });

        // Draw Path Line - Make it more visible
        if (latlngs.length > 1) {
            L.polyline(latlngs, {
                color: '#2563eb',  // Brighter blue
                weight: 5,         // Thicker line
                opacity: 0.9,      // More opaque
                smoothFactor: 1
            }).addTo(pathLayer);

            setTimeout(() => {
                map.invalidateSize();
                map.fitBounds(latlngs, { padding: [50, 50], maxZoom: 16 });
            }, 100);
        } else if (latlngs.length === 1) {
            setTimeout(() => {
                map.invalidateSize();
                map.setView(latlngs[0], 16);
            }, 100);
        }
    }

    function viewMap(attendanceId, dateStr) {
        console.log(`viewMap called for ID: ${attendanceId}, Date: ${dateStr}`);

        // Update Card Header
        const headerSmall = document.querySelector('.card-header small');
        if (headerSmall) headerSmall.textContent = `Tracking for ${dateStr}`;

        // Show Loading
        const mapContainer = document.getElementById('activityMap');
        // Don't fully destroy map, just show an overlay or ensure we don't break it
        // Simpler: just log for now

        // Fetch Data
        console.log(`Fetching: /employees/api/attendance/${attendanceId}/map-data/`);
        fetch(`/employees/api/attendance/${attendanceId}/map-data/`)
            .then(response => {
                console.log('Response Status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Map Data received:', data);
                if (data.status === 'success') {
                    drawMap(data.data);
                } else {
                    console.error('API Error:', data.message);
                    alert(data.message || 'Error fetching map data');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert(`Failed to load map data: ${error.message}`);
            });
    }


</script>

<script>
    // Exit Management Functions (Global scope for inline onclick handlers)
    let currentExitType = '';

    function openExitModal(exitType) {
        currentExitType = exitType;
        document.getElementById('exitType').value = exitType;

        // Update modal title based on type
        const modalTitle = document.getElementById('exitModalLabel');
        modalTitle.textContent = `Mark Employee as ${exitType.charAt(0) + exitType.slice(1).toLowerCase()}`;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('exitModal'));
        modal.show();
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function () {
        const exitForm = document.getElementById('exitForm');
        if (exitForm) {
            exitForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const employeeId = "{{ employee.pk }}";

                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                fetch(`/employees/${employeeId}/exit-action/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Close modal
                            const modalEl = document.getElementById('exitModal');
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();

                            // Show success message
                            alert(data.message);

                            // Redirect to employee list
                            window.location.href = data.redirect_url;
                        } else {
                            alert('Error: ' + data.message);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing the exit action.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
            });
        }
    });</script>
{% endblock %}