{% extends 'core/base.html' %}
{% load static %}

{% block title %}Employee Details | {{ employee.user.get_full_name }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    /* Keka-style Profile Header */
    .profile-header-card {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border-radius: 16px;
        padding: 2.5rem;
        color: white;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.2);
        margin-bottom: 2rem;
        position: relative;
        /* overflow: hidden; Removed to allow dropdown to show */
    }

    .profile-header-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 100%;
        background: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" stroke="rgba(255,255,255,0.1)" stroke-width="2" fill="none"/></svg>') no-repeat right center;
        background-size: cover;
        opacity: 0.5;
    }

    .emp-avatar-lg {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        border: 4px solid rgba(255, 255, 255, 0.3);
        margin-right: 1.5rem;
        overflow: hidden;
    }

    .emp-info h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .emp-designation {
        font-size: 1rem;
        opacity: 0.9;
        font-weight: 500;
        margin-bottom: 1rem;
        display: block;
    }

    .emp-meta span {
        background: rgba(255, 255, 255, 0.15);
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    /* Stats Cards */
    .stats-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #f1f5f9;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        transition: transform 0.2s;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-title {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .stat-value {
        color: #1e293b;
        font-size: 1.75rem;
        font-weight: 800;
    }

    .bg-soft-primary {
        background: #e0e7ff;
        color: #4338ca;
    }

    .bg-soft-success {
        background: #dcfce7;
        color: #15803d;
    }

    .bg-soft-warning {
        background: #fef9c3;
        color: #a16207;
    }

    .bg-soft-info {
        background: #e0f2fe;
        color: #0369a1;
    }

    .bg-soft-danger {
        background: #fee2e2;
        color: #b91c1c;
    }

    /* Map Section */
    .map-container {
        height: 400px;
        border-radius: 16px;
        overflow: hidden;
        border: 4px solid white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Attendance Table */
    .modern-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
    }

    .modern-table thead th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .modern-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
        color: #334155;
        vertical-align: middle;
    }

    .modern-table tr:last-child td {
        border-bottom: none;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-present {
        background: #dcfce7;
        color: #166534;
    }

    .status-wfh {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-leave {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-absent {
        background: #f1f5f9;
        color: #64748b;
    }

    .status-holiday {
        background: #e0f2fe;
        color: #0369a1;
    }

    .status-missed {
        background: #fee2e2;
        color: #b91c1c;
    }

    .status-not-login {
        background: #fef9c3;
        color: #a16207;
    }

    /* Exit Banner */
    .exit-banner {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 2px solid #fca5a5;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(239, 68, 68, 0.1);
    }

    .exit-banner-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        color: #991b1b;
    }

    .exit-banner-content i {
        font-size: 1.5rem;
        margin-top: 0.25rem;
    }

    .exit-details {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .exit-type-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .exit-resigned {
        background: #fef3c7;
        color: #92400e;
    }

    .exit-absconded {
        background: #fee2e2;
        color: #991b1b;
    }

    .exit-terminated {
        background: #fecaca;
        color: #7f1d1d;
    }

    .exit-date {
        color: #7f1d1d;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* ID Proof Button Styling */
    .btn-id-proof {
        position: relative;
        z-index: 10;
        background: white !important;
        color: #4f46e5 !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        padding: 0.5rem 1rem !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
        text-decoration: none !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .btn-id-proof:hover {
        background: #f8f9ff !important;
        color: #4338ca !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3) !important;
        border-color: #4f46e5 !important;
    }

    .btn-id-proof:active {
        transform: translateY(0) !important;
    }

    /* Profile Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .info-item {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
    }

    .info-item:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
    }

    .info-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 700;
        margin-bottom: 0.25rem;
        letter-spacing: 0.05em;
    }

    .info-value {
        font-size: 0.95rem;
        color: #1e293b;
        font-weight: 600;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #334155;
        margin-bottom: 1.25rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: #4f46e5;
    }

    /* Custom Nav Pills */
    .nav-pills .nav-link {
        color: #64748b;
        background: transparent;
        transition: all 0.3s;
    }

    .nav-pills .nav-link.active {
        background: #4f46e5;
        color: white;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .nav-pills .nav-link:hover:not(.active) {
        background: #f1f5f9;
        color: #4f46e5;
    }

    /* Timeline Styles */
    .timeline-wrapper {
        position: relative;
        padding-left: 0.5rem;
    }

    .timeline-line {
        position: absolute;
        top: 0.5rem;
        bottom: 0;
        left: 31px;
        width: 2px;
        background: #e2e8f0;
    }

    .timeline-node {
        position: relative;
        padding-left: 3.5rem;
        margin-bottom: 2rem;
    }

    .timeline-node:last-child {
        margin-bottom: 0;
    }

    .timeline-dot {
        width: 20px;
        height: 20px;
        left: 22px;
        position: absolute;
        top: 0.25rem;
        background: white;
        border: 3px solid #cbd5e1;
        border-radius: 50%;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .timeline-dot.active {
        border-color: #4f46e5;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
    }

    .timeline-dot-inner {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #cbd5e1;
    }

    .timeline-dot.active .timeline-dot-inner {
        background: #4f46e5;
    }

    .timeline-content {
        padding: 1.25rem;
        background: #fff;
        border-radius: 1rem;
        border: 1px solid #f1f5f9;
        transition: 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .timeline-content:hover {
        transform: translateX(5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .timeline-date {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #64748b;
        margin-bottom: 0.25rem;
        display: block;
    }

    .timeline-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: #1e293b;
    }
</style>

{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Exit Banner -->
    {% if not employee.is_active %}
    <div class="exit-banner">
        <div class="exit-banner-content">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>This employee is no longer part of the organization</strong>
                <div class="exit-details">
                    <span class="exit-type-badge exit-{{ employee.employment_status|lower }}">
                        {{ employee.get_employment_status_display }}
                    </span>
                    <span class="exit-date">Last Working Date: {{ employee.exit_date|date:"d M, Y" }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Profile Header -->
    <div class="profile-header-card d-flex align-items-center">
        <div class="emp-avatar-lg">
            {% if employee.profile_picture %}
            <img src="{{ employee.profile_picture.url }}" alt="{{ employee.user.get_full_name }}"
                style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            {{ employee.user.first_name|first|upper }}{{ employee.user.last_name|first|upper }}
            {% endif %}
        </div>
        <div class="emp-info">
            <h2>{{ employee.user.get_full_name }}</h2>
            <span class="emp-designation">{{ employee.designation|default:"Employee" }}</span>
            <div class="emp-meta">
                <span><i class="fas fa-building"></i> {{ employee.department|default:"Dept N/A" }}</span>
                <span><i class="fas fa-envelope"></i> {{ employee.user.email }}</span>
                <span><i class="fas fa-id-badge"></i> {{ employee.badge_id|default:"-" }}</span>
            </div>
        </div>
        <div class="ms-auto me-4 text-end">
            <h4 class="mb-1 text-white-50">Attendance Overview</h4>
            <div class="h5 mb-0">{{ current_month }} {{ current_year }}</div>
        </div>

        {% if user.role == 'COMPANY_ADMIN' or user.role == 'SUPERADMIN' %}
        <a href="{% url 'employee_id_proofs' employee.pk %}" class="btn-id-proof">
            <i class="fas fa-id-card"></i> ID Proofs
        </a>

        <!-- Exit Actions Menu -->
        <div class="ms-3 dropdown d-inline-block">
            <button class="btn btn-link text-white p-0 text-decoration-none" type="button" data-bs-toggle="dropdown"
                aria-expanded="false" style="font-size: 1.5rem; line-height: 1;">
                <i class="fas fa-ellipsis-v"></i>
            </button>

            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 mt-2">
                <li>
                    <h6 class="dropdown-header text-uppercase small text-muted fw-bold px-3 py-2">Exit Actions</h6>
                </li>
                <li>
                    <a class="dropdown-item px-3 py-2 text-warning" href="#" onclick="openExitModal('RESIGNATION')">
                        <i class="fas fa-sign-out-alt me-2 fa-fw"></i> Initiate Resignation
                    </a>
                </li>
                <li>
                    <a class="dropdown-item px-3 py-2 text-primary" href="#" onclick="openExitModal('TERMINATED')">
                        <i class="fas fa-ban me-2 fa-fw"></i> Terminate Employee
                    </a>
                </li>
                <li>
                    <a class="dropdown-item px-3 py-2 text-dark" href="#" onclick="openExitModal('ABSCONDED')">
                        <i class="fas fa-user-slash me-2 fa-fw"></i> Mark Absconded
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item px-3 py-2 text-danger fw-bold"
                        href="{% url 'employee_delete' employee.pk %}"
                        onclick="return confirm('Are you sure you want to PERMANENTLY DELETE this employee? This action cannot be undone.');">
                        <i class="fas fa-trash-alt me-2 fa-fw"></i> Delete Employee
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Nav Tabs for Organization -->
    <div class="mb-4">
        <ul class="nav nav-pills gap-2 p-1 bg-white rounded-pill shadow-sm d-inline-flex border" id="detailTabs"
            role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-pill px-4 fw-bold" id="attendance-tab" data-bs-toggle="tab"
                    data-bs-target="#attendance-pane" type="button" role="tab" aria-controls="attendance-pane"
                    aria-selected="true">
                    <i class="fas fa-calendar-check me-2"></i>Attendance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4 fw-bold" id="profile-tab" data-bs-toggle="tab"
                    data-bs-target="#profile-pane" type="button" role="tab" aria-controls="profile-pane"
                    aria-selected="false">
                    <i class="fas fa-id-card me-2"></i>Profile Details
                </button>
            </li>
        </ul>
    </div>

    <div class="tab-content" id="detailTabsContent">
        <!-- ATTENDANCE PANE -->
        <div class="tab-pane fade show active" id="attendance-pane" role="tabpanel" aria-labelledby="attendance-tab">
            <!-- Stats Row -->
            <div class="row g-4 mb-4">
                <div class="col-md-2">
                    <div class="stats-card">
                        <div class="stats-icon bg-soft-primary"><i class="fas fa-calendar-alt"></i></div>
                        <div class="stat-title">Total Days</div>
                        <div class="stat-value">{{ stats.total }}</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <div class="stats-icon bg-soft-success"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-title">Present</div>
                        <div class="stat-value">{{ stats.present }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-icon bg-soft-info"><i class="fas fa-laptop-house"></i></div>
                        <div class="stat-title">Work From Home</div>
                        <div class="stat-value">{{ stats.wfh }}</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <div class="stats-icon bg-soft-warning"><i class="fas fa-umbrella-beach"></i></div>
                        <div class="stat-title">On Leave</div>
                        <div class="stat-value">{{ stats.leave }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-icon bg-soft-danger"><i class="fas fa-user-slash"></i></div>
                        <div class="stat-title">Absent</div>
                        <div class="stat-value">{{ stats.absent }}</div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Attendance Table -->
                <div class="col-lg-7">
                    <div class="modern-table">
                        <div class="p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
                            <h5 class="m-0 fw-bold text-dark"><i class="fas fa-history me-2 text-primary"></i>
                                Attendance Log</h5>
                            <div class="d-flex align-items-center">
                                <div class="btn-group me-2">
                                    <a href="?month=1&year={{ current_year|add:'-1' }}"
                                        class="btn btn-sm btn-outline-secondary" title="Previous Year">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                    <span class="btn btn-sm btn-outline-secondary disabled"
                                        style="background: #f8f9fa;">{{ current_year }}</span>
                                    <a href="?month=1&year={{ current_year|add:'1' }}"
                                        class="btn btn-sm btn-outline-secondary" title="Next Year">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                        {{ current_month }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="?month=1&year={{ current_year }}">January</a>
                                        </li>
                                        <li><a class="dropdown-item"
                                                href="?month=2&year={{ current_year }}">February</a></li>
                                        <li><a class="dropdown-item" href="?month=3&year={{ current_year }}">March</a>
                                        </li>
                                        <li><a class="dropdown-item" href="?month=4&year={{ current_year }}">April</a>
                                        </li>
                                        <li><a class="dropdown-item" href="?month=5&year={{ current_year }}">May</a>
                                        </li>
                                        <li><a class="dropdown-item" href="?month=6&year={{ current_year }}">June</a>
                                        </li>
                                        <li><a class="dropdown-item" href="?month=7&year={{ current_year }}">July</a>
                                        </li>
                                        <li><a class="dropdown-item" href="?month=8&year={{ current_year }}">August</a>
                                        </li>
                                        <li><a class="dropdown-item"
                                                href="?month=9&year={{ current_year }}">September</a></li>
                                        <li><a class="dropdown-item"
                                                href="?month=10&year={{ current_year }}">October</a></li>
                                        <li><a class="dropdown-item"
                                                href="?month=11&year={{ current_year }}">November</a></li>
                                        <li><a class="dropdown-item"
                                                href="?month=12&year={{ current_year }}">December</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Logs</th>
                                        <th>Hours</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for att in attendance_history %}
                                    <tr>
                                        <td class="fw-bold">{{ att.date|date:"D, d M" }}</td>
                                        <td>
                                            {% if att.status == 'PRESENT' %}
                                            <span class="status-badge status-present">Present</span>
                                            {% elif att.status == 'WFH' %}
                                            <span class="status-badge status-wfh">WFH</span>
                                            {% elif att.status == 'LEAVE' %}
                                            <span class="status-badge status-leave">Leave</span>
                                            {% elif att.status == 'WEEKLY_OFF' %}
                                            <span class="status-badge status-absent">Week Off</span>
                                            {% elif att.status == 'HOLIDAY' %}
                                            <span class="status-badge status-holiday"
                                                title="{{ att.holiday_name }}">Holiday</span>
                                            {% elif att.status == 'MISSED' %}
                                            <span class="status-badge status-missed">Missed</span>
                                            {% elif att.status == 'NOT_LOGGED_IN' %}
                                            <span class="status-badge status-not-login">Not Login</span>
                                            {% else %}
                                            <span class="status-badge status-absent">{{ att.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if att.id %}
                                            <a href="{% url 'attendance_map' att.id %}"
                                                class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-map-marked-alt me-1"></i> View Map
                                            </a>
                                            {% else %}
                                            <span class="text-muted small">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ att.effective_hours|default:"-" }}
                                            {% if not att.clock_out and att.clock_in %}
                                            <span class="badge bg-success-soft text-success ms-1"
                                                style="font-size: 0.6em;">Active</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">No attendance records found
                                            for this month.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="col-lg-5">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-map-marked-alt me-2 text-info"></i> Movement
                                Activity</h5>
                            <small class="text-muted">Tracking for {{ map_date|date:"d M, Y" }}</small>
                        </div>
                        <div class="card-body p-0">
                            <div id="activityMap" class="map-container" style="height: 500px; border: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE PANE -->
        <div class="tab-pane fade" id="profile-pane" role="tabpanel" aria-labelledby="profile-tab">
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">
                    <div class="row g-5">
                        <!-- Left Side: Profile Info -->
                        <div class="col-lg-8">
                            <!-- Personal Details Section -->
                            <div class="mb-5">
                                <h6 class="section-title"><i class="fas fa-user"></i> Personal Information</h6>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <div class="info-label">Date of Birth</div>
                                        <div class="info-value">{{ employee.dob|date:"d M, Y"|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Gender</div>
                                        <div class="info-value">{{ employee.get_gender_display|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Marital Status</div>
                                        <div class="info-value">{{ employee.get_marital_status_display|default:"-" }}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Mobile Number</div>
                                        <div class="info-value">{{ employee.mobile_number|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Personal Email</div>
                                        <div class="info-value">{{ employee.personal_email|default:"-" }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Details Section -->
                            <div class="mb-5">
                                <h6 class="section-title"><i class="fas fa-briefcase"></i> Job & Organizational Details
                                </h6>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <div class="info-label">Employee ID</div>
                                        <div class="info-value">{{ employee.badge_id|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Designation</div>
                                        <div class="info-value">{{ employee.designation|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Department</div>
                                        <div class="info-value">{{ employee.department|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Reporting Manager</div>
                                        <div class="info-value">{{ employee.manager.get_full_name|default:"Directly to Admin" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Work Type</div>
                                        <div class="info-value">{{ employee.get_work_type_display|default:"Full Time" }}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Location</div>
                                        <div class="info-value">{{ employee.location.name|default:"-" }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Assigned Shift</div>
                                        <div class="info-value">
                                            {% if employee.assigned_shift %}
                                            {{ employee.assigned_shift.name }} ({{ employee.assigned_shift.start_time|time:"H:i" }} - {{ employee.assigned_shift.end_time|time:"H:i" }})
                                            {% else %}
                                            {{ employee.shift_schedule|default:"-" }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Joining Date</div>
                                        <div class="info-value">{{ employee.date_of_joining|date:"d M, Y"|default:"-" }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Side: Work Timeline -->
                        <div class="col-lg-4">
                            <h6 class="section-title"><i class="fas fa-history"></i> Work Timeline</h6>
                            <div class="timeline-wrapper">
                                <div class="timeline-line"></div>

                                <!-- Present -->
                                <div class="timeline-node">
                                    <div class="timeline-dot active">
                                        <div class="timeline-dot-inner"></div>
                                    </div>
                                    <div class="timeline-content">
                                        <span class="timeline-date">Today</span>
                                        <div class="timeline-title text-primary">Current Role</div>
                                        <div class="badge bg-primary-soft text-primary mt-1">
                                            {{ employee.designation }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Probation -->
                                <div class="timeline-node">
                                    <div class="timeline-dot active">
                                        <div class="timeline-dot-inner"></div>
                                    </div>
                                    <div class="timeline-content">
                                        <span class="timeline-date">Probation Status</span>
                                        <div class="timeline-title">Confirmed Employee</div>
                                        <div class="small text-muted">Permanent Staff</div>
                                    </div>
                                </div>

                                <!-- Joining Date -->
                                <div class="timeline-node">
                                    <div class="timeline-dot active">
                                        <div class="timeline-dot-inner"></div>
                                    </div>
                                    <div class="timeline-content">
                                        <span class="timeline-date">{{ employee.date_of_joining|date:"M d, Y"|default:"-" }}</span>
                                        <div class="timeline-title">Joined Organization</div>
                                        <div class="small text-muted">{{ employee.department }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Addresses Section -->
                    <div class="mb-5">
                        <h6 class="section-title"><i class="fas fa-map-marked-alt"></i> Addresses</h6>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="info-item h-100">
                                    <div class="info-label">Current Address</div>
                                    <div class="info-value text-muted" style="font-weight: 400; font-size: 0.9rem;">
                                        {{ employee.current_address|default:"Not provided"|linebreaksbr }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item h-100">
                                    <div class="info-label">Permanent Address</div>
                                    <div class="info-value text-muted" style="font-weight: 400; font-size: 0.9rem;">
                                        {{ employee.permanent_address|default:"Same as current or not provided"|linebreaksbr }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Details (Visible to Admins only) -->
                    {% if user.role == 'COMPANY_ADMIN' or user.role == 'SUPERADMIN' %}
                    <div>
                        <h6 class="section-title"><i class="fas fa-file-invoice-dollar"></i> Financial & Compliance Info
                        </h6>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Bank Name</div>
                                <div class="info-value">{{ employee.bank_name|default:"-" }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Account Number</div>
                                <div class="info-value text-break">{% if employee.account_number %}{{ employee.account_number }}{% else %}-{% endif %}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">IFSC Code</div>
                                <div class="info-value">{{ employee.ifsc_code|default:"-" }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">UAN Number</div>
                                <div class="info-value">{{ employee.uan|default:"-" }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">PF Enabled</div>
                                <div class="info-value">
                                    {% if employee.pf_enabled %}
                                    <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Annual CTC</div>
                                <div class="info-value text-success">{% if employee.annual_ctc %}₹{{ employee.annual_ctc }}{% else %}-{% endif %}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Exit Action Modal -->
<div class="modal fade" id="exitModal" tabindex="-1" aria-labelledby="exitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exitModalLabel">Employee Exit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="exitForm">
                {% csrf_token %}
                <input type="hidden" id="exitType" name="exit_type">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will initiate the exit process.
                    </div>

                    <div class="mb-3">
                        <label for="exitDate" class="form-label" id="dateLabel">Submission/Action Date <span
                                class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="exitDate" name="submission_date" required>
                        <div class="form-text">Date when this action is recorded/submitted.</div>
                    </div>

                    <div class="mb-3" id="noticePeriodGroup" style="display: none;">
                        <label for="noticePeriod" class="form-label">Notice Period (Days) <span
                                class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="noticePeriod" name="notice_period_days" min="0"
                            placeholder="e.g. 30">
                        <div class="form-text">Used to calculate the Last Working Day.</div>
                    </div>

                    <div class="mb-3">
                        <label for="exitNote" class="form-label">Exit Reason/Note <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="exitNote" name="exit_note" rows="4"
                            placeholder="Provide detailed reason for exit..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Submit Action</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

{{ map_data|json_script:"map-data-initial" }}

<script>
    let map;
    let markersLayer;
    let pathLayer;

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Map
        map = L.map('activityMap').setView([20.5937, 78.9629], 5); // Default Center

        // Google Layers
        const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Maps'
        });

        const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Maps'
        });

        // OSM Layer (optional)
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        });

        // Add Google Streets by default (like Keka)
        googleStreets.addTo(map);

        // Layer Control
        const baseMaps = {
            "Google Streets": googleStreets,
            "Satellite": googleHybrid,
            "OpenStreetMap": osm
        };
        L.control.layers(baseMaps).addTo(map);

        markersLayer = L.layerGroup().addTo(map);
        pathLayer = L.layerGroup().addTo(map);

        // Load initial data if available
        const initialData = JSON.parse(document.getElementById('map-data-initial').textContent);
        if (initialData && initialData.length > 0) {
            drawMap(initialData);
        } else {
            setTimeout(() => { map.invalidateSize(); }, 200);
        }

        // Event delegation for view map buttons
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.view-map-btn');
            if (btn) {
                const id = btn.dataset.attendanceId;
                const date = btn.dataset.date;
                console.log("Button Clicked:", id, date);
                if (id) viewMap(id, date);
            }
        });
    });

    function drawMap(mapData) {
        console.log('=== drawMap called ===');
        console.log('mapData:', mapData);
        console.log('mapData type:', typeof mapData);
        console.log('mapData length:', mapData ? mapData.length : 'null/undefined');

        // Parse if string (sometimes Django sends JSON as string)
        if (typeof mapData === 'string') {
            console.log('mapData is a string, parsing JSON...');
            try {
                mapData = JSON.parse(mapData);
                console.log('Successfully parsed mapData:', mapData);
            } catch (e) {
                console.error('Failed to parse mapData:', e);
                alert('Error parsing location data');
                return;
            }
        }

        // Ensure map handles container size updates
        map.invalidateSize();

        // Clear existing
        markersLayer.clearLayers();
        pathLayer.clearLayers();

        if (!mapData || mapData.length === 0) {
            console.error('No location data - mapData is empty or null');
            alert("No location data available for this record.");
            return;
        }

        console.log(`Processing ${mapData.length} location points...`);
        const latlngs = [];


        // Create custom icons for different marker types - LARGE and VISIBLE like Keka
        const createCustomIcon = (color, iconClass, size = 40) => {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <i class="${iconClass}" style="color: white; font-size: ${size / 2.5}px;"></i>
                </div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
                popupAnchor: [0, -size / 2]
            });
        };

        mapData.forEach((point, index) => {
            latlngs.push([point.lat, point.lng]);

            // Custom Icon based on type - LARGER markers for better visibility
            let icon;
            let markerColor;

            if (point.type === 'start') {
                icon = createCustomIcon('#10b981', 'fas fa-play', 50); // Larger for start - 50px
                markerColor = '#10b981';
            } else if (point.type === 'end') {
                icon = createCustomIcon('#ef4444', 'fas fa-stop', 50); // Larger for end - 50px
                markerColor = '#ef4444';
            } else {
                icon = createCustomIcon('#3b82f6', 'fas fa-circle', 40); // Tracking points - 40px
                markerColor = '#3b82f6';
            }

            // Create marker with custom icon
            const marker = L.marker([point.lat, point.lng], { icon: icon })
                .addTo(markersLayer)
                .bindPopup(`
                    <div class="text-center" style="min-width: 220px; padding: 10px;">
                        <strong style="color: ${markerColor}; font-size: 18px; display: block; margin-bottom: 8px;">${point.type_display || point.title}</strong>
                        <div class="my-2" style="font-size: 15px; color: #333;"><i class="far fa-clock me-2"></i> ${point.time_display || ''}</div>
                        <small class="text-muted" style="font-size: 12px;"><i class="fas fa-map-marker-alt me-1"></i> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</small>
                    </div>
                `);

            // Auto-open popup for start marker only
            if (point.type === 'start') {
                setTimeout(() => marker.openPopup(), 600);
            }
        });

        // Draw Path Line - Make it more visible
        if (latlngs.length > 1) {
            L.polyline(latlngs, {
                color: '#2563eb',  // Brighter blue
                weight: 5,         // Thicker line
                opacity: 0.9,      // More opaque
                smoothFactor: 1
            }).addTo(pathLayer);

            setTimeout(() => {
                map.invalidateSize();
                map.fitBounds(latlngs, { padding: [50, 50], maxZoom: 16 });
            }, 100);
        } else if (latlngs.length === 1) {
            setTimeout(() => {
                map.invalidateSize();
                map.setView(latlngs[0], 16);
            }, 100);
        }
    }

    function viewMap(attendanceId, dateStr) {
        console.log(`viewMap called for ID: ${attendanceId}, Date: ${dateStr}`);

        // Update Card Header
        const headerSmall = document.querySelector('.card-header small');
        if (headerSmall) headerSmall.textContent = `Tracking for ${dateStr}`;

        // Show Loading
        const mapContainer = document.getElementById('activityMap');
        // Don't fully destroy map, just show an overlay or ensure we don't break it
        // Simpler: just log for now

        // Fetch Data
        console.log(`Fetching: /employees/api/attendance/${attendanceId}/map-data/`);
        fetch(`/employees/api/attendance/${attendanceId}/map-data/`)
            .then(response => {
                console.log('Response Status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Map Data received:', data);
                if (data.status === 'success') {
                    drawMap(data.data);
                } else {
                    console.error('API Error:', data.message);
                    alert(data.message || 'Error fetching map data');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert(`Failed to load map data: ${error.message}`);
            });
    }


</script>

<script>
    // Exit Management Functions (Global scope for inline onclick handlers)
    let currentExitType = '';

    function openExitModal(exitType) {
        currentExitType = exitType;
        document.getElementById('exitType').value = exitType;

        // Reset form
        document.getElementById('exitForm').reset();
        document.getElementById('exitType').value = exitType; // Re-set after reset

        // Update modal title and UI based on type
        const modalTitle = document.getElementById('exitModalLabel');
        const dateLabel = document.getElementById('dateLabel');
        const noticeGroup = document.getElementById('noticePeriodGroup');
        const noticeInput = document.getElementById('noticePeriod');

        if (exitType === 'RESIGNATION') {
            modalTitle.textContent = "Initiate Resignation";
            dateLabel.innerHTML = 'Resignation Submission Date <span class="text-danger">*</span>';
            noticeGroup.style.display = 'none';
            noticeInput.removeAttribute('required');
        } else {
            // TERMINATED or ABSCONDED
            modalTitle.textContent = `Mark as ${exitType.charAt(0) + exitType.slice(1).toLowerCase()}`;
            dateLabel.innerHTML = 'Action Date <span class="text-danger">*</span>';
            noticeGroup.style.display = 'block';
            noticeInput.setAttribute('required', 'required');
        }

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('exitModal'));
        modal.show();
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function () {
        const exitForm = document.getElementById('exitForm');
        if (exitForm) {
            exitForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const employeeId = "{{ employee.pk }}";

                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                fetch(`/employees/${employeeId}/exit-action/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Close modal
                            const modalEl = document.getElementById('exitModal');
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();

                            // Show success message
                            alert(data.message);

                            // Redirect to employee list
                            window.location.href = data.redirect_url;
                        } else {
                            alert('Error: ' + data.message);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing the exit action.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
            });
        }
    });</script>
{% endblock %}