{% extends 'core/base.html' %} {# valid #}
{% load static %}

{% block title %}My Home | HRMS{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-color: #6366f1;
        /* Indigo */
        --primary-light: #e0e7ff;
        --secondary-color: #64748b;
        /* Slate */
        --success-color: #10b981;
        /* Emerald */
        --warning-color: #f59e0b;
        /* Amber */
        --danger-color: #ef4444;
        /* Red */
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --border-radius: 16px;
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
        font-family: 'Outfit', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
    }

    /* --- CARDS --- */
    .keka-card {
        background: var(--card-bg);
        border-radius: 20px;
        /* Match Shift Card */
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        overflow: hidden;
        position: relative;
    }

    .keka-card:hover {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: translateY(-4px);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .card-header-clean {
        padding: 24px 24px 15px;
        border-bottom: 1px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: transparent;
    }

    .card-title-text {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .card-icon-soft {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .keka-card:hover .card-icon-soft.primary {
        background: var(--primary-light);
        color: var(--primary-color);
    }

    .keka-card:hover .card-icon-soft.warning {
        background: #fef3c7;
        color: var(--warning-color);
    }

    .keka-card:hover .card-icon-soft.danger {
        background: #fee2e2;
        color: var(--danger-color);
    }

    .card-body-clean {
        padding: 24px;
    }

    /* --- TYPOGRAPHY --- */
    .text-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .text-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--text-main);
        line-height: 1.2;
    }

    /* --- CLOCK WIDGET --- */
    .clock-widget {
        text-align: center;
        padding: 10px 0;
    }

    .digital-clock {
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -2px;
        line-height: 1;
        margin-bottom: 5px;
        font-variant-numeric: tabular-nums;
    }

    .current-date {
        font-size: 0.95rem;
        color: #64748b;
        font-weight: 500;
        margin-bottom: 30px;
        background: #f1f5f9;
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
    }

    .btn-clock {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-radius: 16px;
        font-weight: 700;
        border: none;
        width: 100%;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        margin-bottom: 12px;
        text-align: left;
        overflow: hidden;
        /* For sheen effect */
    }

    .btn-clock::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: 0.5s;
    }

    .btn-clock:hover::after {
        left: 100%;
        transition: 0.5s ease-in-out;
    }

    .btn-clock:active {
        transform: scale(0.98);
    }

    .btn-clock-in-office {
        background: #ecfdf5;
        color: #047857;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .btn-clock-in-office:hover {
        background: #10b981;
        color: white;
        box-shadow: 0 8px 20px -4px rgba(16, 185, 129, 0.4);
        border-color: #10b981;
    }

    .btn-clock-in-remote {
        background: #f5f3ff;
        color: #7c3aed;
        border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .btn-clock-in-remote:hover {
        background: #8b5cf6;
        color: white;
        box-shadow: 0 8px 20px -4px rgba(139, 92, 246, 0.4);
        border-color: #8b5cf6;
    }

    .btn-clock-out {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        justify-content: center;
    }

    .btn-clock-out:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(220, 38, 38, 0.4);
    }

    .btn-icon-wrapper {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    /* --- STATS CIRCLES --- */
    .stat-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 15px;
    }

    .stat-ring svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }

    .stat-ring circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
    }

    .stat-ring .bg {
        stroke: #f1f5f9;
    }

    .stat-ring .progress {
        stroke: var(--primary-color);
        stroke-dasharray: 283;
        /* 2 * PI * 45 */
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 1s ease;
    }

    .stat-ring-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .stat-ring-value {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-main);
    }

    .stat-ring-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    /* --- TIMELINE / SHIFT --- */
    .shift-timeline {
        display: flex;
        justify-content: space-between;
        position: relative;
        padding-top: 10px;
    }

    .shift-timeline::before {
        content: '';
        position: absolute;
        top: 24px;
        left: 20px;
        right: 20px;
        height: 4px;
        background: #f1f5f9;
        z-index: 1;
        border-radius: 4px;
    }

    .timeline-point {
        position: relative;
        z-index: 2;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .timeline-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #cbd5e1;
        border: 3px solid #fff;
        box-shadow: 0 0 0 1px #e2e8f0;
        margin-top: 10px;
        margin-bottom: 8px;
    }

    .timeline-point.active .timeline-dot {
        background: var(--success-color);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .timeline-time {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-main);
    }

    .timeline-label {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* --- WEEK DAYS --- */
    .week-days {
        display: flex;
        justify-content: space-between;
        gap: 5px;
        background: #f8fafc;
        padding: 10px;
        border-radius: 12px;
    }

    .day-badge {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: #94a3b8;
        background: white;
        border: 1px solid #e2e8f0;
    }

    .day-badge.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);
    }

    /* --- CELEBRATIONS --- */
    .celebration-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 12px;
        background: #fff;
        border: 1px solid #f1f5f9;
        margin-bottom: 10px;
        transition: transform 0.2s;
    }

    .celebration-item:hover {
        transform: translateX(5px);
        border-color: #e2e8f0;
    }

    .celebration-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        color: #db2777;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 12px;
        font-size: 1rem;
    }

    .celebration-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        color: #db2777;
        margin-left: auto;
    }

    /* --- TABLE --- */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .table-custom th {
        background: #f8fafc;
        padding: 16px 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        border-top: 1px solid #e2e8f0;
        border-bottom: 1px solid #e2e8f0;
        letter-spacing: 0.05em;
    }

    .table-custom th:first-child {
        border-top-left-radius: 12px;
        border-left: 1px solid #e2e8f0;
    }

    .table-custom th:last-child {
        border-top-right-radius: 12px;
        border-right: 1px solid #e2e8f0;
    }

    .table-custom td {
        padding: 16px 20px;
        font-size: 0.9rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        background: white;
        transition: background 0.2s;
    }

    .table-custom tr:last-child td {
        border-bottom: none;
    }

    .table-custom tr:last-child td:first-child {
        border-bottom-left-radius: 12px;
    }

    .table-custom tr:last-child td:last-child {
        border-bottom-right-radius: 12px;
    }

    .table-custom tr:hover td {
        background: #f8fafc;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-present {
        background: #dcfce7;
        color: #166534;
    }

    .status-absent {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-half {
        background: #ffedd5;
        color: #9a3412;
    }

    /* Overlay */
    #celebration-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    /* Anim */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-enter {
        animation: slideInUp 0.5s ease-out forwards;
    }

    .delay-100 {
        animation-delay: 0.1s;
    }

    .delay-200 {
        animation-delay: 0.2s;
    }

    .delay-300 {
        animation-delay: 0.3s;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Active Day Pulse */
    .day-badge.active {
        animation: pulse-soft 2s infinite;
    }

    @keyframes pulse-soft {
        0% {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
        }

        70% {
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden Data Context for JS -->
<div id="page-context" data-csrf="{{ csrf_token }}" data-clock-in="{{ attendance.clock_in|date:'Y-m-d H:i:s' }}"
    data-avg-hours="{{ avg_hours|default:'00:00' }}" style="display:none;"></div>
<div class="container-fluid py-4 px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-end mb-5 animate-enter">
        <div>
            <h4 class="fw-bold mb-1"
                style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block;">
                <span id="dynamic-greeting">Good Morning</span>, {{ request.user.first_name }}! &#128075;
            </h4>
            <p class="text-muted mb-0">Here's what's happening today.</p>
        </div>
        <div class="text-end d-none d-md-block">
            <div id="header-date" class="fw-bold text-dark fs-5"></div>
        </div>
    </div>

    <!-- Top Stats Row (Mobile Only sort of, but useful for overview) -->
    <!-- Grid Layout -->
    <div class="row g-4">

        <!-- Left Column: Primary Actions & Stats -->
        <div class="col-lg-3">
            <div class="vstack gap-4">

                <!-- Clock In/Out Card -->
                <div class="keka-card animate-enter delay-100">
                    <div class="card-body-clean text-center">
                        <div class="mb-4">
                            <div class="text-label mb-2">Current Time</div>
                            <div id="clock" class="digital-clock">--:--</div>
                            <div id="date-sub" class="current-date">-- -- ----</div>
                        </div>

                        {% if attendance and attendance.is_currently_clocked_in %}
                        <!-- Clocked In State -->
                        <div class="p-3 bg-light rounded-3 mb-4 border">
                            <div class="text-label mb-1">Current Session</div>
                            <div class="fs-4 fw-bold text-dark">
                                Active
                                <span class="badge bg-primary ms-2">
                                    {{ attendance.current_session_type|default:"WEB" }}
                                </span>
                            </div>

                            {% if attendance.clock_in %}
                            <div class="text-muted small mt-1">Started at {{
                                attendance.get_current_session.clock_in|default:attendance.clock_in|time:"h:i A" }}
                            </div>
                            {% endif %}

                            <hr class="my-3 text-muted opacity-25">

                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-label" style="font-size: 0.65rem;">Session Duration</div>
                                    <div class="fw-bold text-dark timer-count" id="timer-display">00:00:00</div>
                                </div>
                                <div class="text-end">
                                    <div class="text-label" style="font-size: 0.65rem;">Total Today</div>
                                    <div class="fw-bold text-primary">
                                        {{ attendance.total_working_hours|floatformat:1 }} hr
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="btn-clock btn-clock-out" onclick="handleClockAction('out', null, this)">
                            <span class="btn-icon-wrapper"><i class="fas fa-sign-out-alt"></i></span>
                            Clock Out
                        </button>

                        {% else %}
                        <!-- Clocked Out State -->
                        {% if attendance and attendance.daily_sessions_count > 0 %}
                        <div class="p-3 bg-info bg-opacity-10 rounded-3 mb-4 border border-info">
                            <div class="text-label mb-1">Today's Progress</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">
                                        {{ attendance.total_working_hours|floatformat:1 }} hours
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="status-badge status-{{ attendance.status|lower }}">
                                        {{ attendance.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-3">
                            {% if not attendance or attendance.daily_sessions_count < attendance.max_daily_sessions %}
                                <button class="btn-clock btn-clock-in-office"
                                onclick="handleClockAction('in', 'office', this)">
                                <span class="btn-icon-wrapper"><i class="fas fa-building"></i></span>
                                Web Clock-In
                                </button>
                                <button class="btn-clock btn-clock-in-remote"
                                    onclick="handleClockAction('in', 'remote', this)">
                                    <span class="btn-icon-wrapper"><i class="fas fa-laptop-house"></i></span>
                                    Remote Clock-In
                                </button>
                                {% else %}
                                <!-- Max sessions limit reached (Hidden from UI as per request) -->
                                <div class="text-muted text-center small mt-2">
                                    All sessions completed for today.
                                </div>
                                {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Weekly Summary Mini Stats -->
                <div class="keka-card animate-enter delay-200">
                    <div class="card-header-clean">
                        <span class="card-title-text">
                            <span class="card-icon-soft primary"><i class="fas fa-chart-pie"></i></span>
                            Weekly Stats
                        </span>
                    </div>
                    <div class="card-body-clean pt-0">
                        <div class="row text-center align-items-center">
                            <div class="col-6 border-end">
                                <div class="stat-ring">
                                    <svg>
                                        <circle class="bg" cx="60" cy="60" r="45"></circle>
                                        <circle class="progress" cx="60" cy="60" r="45" id="avg-progress"></circle>
                                    </svg>
                                    <div class="stat-ring-content">
                                        <div class="stat-ring-value">{{ avg_hours|default:"00:00" }}</div>
                                        <div class="stat-ring-label">Avg Hrs</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 d-flex flex-column justify-content-center gap-3">
                                <div>
                                    <div class="text-value text-success" style="font-size: 1.4rem;">100%</div>
                                    <div class="text-label">On Time</div>
                                </div>
                                <div>
                                    <div class="text-value text-primary" style="font-size: 1.4rem;">0</div>
                                    <div class="text-label">Leaves</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Middle Column: Shift & Activity -->
        <div class="col-lg-6">
            <div class="vstack gap-4">

                <style>
                    /* --- ANIMATED SHIFT CARD --- */
                    .shift-card {
                        background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
                        border-radius: 24px;
                        color: white;
                        position: relative;
                        overflow: hidden;
                        box-shadow: 0 20px 40px -10px rgba(79, 70, 229, 0.4);
                        border: 1px solid rgba(255, 255, 255, 0.15);
                        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    }

                    .shift-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 30px 60px -12px rgba(79, 70, 229, 0.5);
                    }

                    .shift-header {
                        position: relative;
                        z-index: 2;
                        padding: 30px 30px 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .shift-icon-box {
                        width: 56px;
                        height: 56px;
                        border-radius: 18px;
                        background: rgba(255, 255, 255, 0.15);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        backdrop-filter: blur(12px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.5rem;
                        margin-right: 20px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                    }

                    .shift-badge {
                        background: #ffffff;
                        color: #4f46e5;
                        font-weight: 700;
                        padding: 10px 24px;
                        border-radius: 50px;
                        font-size: 0.8rem;
                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
                        text-transform: uppercase;
                        letter-spacing: 0.1em;
                    }

                    .timeline-container {
                        position: relative;
                        z-index: 2;
                        padding: 80px 40px 60px;
                    }

                    .timeline-track {
                        position: absolute;
                        top: 110px;
                        left: 40px;
                        right: 40px;
                        height: 4px;
                        background: rgba(255, 255, 255, 0.15);
                        border-radius: 10px;
                    }

                    .timeline-progress-bar {
                        position: absolute;
                        top: 0;
                        left: 0;
                        height: 100%;
                        background: linear-gradient(90deg, #10b981, #34d399);
                        border-radius: 10px;
                        width: 0%;
                        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
                    }

                    .timeline-handle {
                        position: absolute;
                        right: -10px;
                        /* Center circle on progress end */
                        top: 50%;
                        transform: translateY(-50%);
                        width: 20px;
                        height: 20px;
                        background: white;
                        border-radius: 50%;
                        box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
                        z-index: 100;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }

                    .timeline-handle::after {
                        content: '';
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        background: rgba(255, 255, 255, 0.4);
                        border-radius: 50%;
                        animation: pulse-white 2s infinite;
                    }

                    @keyframes pulse-white {
                        0% {
                            transform: scale(1);
                            opacity: 0.8;
                        }

                        100% {
                            transform: scale(2.5);
                            opacity: 0;
                        }
                    }

                    .timeline-time-badge {
                        position: absolute;
                        bottom: 25px;
                        background: transparent;
                        color: white;
                        font-weight: 800;
                        font-size: 1.1rem;
                        white-space: nowrap;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    }

                    .timeline-nodes {
                        position: absolute;
                        top: 110px;
                        left: 40px;
                        right: 40px;
                        height: 0;
                        pointer-events: none;
                    }

                    .t-node {
                        position: absolute;
                        top: 0;
                        transform: translate(-50%, -50%);
                        /* Correctly centers the dot on the point */
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        transition: transform 0.3s ease;
                        cursor: default;
                    }

                    .t-node:hover {
                        transform: translateX(-50%) translateY(-5px) !important;
                        /* Keep the X transform but lift up */
                        z-index: 10;
                        pointer-events: auto;
                    }

                    .t-time {
                        position: absolute;
                        bottom: 18px;
                        /* Time above dot */
                        font-weight: 700;
                        font-size: 0.9rem;
                        margin-bottom: 14px;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        color: white;
                    }

                    .t-dot {
                        width: 18px;
                        height: 18px;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.2);
                        border: 2px solid rgba(255, 255, 255, 0.6);
                        margin-bottom: 10px;
                        position: relative;
                        transition: all 0.3s ease;
                    }

                    .t-node:hover .t-dot {
                        background: rgba(255, 255, 255, 1);
                        box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
                    }

                    .t-dot.green {
                        background: #10b981;
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.3);
                    }

                    .t-dot.web {
                        background: #3b82f6;
                        /* Blue for web clock-in */
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
                    }

                    .t-dot.remote {
                        background: #8b5cf6;
                        /* Purple for remote clock-in */
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3);
                    }

                    .t-dot.logout {
                        background: #ef4444;
                        /* Red for logout */
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
                    }

                    .t-label {
                        font-size: 0.75rem;
                        font-weight: 600;
                        opacity: 0.9;
                        letter-spacing: 0.03em;
                        background: rgba(0, 0, 0, 0.15);
                        padding: 2px 8px;
                        border-radius: 4px;
                    }

                    .shift-footer {
                        background: rgba(0, 0, 0, 0.08);
                        padding: 18px 30px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-top: 1px solid rgba(255, 255, 255, 0.1);
                        position: relative;
                        z-index: 2;
                    }
                </style>


                <div class="shift-card animate-enter delay-100 mb-4">
                    <div class="shift-header">
                        <div class="d-flex align-items-center">
                            <div class="shift-icon-box">
                                <i class="far fa-clock"></i>
                            </div>
                            <div>
                                <h3 class="mb-1 fw-bold text-white">
                                    {% if assigned_shift %}{{ assigned_shift.name }}{% else %}General Shift{% endif %}
                                </h3>
                                <div class="opacity-75 fw-medium" style="font-size: 1.1rem; letter-spacing: 0.02em;">
                                    {% if assigned_shift %}
                                    {{ assigned_shift.start_time|time:"h:i A" }} - {{ assigned_shift.end_time|time:"h:i
                                    A" }}
                                    {% else %}
                                    09:00 AM - 06:00 PM
                                    {% endif %}
                                </div>
                            </div>

                        </div>
                        <div class="shift-badge">{% if assigned_shift %}Active{% else %}Default{% endif %}</div>
                    </div>

                    <div class="d-flex justify-content-around align-items-center px-4 py-5">
                        <!-- Clock In Block -->
                        <div class="text-center">
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center bg-white bg-opacity-20 rounded-circle"
                                    style="width: 50px; height: 50px;">
                                    <i class="fas fa-sign-in-alt text-white fs-4"></i>
                                </div>
                            </div>
                            <div class="text-white opacity-75 small text-uppercase fw-bold mb-1">Clock In
                            </div>
                            <div class="fs-2 fw-bold text-white mb-0" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                {% if attendance and attendance.clock_in %}
                                {{ attendance.clock_in|time:"h:i A" }}
                                {% else %}
                                --:--
                                {% endif %}
                            </div>
                        </div>

                        <!-- Divider Line (Vertical) -->
                        <div style="width: 1px; height: 60px; background: rgba(255,255,255,0.2);"></div>

                        <!-- Clock Out Block -->
                        <div class="text-center">
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center bg-white bg-opacity-20 rounded-circle"
                                    style="width: 50px; height: 50px;">
                                    <i class="fas fa-sign-out-alt text-white fs-4"></i>
                                </div>
                            </div>
                            <div class="text-white opacity-75 small text-uppercase fw-bold mb-1">Clock Out
                            </div>
                            <div class="fs-2 fw-bold text-white mb-0" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                {% if attendance and attendance.clock_out and not
                                attendance.is_currently_clocked_in %}
                                {{ attendance.clock_out|time:"h:i A" }}
                                {% else %}
                                --:--
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if assigned_shift %}
                    <div class="shift-footer">
                        <!-- Break Information Section -->
                        <div>
                            <div class="small fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                                BREAKS</div>
                            {% if assigned_shift.breaks.all %}
                            {% for break_item in assigned_shift.breaks.all %}
                            <div class="fw-bold text-white" style="font-size: 0.85rem;">
                                {{ break_item.name }}: {{ break_item.start_time|time:"H:i" }} - {{
                                break_item.end_time|time:"H:i" }}
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="fw-bold text-white opacity-75" style="font-size: 0.85rem;">No breaks
                                configured
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <div class="small fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                                STATUS</div>
                            <div class="fw-bold text-success">Active</div>

                            <!-- Color Legend -->
                            <div class="mt-2" style="font-size: 0.6rem;">
                                <div class="d-flex align-items-center justify-content-end mb-1">
                                    <div
                                        style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; margin-right: 4px;">
                                    </div>
                                    <span class="opacity-75">Web</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-end mb-1">
                                    <div
                                        style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%; margin-right: 4px;">
                                    </div>
                                    <span class="opacity-75">Remote</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-end">
                                    <div
                                        style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 4px;">
                                    </div>
                                    <span class="opacity-75">Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="shift-footer">
                        <!-- Default Break Information -->
                        <div>
                            <div class="small fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                                BREAKS</div>
                            <div class="fw-bold text-white opacity-75" style="font-size: 0.85rem;">
                                Refreshment: 10:45 - 11:00<br>
                                Lunch Break: 13:00 - 13:45<br>
                                Evening Tea: 16:30 - 16:45
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="small fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                                STATUS</div>
                            <div class="fw-bold text-muted">Default</div>

                            <!-- Color Legend -->
                            <div class="mt-2" style="font-size: 0.6rem;">
                                <div class="d-flex align-items-center justify-content-end mb-1">
                                    <div
                                        style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; margin-right: 4px;">
                                    </div>
                                    <span class="opacity-75">Web</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-end mb-1">
                                    <div
                                        style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%; margin-right: 4px;">
                                    </div>
                                    <span class="opacity-75">Remote</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-end">
                                    <div
                                        style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 4px;">
                                    </div>
                                    <span class="opacity-75">Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Recent Activity Table -->
                <div class="keka-card animate-enter delay-200">
                    <div class="card-header-clean">
                        <span class="card-title-text"><i class="fas fa-list text-muted"></i> Attendance
                            Log</span>
                        <a href="{% url 'attendance_report' %}"
                            class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3">View All</a>
                    </div>
                    <div class="card-body-clean p-0">
                        <div class="table-responsive">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Check In</th>
                                        <th>Check Out</th>
                                        <th>Hours</th>
                                        <th>Status</th>
                                        <th>Map</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for att in attendance_history|slice:":5" %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-dark">{{ att.date|date:"d M" }}</div>
                                            <div class="small text-muted">{{ att.date|date:"D" }}</div>
                                        </td>
                                        <td>
                                            {% if att.clock_in %}
                                            <div class="fw-bold text-dark">{{ att.clock_in|time:"h:i A" }}
                                            </div>
                                            {% else %}<span class="text-muted">-</span>{% endif %}
                                        </td>
                                        <td>
                                            {% if att.clock_out %}
                                            <div class="fw-bold text-dark">{{ att.clock_out|time:"h:i A" }}
                                            </div>
                                            {% else %}<span class="text-muted">-</span>{% endif %}
                                        </td>
                                        <td>
                                            <div class="fw-bold text-secondary">{{
                                                att.effective_hours|default:"-" }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if att.status == 'Absent' %}
                                            <span class="status-badge status-absent">Absent</span>
                                            {% else %}
                                            <span class="status-badge status-present">Present</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if att.location_in or att.location_out %}
                                            <a href="{% url 'attendance_map' att.id %}"
                                                class="btn btn-sm btn-light text-primary rounded-circle"
                                                style="width:32px;height:32px; display:flex;align-items:center;justify-content:center;"><i
                                                    class="fas fa-map-marker-alt"></i></a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">No records
                                            found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Right Column: Info & Widgets -->
        <div class="col-lg-3">
            <div class="vstack gap-4">

                <!-- Working Days (Calendar visual) -->
                <div class="keka-card animate-enter delay-100">
                    <div class="card-body-clean">
                        <div class="text-label mb-3">This Week</div>
                        <div class="week-days">
                            <div class="day-badge">S</div>
                            <div class="day-badge active">M</div>
                            <div class="day-badge active">T</div>
                            <div class="day-badge active">W</div>
                            <div class="day-badge active">T</div>
                            <div class="day-badge active">F</div>
                            <div class="day-badge">S</div>
                        </div>
                    </div>
                </div>

                <!-- Announcements -->
                <div class="keka-card animate-enter delay-200">
                    <div class="card-header-clean">
                        <span class="card-title-text">
                            <span class="card-icon-soft warning"><i class="fas fa-bullhorn"></i></span>
                            Announcements
                        </span>
                    </div>
                    <div class="card-body-clean p-0">
                        {% if announcements %}
                        <div class="list-group list-group-flush">
                            {% for ann in announcements %}
                            <div class="list-group-item border-0 p-3 bg-transparent">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill"
                                        style="font-size: 0.65rem;">New</span>
                                    <small class="text-muted" style="font-size: 0.7rem;">
                                        {{ ann.created_at|date:"M d" }}
                                    </small>
                                </div>
                                <div class="fw-bold text-dark small mb-1">{{ ann.title }}</div>
                                <div class="text-muted small text-truncate">{{ ann.content }}</div>
                            </div>
                            {% endfor %}

                            <!-- Today's Celebrations Widget -->
                            <div class="keka-card animate-enter delay-150">
                                <div class="p-3"
                                    style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="m-0 text-white fw-bold"><i class="fas fa-calendar-star me-2"></i>
                                            Today's
                                            Celebrations</h6>
                                        <span class="badge bg-white text-dark">{{ today|date:"d M" }}</span>
                                    </div>
                                </div>

                                <div class="p-0">
                                    <div class="list-group list-group-flush">
                                        <!-- Today's Birthdays -->
                                        {% if todays_birthdays %}
                                        {% for emp in todays_birthdays %}
                                        <div class="list-group-item p-3 border-0 border-bottom">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0"
                                                    style="width: 40px; height: 40px; background: #fce7f3; color: #db2777; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                                    {% if emp.profile_picture %}
                                                    <img src="{{ emp.profile_picture.url }}"
                                                        alt="{{ emp.user.get_full_name }}"
                                                        style="width: 100%; height: 100%; object-fit: cover;">
                                                    {% else %}
                                                    <i class="fas fa-birthday-cake" style="font-size: 1rem;"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <h6 class="mb-0 fw-bold text-dark">{{
                                                        emp.user.get_full_name }}</h6>
                                                    <div class="text-muted small">Happy Birthday! 🎂</div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endif %}

                                        <!-- Today's Work Anniversaries -->
                                        {% if todays_anniversaries %}
                                        {% for emp in todays_anniversaries %}
                                        <div class="list-group-item p-3 border-0 border-bottom">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0"
                                                    style="width: 40px; height: 40px; background: #fffbeb; color: #d97706; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                                    {% if emp.profile_picture %}
                                                    <img src="{{ emp.profile_picture.url }}"
                                                        alt="{{ emp.user.get_full_name }}"
                                                        style="width: 100%; height: 100%; object-fit: cover;">
                                                    {% else %}
                                                    <i class="fas fa-medal" style="font-size: 1rem;"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <h6 class="mb-0 fw-bold text-dark">{{
                                                        emp.user.get_full_name }}</h6>
                                                    <div class="text-muted small">
                                                        {% with years=emp.date_of_joining|timesince %}
                                                        Work Anniversary 🌟
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endif %}

                                        {% if not todays_birthdays and not todays_anniversaries %}
                                        <div class="text-center py-4 text-muted small">
                                            No celebrations today
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Removed Holidays and Celebrations blocks as per request -->

                        </div>
                    </div>

                </div>

                {% if is_birthday or is_work_anniversary %}
                <!-- Overlay -->
                <div id="celebration-overlay">
                    <div class="text-center p-5 bg-white rounded-4 shadow-lg animate-enter" style="max-width: 500px;">
                        <div class="display-1 mb-3">&#127881;</div>
                        <h2 class="fw-bold text-primary mb-2">
                            {% if is_birthday %}Happy Birthday!{% elif is_work_anniversary %}Happy
                            Anniversary!{% endif %}
                        </h2>
                        <h4 class="fw-bold text-dark mb-4">{{ request.user.first_name }}</h4>
                        <p class="text-muted mb-4">Wishing you a fantastic day filled with joy and success!
                        </p>
                        <button class="btn btn-primary rounded-pill px-5 fw-bold"
                            onclick="document.getElementById('celebration-overlay').style.display='none'">Thank
                            You!</button>
                    </div>
                </div>
                {% endif %}
                <!-- Early Clock Out Confirmation Modal -->
                <div class="modal fade" id="clockOutConfirmModal" tabindex="-1" aria-hidden="true"
                    data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                            <div class="modal-header bg-warning bg-opacity-10 border-0 pt-4 px-4 pb-0">
                                <h5 class="modal-title fw-bold text-warning d-flex align-items-center gap-2">
                                    <i class="fas fa-exclamation-triangle"></i> Early Departure
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="mb-2">
                                        <span class="display-6 fw-bold text-dark" id="modal-remaining-hours">--</span>
                                        <span class="text-muted">hrs remaining</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success rounded-pill" role="progressbar"
                                            style="width: 0%" id="modal-progress-bar"></div>
                                    </div>
                                    <div class="d-flex justify-content-between small text-muted mt-1">
                                        <span id="modal-worked-hours">0h worked</span>
                                        <span id="modal-expected-hours">9h goal</span>
                                    </div>
                                </div>
                                <p class="text-muted text-center mb-0">
                                    You have not completed your full shift yet. Are you sure you want to
                                    clock out now?
                                </p>
                            </div>
                            <div class="modal-footer border-0 justify-content-center pb-4 bg-light">
                                <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-medium"
                                    data-bs-dismiss="modal" id="btn-cancel-clockout">Cancel</button>
                                <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold shadow-sm"
                                    id="btn-confirm-clockout">
                                    Yes, Clock Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}

            {% block extra_js %}
            <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
            <script>
                // Clock
                function updateClock() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    const dateString = now.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });

                    document.getElementById('clock').innerText = timeString;
                    document.getElementById('date-sub').innerText = dateString;

                    // Header Date
                    const headerDate = document.getElementById('header-date');
                    if (headerDate) headerDate.innerText = dateString;

                    // Update dynamic greeting based on time
                    updateGreeting(now);
                }

                // Dynamic Greeting based on time of day
                function updateGreeting(now) {
                    const hour = now.getHours();
                    const greetingElement = document.getElementById('dynamic-greeting');

                    if (!greetingElement) return;

                    let greeting;
                    if (hour >= 5 && hour < 12) {
                        greeting = 'Good Morning';
                    } else if (hour >= 12 && hour < 17) {
                        greeting = 'Good Afternoon';
                    } else if (hour >= 17 && hour < 21) {
                        greeting = 'Good Evening';
                    } else {
                        greeting = 'Good Night';
                    }

                    greetingElement.textContent = greeting;
                }

                setInterval(updateClock, 1000);
                updateClock();

                // Stats Ring Animation
                setTimeout(() => {
                    // Mock calculation for circle progress (Max 8hrs = 100%)
                    // stroke-dashoffset = 283 - (283 * percent / 100)
                    const dataEl = document.getElementById('page-context');
                    const avgHours = dataEl?.dataset.avgHours || "00:00"; // "HH:MM"
                    const [h, m] = avgHours.split(':').map(Number);
                    const decimalHours = h + (m / 60);
                    const percent = Math.min((decimalHours / 9) * 100, 100); // 9 hours usually max

                    const circle = document.getElementById('avg-progress');
                    if (circle) {
                        const offset = 283 - (283 * percent / 100);
                        circle.style.strokeDashoffset = offset;
                    }
                }, 500);

                // Active Day Highlight
                const currentDay = new Date().getDay(); // 0 = Sun, 1 = Mon...
                const dayBadges = document.querySelectorAll('.day-badge');
                if (dayBadges[currentDay]) {
                    dayBadges.forEach(b => b.classList.remove('active'));
                    dayBadges[currentDay].classList.add('active');
                }

                // Celebration Overlay
                const isBirthdayRaw = "{{ is_birthday|yesno:'true,false' }}";
                const isWorkAnniversaryRaw = "{{ is_work_anniversary|yesno:'true,false' }}";
                const isBirthday = isBirthdayRaw === "true";
                const isWorkAnniversary = isWorkAnniversaryRaw === "true";

                if (isBirthday || isWorkAnniversary) {
                    setTimeout(() => {
                        const ov = document.getElementById('celebration-overlay');
                        if (ov) {
                            ov.style.display = 'flex';
                            ov.offsetHeight;
                            ov.style.opacity = '1';
                            ov.style.opacity = '1';
                            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                        }
                    }, 1000);
                }

                // Live Timer for clocked in
                {% if attendance.is_currently_clocked_in %}
                const dataEl = document.getElementById('page-context');
                // For timer, we want the CURRENT session start time, not the first clock-in of the day
                // We can rely on the fact that if we are clocked in, there is an active session.
                // However, data-clock-in in context might be the first clock in.
                // Let's rely on a calculated field or the generic attendance.clock_in if it matches.

                // We need to fetch the current session start time and previous duration.
                // Since we handle this in JS, we need these values in the DOM data attributes.
                // See the modification in the HTML above for data attributes.

                const currentSessionStartStr = "{{ attendance.get_current_session.clock_in.isoformat }}";
                const previousHours = parseFloat("{{ attendance.total_working_hours|default:0 }}");

                const clockInTime = new Date(currentSessionStartStr);

                function updateDuration() {
                    if (!clockInTime) return;
                    const now = new Date();
                    const currentSessionDiff = now - clockInTime; // milliseconds

                    if (currentSessionDiff < 0) {
                        const timerEl = document.getElementById('timer-display');
                        if (timerEl) timerEl.innerText = "00:00:00";
                        return;
                    }

                    // Total duration = Previous Sessions (in ms) + Current Session (in ms)
                    const totalMs = (previousHours * 3600 * 1000) + currentSessionDiff;

                    const seconds = Math.floor((totalMs / 1000) % 60);
                    const minutes = Math.floor((totalMs / (1000 * 60)) % 60);
                    const hours = Math.floor((totalMs / (1000 * 60 * 60)));

                    const formatted =
                        String(hours).padStart(2, '0') + ':' +
                        String(minutes).padStart(2, '0') + ':' +
                        String(seconds).padStart(2, '0');

                    const timerEl = document.getElementById('timer-display');
                    if (timerEl) timerEl.innerText = formatted;
                }
                setInterval(updateDuration, 1000);
                updateDuration();
                {% endif %}

                // Clock Actions
                function handleClockAction(action, type, btnElement) {
                    if (!navigator.geolocation) {
                        alert("Geolocation is not supported by your browser. Please use a mobile device with GPS for accurate attendance.");
                        return;
                    }

                    // Get the button that was clicked
                    const btn = btnElement || (event ? event.currentTarget : document.querySelector('.btn-clock'));
                    const origText = btn.innerHTML;

                    // Immediate feedback
                    btn.innerHTML = '<span class="status-text me-2">Locating...</span> <i class="fas fa-satellite-dish fa-spin"></i>';
                    btn.disabled = true;

                    const csrfToken = document.getElementById('page-context')?.dataset.csrf || '';

                    // --- STRICT LOCATION STRATEGY (Keka-like) ---
                    // 1. Force High Accuracy
                    // 2. Reject cached locations (maximumAge: 0)
                    // 3. Continuous watching to let GPS 'settle'
                    // 4. Strict thresholds: Aim for 20m, Reject > 100m

                    let bestPosition = null;
                    let watchId = null;

                    const TARGET_ACCURACY = 100;      // Keka-like: Aim for high precision (100m)
                    const ACCEPTABLE_ACCURACY = 3000; // Fallback: 3km (Desktops)
                    const MAX_WAIT_TIME = 10000;       // increased timeout to 10s to allow slower GPS lock

                    // Clean up function
                    const stopLocationWatch = () => {
                        if (watchId !== null) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                    };

                    const finishLocationSearch = () => {
                        stopLocationWatch();

                        if (!bestPosition) {
                            // If we have NO position after 3s, try one last check or fail
                            // For now, fail but arguably we could retry
                            btn.innerHTML = origText;
                            btn.disabled = false;
                            alert("Could not acquire location signal. Please ensure GPS is enabled.");
                            return;
                        }

                        const acc = bestPosition.coords.accuracy;

                        // STRICT CHECK - REMOVED CONFIRMATION for speed
                        // If acc > ACCEPTABLE_ACCURACY, we just log it but proceed to avoid blocking user

                        // If good enough (or best we have), submit
                        submitClockRequest(bestPosition);
                    };

                    const timeoutId = setTimeout(finishLocationSearch, MAX_WAIT_TIME);

                    const geoOptions = {
                        enableHighAccuracy: true,
                        timeout: 25000,
                        maximumAge: 0
                    };

                    watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const acc = Math.round(pos.coords.accuracy);
                            // Real-time feedback implementation like precise apps
                            // We show lat/long only if accuracy is decent, else just 'Acquiring'
                            // Actually showing Lat/Long gives confidence.
                            const lat = pos.coords.latitude.toFixed(5);
                            const lng = pos.coords.longitude.toFixed(5);

                            console.log(`GPS Update: Accuracy ${acc}m at ${lat},${lng}`);

                            btn.innerHTML = `<div class="d-flex flex-column align-items-center" style="line-height:1.2">
                    <span style="font-size:0.85rem">Accuracy: ${acc}m</span>
                    <span style="font-size:0.7rem; opacity:0.8">${lat}, ${lng}</span>
                </div>`;

                            // Logic to track best position
                            if (!bestPosition || pos.coords.accuracy < bestPosition.coords.accuracy) {
                                bestPosition = pos;
                            }

                            // If we hit target (20m), stop immediately
                            if (pos.coords.accuracy <= TARGET_ACCURACY) {
                                clearTimeout(timeoutId);
                                finishLocationSearch();
                            }
                        },
                        (err) => {
                            console.warn("GPS Error:", err.message);
                            if (err.code === 1) { // PERMISSION_DENIED
                                clearTimeout(timeoutId);
                                stopLocationWatch();
                                btn.innerHTML = origText;
                                btn.disabled = false;
                                alert("Location request denied. Attendance requires location access.");
                            }
                        },
                        geoOptions
                    );

                    function submitClockRequest(pos) {
                        // Update status
                        const acc = Math.round(pos.coords.accuracy);
                        btn.innerHTML = `<span class="status-text me-2">Verifying (${acc}m)...</span> <i class="fas fa-spinner fa-spin"></i>`;

                        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                        const requestData = {
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            accuracy: pos.coords.accuracy, // Send accuracy to server
                            type: type,
                            timezone: userTimezone
                        };

                        const apiUrl = action === 'in' ? "{% url 'api_clock_in' %}" : "{% url 'api_clock_out' %}";

                        fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify(requestData)
                        })
                            .then(r => {
                                if (!r.ok) {
                                    return r.text().then(text => {
                                        console.error("Server Error Detail:", text);
                                        throw new Error(`Server Error: ${r.status} - ${text.substring(0, 150)}...`)
                                    });
                                }
                                return r.json();
                            })
                            .then(data => {
                                if (data.status === 'success') {
                                    // Success Animation
                                    if (typeof confetti === 'function') {
                                        confetti({
                                            particleCount: 150,
                                            spread: 70,
                                            origin: { y: 0.6 },
                                            colors: ['#6366f1', '#10b981', '#f59e0b']
                                        });
                                    }
                                    location.reload();
                                }
                                else if (data.status === 'confirmation_required' || data.requires_confirmation) {
                                    handleConfirmationModal(data, pos, csrfToken, btn, origText);
                                }
                                else if (data.already_clocked_in) {
                                    alert(data.message || 'You are already clocked in.');
                                    btn.innerHTML = origText;
                                    btn.disabled = false;
                                }
                                else {
                                    alert(data.message || 'An error occurred');
                                    btn.innerHTML = origText;
                                    btn.disabled = false;
                                }
                            })
                            .catch((error) => {
                                console.error("Fetch Error:", error);
                                alert("Unable to connect to server: " + error.message);
                                btn.innerHTML = origText;
                                btn.disabled = false;
                            });
                    }

                    // Helper for Confirmation Modal
                    function handleConfirmationModal(data, pos, csrfToken, btn, origText) {
                        try {
                            const workedHours = data.worked_hours || 0;
                            const expectedHours = data.expected_hours || 9;
                            const remainingHours = (expectedHours - workedHours).toFixed(1);
                            const percent = data.completion_percentage || 0;

                            // Update Modal Content
                            const remainEl = document.getElementById('modal-remaining-hours');
                            if (remainEl) remainEl.innerText = remainingHours;

                            const workedEl = document.getElementById('modal-worked-hours');
                            if (workedEl) workedEl.innerText = workedHours + 'h worked';

                            const expectEl = document.getElementById('modal-expected-hours');
                            if (expectEl) expectEl.innerText = expectedHours + 'h goal';

                            const progEl = document.getElementById('modal-progress-bar');
                            if (progEl) progEl.style.width = percent + '%';

                            // Try to show Bootstrap Modal
                            const modalEl = document.getElementById('clockOutConfirmModal');
                            let bsModal = null;

                            if (modalEl && typeof bootstrap !== 'undefined') {
                                bsModal = new bootstrap.Modal(modalEl);
                                bsModal.show();

                                const confirmBtn = document.getElementById('btn-confirm-clockout');
                                const cancelBtn = document.getElementById('btn-cancel-clockout');

                                // Clean up previous listeners
                                const newConfirmBtn = confirmBtn.cloneNode(true);
                                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                                const newCancelBtn = cancelBtn.cloneNode(true);
                                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                                newCancelBtn.addEventListener('click', () => {
                                    btn.innerHTML = origText;
                                    btn.disabled = false;
                                });

                                // Handle modal close via X or click outside
                                modalEl.addEventListener('hidden.bs.modal', function () {
                                    if (btn.disabled && btn.innerHTML.includes('Verifying')) {
                                        // If we didn't confirm, reset button
                                        btn.innerHTML = origText;
                                        btn.disabled = false;
                                    }
                                }, { once: true });

                                newConfirmBtn.addEventListener('click', () => {
                                    bsModal.hide();
                                    executeClockOut(true);
                                });
                            } else {
                                // Fallback if modal/bootstrap fails
                                console.warn("Bootstrap modal not available, using fallback confirm");
                                const proceed = confirm(
                                    `Early Departure Warning:\n` +
                                    `You have ${remainingHours} hours remaining in your shift.\n` +
                                    `Worked: ${workedHours}h / Goal: ${expectedHours}h\n\n` +
                                    `Are you sure you want to clock out?`
                                );

                                if (proceed) {
                                    executeClockOut(true);
                                } else {
                                    btn.innerHTML = origText;
                                    btn.disabled = false;
                                }
                            }
                        } catch (e) {
                            console.error("Modal Error:", e);
                            // Last ditch fallback
                            if (confirm("You are leaving early. Continue to clock out?")) {
                                executeClockOut(true);
                            } else {
                                btn.innerHTML = origText;
                                btn.disabled = false;
                            }
                        }

                        function executeClockOut(force) {
                            btn.innerHTML = '<span class="status-text me-2">Processing...</span> <i class="fas fa-spinner fa-spin"></i>';

                            fetch("{% url 'api_clock_out' %}", {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                                body: JSON.stringify({
                                    latitude: pos.coords.latitude,
                                    longitude: pos.coords.longitude,
                                    force_clockout: true,
                                    accuracy: pos.coords.accuracy
                                })
                            })
                                .then(r => r.json())
                                .then(data2 => {
                                    if (data2.status === 'success') {
                                        location.reload();
                                    } else {
                                        alert(data2.message);
                                        btn.innerHTML = origText;
                                        btn.disabled = false;
                                    }
                                })
                                .catch((err) => {
                                    console.error(err);
                                    alert("Network error during clock out.");
                                    btn.innerHTML = origText;
                                    btn.disabled = false;
                                });
                        }
                    }
                }

                // Timeline Animation Removed



                // --- Location Tracking Service ---

                // 3D Tilt Effect for Shift Card
                const card = document.querySelector('.shift-card');
                if (card) {
                    card.addEventListener('mousemove', (e) => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;

                        const rotateX = ((y - centerY) / centerY) * -5;
                        const rotateY = ((x - centerX) / centerX) * 5;

                        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
                    });
                }

                // Staggered Week Days Animation
                const badges = document.querySelectorAll('.day-badge');
                badges.forEach((badge, index) => {
                    badge.style.opacity = '0';
                    badge.style.transform = 'translateY(10px)';
                    badge.style.transition = 'all 0.3s ease-out';
                    setTimeout(() => {
                        badge.style.opacity = '1';
                        badge.style.transform = 'translateY(0)';
                    }, 500 + (index * 100)); // Start after initial load 500ms
                });

                // Pulse Effect for Active Day (CSS handled)

                // Hourly Location Tracking
                let locationTrackingInterval;

                function startLocationTracking() {
                    // Check location tracking status immediately
                    checkLocationTrackingStatus();

                    // Set up interval to check every 1 minute (to catch hourly marks precisely)
                    locationTrackingInterval = setInterval(checkLocationTrackingStatus, 60000); // 1 minute
                }

                function checkLocationTrackingStatus() {
                    fetch("{% url 'api_location_tracking_status' %}", {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success' && data.needs_location) {
                                requestLocationUpdate();
                            } else if (data.tracking_stopped) {
                                // Server says stop (9 hours done)
                                console.log("Tracking stopped by server: " + data.message);
                                if (locationTrackingInterval) {
                                    clearInterval(locationTrackingInterval);
                                }
                            }
                        })
                        .catch(error => {
                            console.log('Location tracking status check failed:', error);
                        });
                }

                function requestLocationUpdate() {
                    if (!navigator.geolocation) {
                        console.log('Geolocation not supported');
                        return;
                    }

                    // Show a subtle notification
                    showLocationUpdateNotification();

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            submitHourlyLocation(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                        },
                        (error) => {
                            console.log('Location access denied or failed:', error);
                            // Still try to submit with null coordinates to mark the attempt
                            submitHourlyLocation(null, null, null);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5 minutes
                        }
                    );
                }

                function submitHourlyLocation(lat, lng, accuracy) {
                    const requestData = {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy
                    };

                    fetch("{% url 'api_submit_hourly_location' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                console.log('Hourly location updated successfully');
                                hideLocationUpdateNotification();
                            } else if (data.status === 'tracking_stopped') {
                                console.log("Tracking stopped during submission: " + data.message);
                                hideLocationUpdateNotification();
                                if (locationTrackingInterval) clearInterval(locationTrackingInterval);
                            } else {
                                console.log('Location update failed:', data.message);
                            }
                        })
                        .catch(error => {
                            console.log('Location update error:', error);
                        });
                }

                function showLocationUpdateNotification() {
                    // Create or show a subtle notification
                    let notification = document.getElementById('location-notification');
                    if (!notification) {
                        notification = document.createElement('div');
                        notification.id = 'location-notification';
                        notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #6366f1; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px;">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    Updating location for attendance tracking...
                </div>
            `;
                        document.body.appendChild(notification);
                    }
                    notification.style.display = 'block';
                }

                function hideLocationUpdateNotification() {
                    const notification = document.getElementById('location-notification');
                    if (notification) {
                        setTimeout(() => {
                            notification.style.display = 'none';
                        }, 2000);
                    }
                }

                // Start location tracking when page loads (only if user is clocked in)
                {% if attendance and attendance.is_currently_clocked_in %}
                document.addEventListener('DOMContentLoaded', function () {
                    startLocationTracking();
                });
                {% endif %}

                // Clean up interval when page unloads
                window.addEventListener('beforeunload', function () {
                    if (locationTrackingInterval) {
                        clearInterval(locationTrackingInterval);
                    }
                });

            </script>
            {% endblock %}