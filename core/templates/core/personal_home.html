{% extends 'core/base.html' %}
{% load static %}
{% block title %}My Home | HRMS{% endblock %}
{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        /* ASMR Professional Color Palette */
        --primary-color: #2D3748;
        /* Deep Charcoal */
        --primary-light: #EDF2F7;
        /* Soft Cloud */
        --secondary-color: #4A5568;
        /* Warm Slate */
        --accent-color: #38B2AC;
        /* Teal Zen */
        --accent-light: #E6FFFA;
        /* Mint Whisper */
        --success-color: #48BB78;
        /* Forest Green */
        --warning-color: #ED8936;
        /* Sunset Orange */
        --danger-color: #F56565;
        /* Coral Red */
        --info-color: #4299E1;
        /* Sky Blue */

        /* Background & Surface Colors */
        --bg-color: #F7FAFC;
        /* Pearl White */
        --bg-secondary: #EDF2F7;
        /* Soft Mist */
        --card-bg: #FFFFFF;
        /* Pure White */
        --card-hover: #FAFAFA;
        /* Warm White */

        /* Text Colors */
        --text-primary: #1A202C;
        /* Midnight */
        --text-secondary: #2D3748;
        /* Charcoal */
        --text-muted: #718096;
        /* Silver Gray */
        --text-light: #A0AEC0;
        /* Light Gray */

        /* Gradient Colors */
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        --gradient-accent: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        --gradient-warm: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        --gradient-cool: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);

        /* Shadows & Effects */
        --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.12);
        --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.16);
        --shadow-glow: 0 0 20px rgba(56, 178, 172, 0.15);

        /* Border Radius */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-2xl: 24px;

        /* Transitions */
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    body {
        font-family: 'Outfit', sans-serif;
        background: var(--bg-color);
        background-image:
            radial-gradient(circle at 20% 80%, rgba(56, 178, 172, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(102, 126, 234, 0.03) 0%, transparent 50%);
        color: var(--text-primary);
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* --- ENHANCED CARDS --- */
    .keka-card {
        background: var(--card-bg);
        border-radius: var(--radius-xl);
        border: 1px solid rgba(226, 232, 240, 0.6);
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
        height: 100%;
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(10px);
    }

    .keka-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(56, 178, 172, 0.2), transparent);
        opacity: 0;
        transition: var(--transition-smooth);
    }

    .keka-card:hover {
        box-shadow: var(--shadow-large);
        transform: translateY(-4px);
        border-color: rgba(56, 178, 172, 0.3);
        background: var(--card-hover);
    }

    .keka-card:hover::before {
        opacity: 1;
    }

    .card-header-clean {
        padding: 24px 24px 15px;
        border-bottom: 1px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: transparent;
        position: relative;
    }

    .card-title-text {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: var(--transition-smooth);
    }

    .card-icon-soft {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
    }

    .card-icon-soft::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .keka-card:hover .card-icon-soft::before {
        transform: translateX(100%);
    }

    .keka-card:hover .card-icon-soft.primary {
        background: var(--accent-light);
        color: var(--accent-color);
        transform: scale(1.1) rotate(5deg);
        box-shadow: var(--shadow-glow);
    }

    .keka-card:hover .card-icon-soft.warning {
        background: #FED7D7;
        color: var(--warning-color);
        transform: scale(1.1) rotate(-5deg);
    }

    .keka-card:hover .card-icon-soft.danger {
        background: #FED7D7;
        color: var(--danger-color);
        transform: scale(1.1) rotate(5deg);
    }

    .card-body-clean {
        padding: 24px;
        position: relative;
    }

    /* --- ENHANCED TYPOGRAPHY --- */
    .text-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-light);
        font-weight: 700;
        margin-bottom: 8px;
        position: relative;
        display: inline-block;
    }

    .text-label::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 20px;
        height: 2px;
        background: var(--gradient-accent);
        border-radius: 1px;
        opacity: 0.6;
    }

    .text-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--text-primary);
        line-height: 1.2;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        transition: var(--transition-smooth);
    }

    /* --- ENHANCED CLOCK WIDGET --- */
    .clock-widget {
        text-align: center;
        padding: 15px 0;
        position: relative;
    }

    .clock-widget::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: var(--gradient-accent);
        border-radius: 1px;
        opacity: 0.3;
    }

    .digital-clock {
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--text-primary) 0%, var(--secondary-color) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -2px;
        line-height: 1;
        margin-bottom: 8px;
        font-variant-numeric: tabular-nums;
        position: relative;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .current-date {
        font-size: 0.95rem;
        color: var(--text-muted);
        font-weight: 600;
        margin-bottom: 30px;
        background: var(--accent-light);
        display: inline-block;
        padding: 8px 20px;
        border-radius: 25px;
        border: 1px solid rgba(56, 178, 172, 0.2);
        position: relative;
        overflow: hidden;
    }

    .current-date::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(56, 178, 172, 0.1), transparent);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
        0% {
            left: -100%;
        }

        100% {
            left: 100%;
        }
    }

    .btn-clock {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 28px;
        border-radius: var(--radius-lg);
        font-weight: 700;
        border: none;
        width: 100%;
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
        margin-bottom: 16px;
        text-align: left;
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
    }

    .btn-clock::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s ease;
    }

    .btn-clock:hover::before {
        left: 100%;
    }

    .btn-clock:active {
        transform: scale(0.98);
    }

    .btn-clock-in-office {
        background: linear-gradient(135deg, var(--accent-light) 0%, rgba(56, 178, 172, 0.1) 100%);
        color: var(--accent-color);
        border: 2px solid rgba(56, 178, 172, 0.2);
    }

    .btn-clock-in-office:hover {
        background: var(--gradient-accent);
        color: white;
        box-shadow: var(--shadow-glow), var(--shadow-medium);
        border-color: var(--accent-color);
        transform: translateY(-2px) scale(1.02);
    }

    .btn-clock-in-remote {
        background: linear-gradient(135deg, #F7FAFC 0%, #EDF2F7 100%);
        color: var(--secondary-color);
        border: 2px solid rgba(74, 85, 104, 0.2);
    }

    .btn-clock-in-remote:hover {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3), var(--shadow-medium);
        border-color: var(--secondary-color);
        transform: translateY(-2px) scale(1.02);
    }

    .btn-clock-out {
        background: linear-gradient(135deg, var(--danger-color) 0%, #E53E3E 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        justify-content: center;
        border: 2px solid transparent;
    }

    .btn-clock-out:hover {
        background: linear-gradient(135deg, #E53E3E 0%, #C53030 100%);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 25px rgba(229, 62, 62, 0.4), var(--shadow-large);
    }

    .btn-icon-wrapper {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.1);
        transition: var(--transition-bounce);
    }

    .btn-clock:hover .btn-icon-wrapper {
        transform: rotate(10deg) scale(1.1);
        background: rgba(255, 255, 255, 0.2);
    }

    /* --- ENHANCED STATS CIRCLES --- */
    .stat-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 15px;
        max-width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .stat-ring::before {
        content: '';
        position: absolute;
        inset: -5px;
        border-radius: 50%;
        background: conic-gradient(from 0deg, var(--accent-color), var(--info-color), var(--accent-color));
        opacity: 0;
        transition: var(--transition-smooth);
        animation: rotate 3s linear infinite;
    }

    .stat-ring:hover::before {
        opacity: 0.1;
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .stat-ring svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
        max-width: 120px;
        max-height: 120px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .stat-ring circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
        transition: var(--transition-smooth);
    }

    .stat-ring .bg {
        stroke: var(--bg-secondary);
    }

    .stat-ring .progress {
        stroke: url(#gradient);
        stroke-dasharray: 283;
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-ring-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 80%;
        max-width: 80px;
        z-index: 2;
    }

    .stat-ring-value {
        font-weight: 800;
        font-size: 1.2rem;
        color: var(--text-primary);
        line-height: 1.2;
        word-break: break-word;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .stat-ring-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        line-height: 1.1;
        margin-top: 2px;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    /* Enhanced Weekly Stats Card - Horizontal Scrollable Solution */
    .weekly-stats-scroll-container {
        position: relative;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-color) transparent;
        border-radius: var(--radius-md);
    }

    .weekly-stats-scroll-container::-webkit-scrollbar {
        height: 6px;
    }

    .weekly-stats-scroll-container::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 3px;
    }

    .weekly-stats-scroll-container::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 3px;
        transition: var(--transition-smooth);
    }

    .weekly-stats-scroll-container::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-color);
    }

    .weekly-stats-content {
        display: flex;
        align-items: center;
        min-width: 100%;
        width: max-content;
        min-height: 140px;
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-secondary) 100%);
        border-radius: var(--radius-md);
    }

    .weekly-stats-left {
        display: flex;
        align-items: center;
        justify-content: center;
        border-right: 1px solid rgba(56, 178, 172, 0.1);
        padding: 1rem;
        min-width: 160px;
        flex-shrink: 0;
        height: 140px;
        position: relative;
    }

    .weekly-stats-left::before {
        content: '';
        position: absolute;
        top: 10%;
        right: 0;
        width: 1px;
        height: 80%;
        background: linear-gradient(to bottom, transparent, var(--accent-color), transparent);
        opacity: 0.3;
    }

    .weekly-stats-right {
        display: flex;
        align-items: center;
        justify-content: space-around;
        gap: 2rem;
        padding: 1rem 1.5rem;
        min-width: 200px;
        flex-shrink: 0;
        height: 140px;
        background: linear-gradient(135deg, rgba(56, 178, 172, 0.02) 0%, rgba(102, 126, 234, 0.02) 100%);
        position: relative;
    }

    .weekly-stats-item {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 80px;
        flex-shrink: 0;
        padding: 8px;
        border-radius: var(--radius-sm);
        transition: var(--transition-smooth);
        position: relative;
    }

    .weekly-stats-item:hover {
        background: rgba(56, 178, 172, 0.05);
        transform: translateY(-2px);
    }

    .weekly-stats-item .text-value {
        font-size: 1.5rem !important;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        background: var(--gradient-accent);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .weekly-stats-item .text-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        opacity: 0.8;
        white-space: nowrap;
        color: var(--text-muted);
    }

    /* Enhanced Scroll Indicator */
    .scroll-indicator {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, var(--accent-color), var(--info-color));
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        opacity: 0.8;
        pointer-events: none;
        animation: pulse-scroll 2s infinite;
        z-index: 10;
        box-shadow: var(--shadow-soft);
    }

    @keyframes pulse-scroll {

        0%,
        100% {
            opacity: 0.8;
            transform: translateY(-50%) scale(1);
        }

        50% {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
            box-shadow: var(--shadow-glow);
        }
    }

    /* Hide scroll indicator after user scrolls */
    .weekly-stats-scroll-container.scrolled .scroll-indicator {
        display: none;
    }

    /* Ensure SVG is properly sized */
    .stat-ring {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto;
        max-width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .stat-ring svg {
        width: 100%;
        height: 100%;
        max-width: 120px;
        max-height: 120px;
        transform: rotate(-90deg);
    }

    .stat-ring circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
    }

    .stat-ring .bg {
        stroke: #f1f5f9;
    }

    .stat-ring .progress {
        stroke: var(--primary-color);
        stroke-dasharray: 283;
        stroke-dashoffset: 200;
        transition: stroke-dashoffset 1s ease;
    }

    .stat-ring-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 80%;
        max-width: 80px;
    }

    .stat-ring-value {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-main);
        line-height: 1.2;
        word-break: break-word;
    }

    .stat-ring-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        line-height: 1.1;
        margin-top: 2px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .weekly-stats-content {
            flex-direction: column;
            width: 100%;
            min-width: 100%;
        }

        .weekly-stats-left {
            border-right: none;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 0.5rem 0.75rem;
            min-width: 100%;
            height: auto;
        }

        .weekly-stats-right {
            flex-direction: row;
            justify-content: space-around;
            padding: 0.75rem 0.5rem;
            gap: 1rem;
            min-width: 100%;
            height: auto;
            background: transparent;
        }

        .weekly-stats-item {
            flex: 1;
            min-width: auto;
        }

        .weekly-stats-item .text-value {
            font-size: 1.3rem !important;
        }

        .weekly-stats-item .text-label {
            font-size: 0.65rem;
        }

        .stat-ring {
            width: 90px;
            height: 90px;
            margin: 0 auto 8px;
        }

        .stat-ring svg {
            max-width: 90px;
            max-height: 90px;
        }

        .stat-ring-value {
            font-size: 1rem;
        }

        .stat-ring-label {
            font-size: 0.65rem;
        }

        .scroll-indicator {
            display: none !important;
        }
    }

    @media (max-width: 480px) {
        .weekly-stats-right {
            gap: 0.75rem;
            padding: 0.5rem;
        }

        .weekly-stats-item .text-value {
            font-size: 1.1rem !important;
        }

        .weekly-stats-item .text-label {
            font-size: 0.6rem;
        }

        .stat-ring {
            width: 75px;
            height: 75px;
        }

        .stat-ring svg {
            max-width: 75px;
            max-height: 75px;
        }

        .stat-ring-value {
            font-size: 0.9rem;
        }

        .stat-ring-label {
            font-size: 0.6rem;
        }
    }

    /* --- TIMELINE / SHIFT --- */
    .shift-timeline {
        display: flex;
        justify-content: space-between;
        position: relative;
        padding-top: 10px;
    }

    .shift-timeline::before {
        content: '';
        position: absolute;
        top: 24px;
        left: 20px;
        right: 20px;
        height: 4px;
        background: #f1f5f9;
        z-index: 1;
        border-radius: 4px;
    }

    .timeline-point {
        position: relative;
        z-index: 2;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .timeline-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #cbd5e1;
        border: 3px solid #fff;
        box-shadow: 0 0 0 1px #e2e8f0;
        margin-top: 10px;
        margin-bottom: 8px;
    }

    .timeline-point.active .timeline-dot {
        background: var(--success-color);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .timeline-time {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-main);
    }

    .timeline-label {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* --- ENHANCED WEEK DAYS --- */
    .week-days {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--accent-light) 100%);
        padding: 12px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(56, 178, 172, 0.1);
    }

    .day-badge {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--text-muted);
        background: var(--card-bg);
        border: 2px solid rgba(226, 232, 240, 0.5);
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
    }

    .day-badge::before {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--gradient-accent);
        opacity: 0;
        transition: var(--transition-smooth);
    }

    .day-badge.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        box-shadow: var(--shadow-glow), var(--shadow-soft);
        transform: scale(1.1);
    }

    .day-badge.active::before {
        opacity: 0.1;
    }

    .day-badge:hover:not(.active) {
        transform: scale(1.05);
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    /* --- ENHANCED CELEBRATIONS --- */
    .celebration-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: var(--radius-md);
        background: var(--card-bg);
        border: 1px solid rgba(226, 232, 240, 0.5);
        margin-bottom: 12px;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .celebration-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(56, 178, 172, 0.05), transparent);
        transition: left 0.6s ease;
    }

    .celebration-item:hover {
        transform: translateX(8px) scale(1.02);
        border-color: var(--accent-color);
        box-shadow: var(--shadow-medium);
    }

    .celebration-item:hover::before {
        left: 100%;
    }

    .celebration-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FED7D7 0%, #FBB6CE 100%);
        color: var(--danger-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 15px;
        font-size: 1.1rem;
        border: 3px solid white;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-bounce);
    }

    .celebration-item:hover .celebration-avatar {
        transform: scale(1.1) rotate(10deg);
        box-shadow: var(--shadow-medium);
    }

    .celebration-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--card-bg);
        border-radius: 50%;
        box-shadow: var(--shadow-soft);
        color: var(--danger-color);
        margin-left: auto;
        transition: var(--transition-bounce);
    }

    .celebration-item:hover .celebration-icon {
        transform: scale(1.1);
        background: var(--accent-light);
        color: var(--accent-color);
    }

    /* --- ENHANCED TABLE --- */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 600px;
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-soft);
    }

    .table-custom th {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--accent-light) 100%);
        padding: 18px 22px;
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--text-secondary);
        border-top: 1px solid rgba(56, 178, 172, 0.1);
        border-bottom: 1px solid rgba(56, 178, 172, 0.1);
        letter-spacing: 0.08em;
        white-space: nowrap;
        position: relative;
    }

    .table-custom th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--gradient-accent);
        opacity: 0.3;
    }

    .table-custom th:first-child {
        border-top-left-radius: var(--radius-md);
        border-left: 1px solid rgba(56, 178, 172, 0.1);
    }

    .table-custom th:last-child {
        border-top-right-radius: var(--radius-md);
        border-right: 1px solid rgba(56, 178, 172, 0.1);
    }

    .table-custom td {
        padding: 18px 22px;
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        vertical-align: middle;
        background: var(--card-bg);
        transition: var(--transition-smooth);
        white-space: nowrap;
        position: relative;
    }

    .table-custom tr:last-child td {
        border-bottom: none;
    }

    .table-custom tr:last-child td:first-child {
        border-bottom-left-radius: var(--radius-md);
    }

    .table-custom tr:last-child td:last-child {
        border-bottom-right-radius: var(--radius-md);
    }

    .table-custom tr:hover td {
        background: linear-gradient(135deg, var(--accent-light) 0%, rgba(56, 178, 172, 0.05) 100%);
        transform: scale(1.01);
    }

    .table-custom tr:hover td:first-child {
        border-left: 2px solid var(--accent-color);
    }

    .status-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 2px solid transparent;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .status-badge::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .status-badge:hover::before {
        left: 100%;
    }

    .status-present {
        background: linear-gradient(135deg, #D6F5D6 0%, #C6F6D5 100%);
        color: var(--success-color);
        border-color: rgba(72, 187, 120, 0.3);
    }

    .status-absent {
        background: linear-gradient(135deg, #FED7D7 0%, #FEB2B2 100%);
        color: var(--danger-color);
        border-color: rgba(245, 101, 101, 0.3);
    }

    .status-half {
        background: linear-gradient(135deg, #FEEBC8 0%, #FBD38D 100%);
        color: var(--warning-color);
        border-color: rgba(237, 137, 54, 0.3);
    }

    .status-holiday {
        background: linear-gradient(135deg, var(--accent-light) 0%, #B2F5EA 100%);
        color: var(--accent-color);
        border-color: rgba(56, 178, 172, 0.3);
    }

    .status-missed {
        background: linear-gradient(135deg, #FED7D7 0%, #FCA5A5 100%);
        color: #C53030;
        border-color: rgba(197, 48, 48, 0.3);
    }

    .status-not-login {
        background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
        color: #92400E;
        border-color: rgba(146, 64, 14, 0.3);
    }

    .status-wfh {
        background: linear-gradient(135deg, var(--primary-light) 0%, #E2E8F0 100%);
        color: var(--secondary-color);
        border-color: rgba(74, 85, 104, 0.3);
    }

    .status-leave {
        background: linear-gradient(135deg, #FFF5F5 0%, #FED7D7 100%);
        color: #C05621;
        border-color: rgba(192, 86, 33, 0.3);
    }

    /* Overlay */
    #celebration-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(45, 55, 72, 0.8);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.6s ease;
    }

    /* Enhanced Animations */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    @keyframes glow {

        0%,
        100% {
            box-shadow: var(--shadow-soft);
        }

        50% {
            box-shadow: var(--shadow-glow), var(--shadow-medium);
        }
    }

    .animate-enter {
        animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        opacity: 0;
    }

    .animate-float {
        animation: float 3s ease-in-out infinite;
    }

    .animate-glow {
        animation: glow 2s ease-in-out infinite;
    }

    .delay-100 {
        animation-delay: 0.1s;
    }

    .delay-200 {
        animation-delay: 0.2s;
    }

    .delay-300 {
        animation-delay: 0.3s;
    }

    /* ASMR Pulse Effect */
    .anim-pulse {
        animation: asmr-pulse 2s ease-in-out infinite;
    }

    @keyframes asmr-pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }

    /* Smooth Focus States */
    .btn:focus,
    .form-control:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(56, 178, 172, 0.2);
        border-color: var(--accent-color);
    }

    /* Enhanced Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 4px;
        transition: var(--transition-smooth);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-color);
    }

    /* --- RESPONSIVE DESIGN --- */
    @media (max-width: 1200px) {
        .digital-clock {
            font-size: 3rem;
        }

        .card-body-clean {
            padding: 20px;
        }

        /* Ensure proper alignment in weekly stats for large tablets */
    }

    @media (max-width: 992px) {
        .digital-clock {
            font-size: 2.8rem;
        }

        .shift-card {
            margin-bottom: 20px;
        }

        .pro-icon-box {
            width: 56px;
            height: 56px;
        }

        .pro-icon-box i {
            font-size: 1.3rem;
        }

        /* Weekly stats alignment for tablets */
    }

    @media (max-width: 768px) {
        .container-fluid {
            padding: 15px 10px;
        }

        /* Stack columns vertically on mobile */
        .col-lg-3,
        .col-lg-6 {
            margin-bottom: 20px;
        }

        /* Adjust clock widget for mobile */
        .digital-clock {
            font-size: 2.5rem;
            letter-spacing: -1px;
        }

        .current-date {
            font-size: 0.85rem;
            padding: 5px 12px;
        }

        /* Mobile-friendly buttons */
        .btn-clock {
            padding: 18px 20px;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .btn-icon-wrapper {
            width: 28px;
            height: 28px;
            font-size: 1rem;
        }

        /* Adjust shift card for mobile */
        .shift-header {
            padding: 20px 20px 10px;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .shift-icon-box {
            width: 48px;
            height: 48px;
            margin-right: 15px;
        }

        .shift-icon-box i {
            font-size: 1.2rem;
        }

        .shift-badge {
            padding: 8px 20px;
            font-size: 0.75rem;
        }

        .pro-icon-box {
            width: 48px;
            height: 48px;
        }

        .pro-icon-box i {
            font-size: 1.1rem;
        }

        /* Shift card mobile adjustments */
        .shift-clock-section {
            flex-direction: column;
            padding: 1.5rem 1rem;
            gap: 1.5rem;
        }

        .shift-divider {
            width: 60px;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .shift-time-display {
            font-size: 1.8rem;
        }

        /* Adjust timeline for mobile */
        .timeline-container {
            padding: 60px 30px 50px;
        }

        .timeline-track {
            left: 30px;
            right: 30px;
        }

        .timeline-nodes {
            left: 30px;
            right: 30px;
        }

        /* Mobile table improvements */
        .table-custom {
            font-size: 0.85rem;
            min-width: 700px;
            /* Force horizontal scroll on mobile */
        }

        .table-custom th,
        .table-custom td {
            padding: 12px 15px;
        }

        /* Mobile-specific table layout */
        .table-responsive {
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-bottom: 20px;
        }

        /* Add swipe indicator for mobile tables */
        .table-responsive::after {
            content: "← Swipe to see more →";
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            z-index: 10;
            pointer-events: none;
            opacity: 0.8;
            animation: fadeInOut 3s ease-in-out infinite;
        }

        @keyframes fadeInOut {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* Hide swipe indicator after user scrolls */
        .table-responsive.scrolled::after {
            display: none;
        }

        /* Responsive table columns for mobile - hide less important columns */
        .table-custom th:nth-child(4),
        /* Hours column */
        .table-custom td:nth-child(4) {
            display: none;
        }

        /* Keep Map column visible but make it more compact */
        .table-custom th:nth-child(6),
        /* Map column */
        .table-custom td:nth-child(6) {
            min-width: 50px;
            padding: 8px 4px;
            text-align: center;
        }

        .table-custom td:nth-child(6) .btn {
            width: 32px;
            height: 32px;
            padding: 0;
            font-size: 0.8rem;
        }

        /* Make status badges smaller on mobile */
        .status-badge {
            padding: 4px 8px;
            font-size: 0.7rem;
        }

        /* Compact date display */
        .table-custom td:first-child {
            min-width: 70px;
        }

        .table-custom td:first-child .fw-bold {
            font-size: 0.9rem;
        }

        .table-custom td:first-child .small {
            font-size: 0.7rem;
        }

        /* Time columns more compact */
        .table-custom td:nth-child(2),
        .table-custom td:nth-child(3) {
            min-width: 80px;
            font-size: 0.8rem;
        }

        /* Attendance log card header mobile optimization */
        .keka-card .card-header-clean {
            padding: 15px 20px 10px;
        }

        .keka-card .card-title-text {
            font-size: 0.95rem;
        }

        .keka-card .btn-sm {
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        /* Adjust stat ring for mobile */
        .stat-ring {
            width: 100px;
            height: 100px;
            margin: 0 auto 12px;
        }

        .stat-ring svg {
            max-width: 100px;
            max-height: 100px;
        }

        .stat-ring circle {
            stroke-width: 6;
        }

        .stat-ring-content {
            width: 75%;
            max-width: 70px;
        }

        .stat-ring-value {
            font-size: 1rem;
            line-height: 1.1;
        }

        .stat-ring-label {
            font-size: 0.65rem;
            margin-top: 1px;
        }

        /* Weekly stats mobile alignment */

        /* Week days adjustment */
        .week-days {
            gap: 3px;
            padding: 8px;
        }

        .day-badge {
            width: 28px;
            height: 28px;
            font-size: 0.75rem;
        }

        /* Celebration items */
        .celebration-item {
            padding: 10px;
            margin-bottom: 8px;
        }

        .celebration-avatar {
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
        }

        /* Modal adjustments */
        .modal-dialog {
            margin: 15px;
        }

        .modal-content {
            border-radius: 16px;
        }
    }

    @media (max-width: 576px) {
        .container-fluid {
            padding: 10px 8px;
        }

        /* Header adjustments */
        .d-flex.justify-content-between.align-items-end {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .d-flex.justify-content-between.align-items-end h4 {
            font-size: 1.3rem;
        }

        /* Further reduce clock size */
        .digital-clock {
            font-size: 2rem;
        }

        .current-date {
            font-size: 0.8rem;
        }

        /* Compact buttons */
        .btn-clock {
            padding: 15px 18px;
            font-size: 0.9rem;
        }

        /* Shift card adjustments */
        .shift-header {
            padding: 15px 15px 8px;
        }

        .shift-header h3 {
            font-size: 1.1rem;
        }

        .shift-header .opacity-75 {
            font-size: 1rem;
        }

        .timeline-container {
            padding: 50px 20px 40px;
        }

        .timeline-track {
            left: 20px;
            right: 20px;
        }

        .timeline-nodes {
            left: 20px;
            right: 20px;
        }

        .shift-footer {
            padding: 15px 20px;
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        /* Very compact stats ring for small screens */
        .stat-ring {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
        }

        .stat-ring svg {
            max-width: 80px;
            max-height: 80px;
        }

        .stat-ring circle {
            stroke-width: 5;
        }

        .stat-ring-content {
            width: 70%;
            max-width: 56px;
        }

        .stat-ring-value {
            font-size: 0.9rem;
            line-height: 1;
        }

        .stat-ring-label {
            font-size: 0.6rem;
            margin-top: 1px;
        }

        /* Weekly stats very small screens alignment */

        /* Very compact table */
        .table-custom {
            font-size: 0.8rem;
            min-width: 600px;
            /* Reduce minimum width for very small screens */
        }

        .table-custom th,
        .table-custom td {
            padding: 10px 8px;
        }

        /* Hide more columns on very small screens but keep Map visible */
        .table-custom th:nth-child(4),
        .table-custom td:nth-child(4) {
            display: none;
        }

        /* Make Map column even more compact on very small screens */
        .table-custom th:nth-child(6),
        /* Map column */
        .table-custom td:nth-child(6) {
            min-width: 40px;
            padding: 6px 2px;
            text-align: center;
        }

        .table-custom td:nth-child(6) .btn {
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Ensure map buttons are touch-friendly */
        .table-custom td:nth-child(6) a {
            min-width: 32px;
            min-height: 32px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Make the table more compact */
        .table-custom th {
            font-size: 0.7rem;
            padding: 8px 6px;
        }

        .table-custom td {
            padding: 8px 6px;
            font-size: 0.75rem;
        }

        /* Ultra-compact date display */
        .table-custom td:first-child {
            min-width: 50px;
        }

        .table-custom td:first-child .fw-bold {
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .table-custom td:first-child .small {
            font-size: 0.65rem;
        }

        /* Ultra-compact time columns */
        .table-custom td:nth-child(2),
        .table-custom td:nth-child(3) {
            min-width: 60px;
            font-size: 0.7rem;
        }

        /* Ultra-compact status badges */
        .status-badge {
            padding: 2px 6px;
            font-size: 0.65rem;
            border-radius: 8px;
        }

        /* Shift card very small screens */
        .shift-time-display {
            font-size: 1.5rem;
        }

        .pro-icon-box {
            width: 40px;
            height: 40px;
        }

        .pro-icon-box i {
            font-size: 1rem !important;
        }

        /* Card header adjustments for mobile */
        .card-header-clean {
            padding: 15px 15px 10px;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .card-title-text {
            font-size: 0.95rem;
        }

        .btn-sm {
            font-size: 0.7rem;
            padding: 4px 8px;
        }

        /* Improve table scrolling experience */
        .table-responsive {
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* Adjust swipe indicator for very small screens */
        .table-responsive::after {
            font-size: 0.65rem;
            padding: 3px 8px;
            bottom: 8px;
        }

        /* Compact week days */
        .day-badge {
            width: 24px;
            height: 24px;
            font-size: 0.7rem;
        }

        /* Compact celebration items */
        .celebration-avatar {
            width: 32px;
            height: 32px;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .celebration-item-content {
            font-size: 0.85rem;
        }

        /* Modal full width on very small screens */
        .modal-dialog {
            margin: 10px;
            width: calc(100% - 20px);
        }
    }

    /* Extra small screens (phones in portrait) */
    @media (max-width: 400px) {
        .stat-ring {
            width: 70px;
            height: 70px;
            margin: 0 auto 8px;
        }

        .stat-ring svg {
            max-width: 70px;
            max-height: 70px;
        }

        .stat-ring circle {
            stroke-width: 4;
        }

        .stat-ring-content {
            width: 65%;
            max-width: 45px;
        }

        .stat-ring-value {
            font-size: 0.8rem;
            line-height: 0.9;
        }

        .stat-ring-label {
            font-size: 0.55rem;
            margin-top: 0;
        }

        /* Ultra compact weekly stats */
    }

    /* Landscape phone adjustments */
    @media (max-width: 896px) and (orientation: landscape) {
        .digital-clock {
            font-size: 2.2rem;
        }

        .shift-card {
            margin-bottom: 15px;
        }

        .timeline-container {
            padding: 40px 25px 35px;
        }

        /* Adjust stat ring for landscape */
        .stat-ring {
            width: 90px;
            height: 90px;
        }

        .stat-ring svg {
            max-width: 90px;
            max-height: 90px;
        }

        .stat-ring-content {
            max-width: 65px;
        }

        .stat-ring-value {
            font-size: 0.95rem;
        }

        .stat-ring-label {
            font-size: 0.6rem;
        }

        /* Weekly stats landscape alignment */
    }

    /* Touch device improvements */
    @media (hover: none) and (pointer: coarse) {
        .btn-clock {
            min-height: 48px;
        }

        .keka-card:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        .celebration-item:hover {
            transform: none;
        }

        .table-responsive {
            -webkit-overflow-scrolling: touch;
        }
    }
</style>
{% endblock %}
{% block content %}
<!-- Hidden Data Context for JS -->
<div id="page-context" data-csrf="{{ csrf_token }}" data-clock-in="{{ attendance.clock_in|date:'Y-m-d H:i:s' }}"
    data-avg-hours="{{ avg_hours|default:'00:00' }}" data-user-timezone="{{ user_timezone }}" style="display:none;">
</div>
<div class="container-fluid py-4 px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-end mb-5 animate-enter">
        <div>
            <h4 class="fw-bold mb-1"
                style="background: var(--gradient-primary); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; font-size: 1.8rem;">
                <span id="dynamic-greeting">Good Morning</span>, {{ request.user.first_name }}! &#128075;
            </h4>
            <p class="text-muted mb-0" style="color: var(--text-muted); font-size: 1.1rem; font-weight: 500;">Here's
                what's happening today.</p>
        </div>
        <div class="text-end d-none d-md-block">
            <div id="header-date" class="fw-bold text-dark fs-5"
                style="color: var(--text-secondary) !important; background: var(--accent-light); padding: 8px 16px; border-radius: var(--radius-md); border: 1px solid rgba(56, 178, 172, 0.2);">
            </div>
        </div>
    </div>

    <!-- SVG Gradient Definitions -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:var(--accent-color);stop-opacity:1" />
                <stop offset="100%" style="stop-color:var(--info-color);stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Top Stats Row (Mobile Only sort of, but useful for overview) -->
    <!-- Grid Layout -->
    <div class="row g-4">

        <!-- Left Column: Primary Actions & Stats -->
        <div class="col-12 col-lg-3 order-1 order-lg-1">
            <div class="vstack gap-4">

                <!-- Clock In/Out Card -->
                <div class="keka-card animate-enter delay-100">
                    <div class="card-body-clean text-center">
                        <div class="mb-4">
                            <div class="text-label mb-2">Current Time</div>
                            <div id="clock" class="digital-clock">--:--</div>
                            <div id="date-sub" class="current-date">-- -- ----</div>
                        </div>

                        {% if attendance and attendance.is_currently_clocked_in %}
                        <!-- Clocked In State -->
                        <div class="p-3 rounded-4 mb-4 border"
                            style="background: linear-gradient(135deg, var(--accent-light) 0%, rgba(56, 178, 172, 0.05) 100%); border-color: rgba(56, 178, 172, 0.25) !important;">
                            <div class="text-label mb-1" style="color: var(--accent-color); opacity: 0.8;">Current
                                Session</div>
                            <div class="fs-4 fw-bold" style="color: var(--accent-color); letter-spacing: -0.02em;">
                                <i class="fas fa-circle fa-xs me-1 anim-pulse" style="color: var(--success-color);"></i>
                                Active
                                <span class="badge ms-2"
                                    style="background: var(--success-color); color: white; border: 1px solid rgba(72, 187, 120, 0.1); font-weight: 700;">
                                    {{ attendance.current_session_type|default:"WEB" }}
                                </span>
                            </div>
                            {% if attendance.clock_in %}
                            <div class="text-muted small mt-1">Started at {{ attendance.get_current_session.clock_in|default:attendance.clock_in|time:"h:i A" }}
                            </div>
                            {% endif %}

                            <hr class="my-3 text-muted opacity-25">

                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-label" style="font-size: 0.65rem;">Session Duration</div>
                                    <div class="fw-bold text-dark timer-count" id="timer-display">00:00:00</div>
                                </div>
                                <div class="text-end">
                                    <div class="text-label" style="font-size: 0.65rem;">Total Today</div>
                                    <div class="fw-bold text-primary" id="total-today-display">
                                        {{ attendance.total_working_hours|floatformat:1 }} hr
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="btn-clock btn-clock-out" onclick="handleClockAction('out', null, this)">
                            <span class="btn-icon-wrapper"><i class="fas fa-sign-out-alt"></i></span>
                            Clock Out
                        </button>

                        {% else %}
                        <!-- Clocked Out State -->
                        {% if attendance and attendance.daily_sessions_count > 0 %}
                        <div class="p-3 bg-info bg-opacity-10 rounded-3 mb-4 border border-info">
                            <div class="text-label mb-1">Today's Progress</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">
                                        {{ attendance.total_working_hours|floatformat:1 }} hours
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="status-badge status-{{ attendance.status|lower }}">
                                        {{ attendance.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-3">
                            {% if not attendance or attendance.daily_sessions_count < attendance.max_daily_sessions %}
                                <button class="btn-clock btn-clock-in-office"
                                onclick="handleClockAction('in', 'office', this)">
                                <span class="btn-icon-wrapper"><i class="fas fa-building"></i></span>
                                Web Clock-In
                                </button>
                                <button class="btn-clock btn-clock-in-remote"
                                    onclick="handleClockAction('in', 'remote', this)">
                                    <span class="btn-icon-wrapper"><i class="fas fa-laptop-house"></i></span>
                                    Remote Clock-In
                                </button>
                                {% else %}
                                <!-- Max sessions limit reached (Hidden from UI as per request) -->
                                <div class="text-muted text-center small mt-2">
                                    All sessions completed for today.
                                </div>
                                {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Weekly Summary Mini Stats -->
                <div class="keka-card animate-enter delay-200">
                    <div class="card-header-clean">
                        <span class="card-title-text">
                            <span class="card-icon-soft primary"><i class="fas fa-chart-pie"></i></span>
                            Weekly Stats
                        </span>
                    </div>
                    <div class="card-body-clean pt-0 px-0">
                        <div class="weekly-stats-scroll-container">
                            <div class="weekly-stats-content">
                                <div class="weekly-stats-left">
                                    <div class="stat-ring">
                                        <svg viewBox="0 0 120 120">
                                            <circle class="bg" cx="60" cy="60" r="45"></circle>
                                            <circle class="progress" cx="60" cy="60" r="45" id="avg-progress"></circle>
                                        </svg>
                                        <div class="stat-ring-content">
                                            <div class="stat-ring-value">{{ avg_hours|default:"00:00" }}</div>
                                            <div class="stat-ring-label">Avg Hrs</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="weekly-stats-right">
                                    <div class="weekly-stats-item">
                                        <div class="text-value text-success">100%</div>
                                        <div class="text-label">On Time</div>
                                    </div>
                                    <div class="weekly-stats-item">
                                        <div class="text-value text-primary">{{ leave_balance.casual_leave_balance|floatformat:1|default:"0" }}</div>
                                        <div class="text-label">CL Available</div>
                                    </div>
                                    <div class="weekly-stats-item">
                                        <div class="text-value text-warning">{{ leave_balance.sick_leave_balance|floatformat:1|default:"0" }}</div>
                                        <div class="text-label">SL Available</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Scroll indicator for desktop -->
                            <div class="scroll-indicator d-none d-md-block">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Middle Column: Shift & Activity -->
        <div class="col-12 col-lg-6 order-3 order-lg-2">
            <div class="vstack gap-4">

                <style>
                    /* --- ENHANCED ANIMATED SHIFT CARD --- */
                    .shift-card {
                        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                        border-radius: var(--radius-2xl);
                        color: white;
                        position: relative;
                        overflow: hidden;
                        box-shadow: var(--shadow-large);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        transition: var(--transition-smooth);
                    }

                    .shift-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg,
                                rgba(56, 178, 172, 0.1) 0%,
                                rgba(102, 126, 234, 0.1) 100%);
                        opacity: 0;
                        transition: var(--transition-smooth);
                    }

                    .shift-card:hover {
                        transform: translateY(-8px) scale(1.02);
                        box-shadow: var(--shadow-large), 0 25px 50px -12px rgba(45, 55, 72, 0.4);
                    }

                    .shift-card:hover::before {
                        opacity: 1;
                    }

                    .shift-header {
                        position: relative;
                        z-index: 2;
                        padding: 30px 30px 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .shift-icon-box {
                        width: 60px;
                        height: 60px;
                        border-radius: var(--radius-lg);
                        background: rgba(255, 255, 255, 0.15);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        backdrop-filter: blur(12px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.6rem;
                        margin-right: 20px;
                        box-shadow: var(--shadow-soft);
                        transition: var(--transition-bounce);
                        position: relative;
                        overflow: hidden;
                    }

                    .shift-icon-box::before {
                        content: '';
                        position: absolute;
                        inset: 0;
                        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                        transform: translateX(-100%);
                        transition: transform 0.6s ease;
                    }

                    .shift-card:hover .shift-icon-box {
                        transform: rotate(10deg) scale(1.1);
                        background: rgba(255, 255, 255, 0.25);
                    }

                    .shift-card:hover .shift-icon-box::before {
                        transform: translateX(100%);
                    }

                    .shift-badge {
                        background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
                        color: var(--accent-color);
                        font-weight: 800;
                        padding: 12px 28px;
                        border-radius: 50px;
                        font-size: 0.8rem;
                        box-shadow: var(--shadow-medium);
                        text-transform: uppercase;
                        letter-spacing: 0.1em;
                        border: 2px solid rgba(56, 178, 172, 0.2);
                        transition: var(--transition-bounce);
                    }

                    .shift-card:hover .shift-badge {
                        transform: scale(1.05);
                        box-shadow: var(--shadow-glow), var(--shadow-medium);
                        border-color: var(--accent-color);
                    }

                    .timeline-container {
                        position: relative;
                        z-index: 2;
                        padding: 80px 40px 60px;
                    }

                    .timeline-track {
                        position: absolute;
                        top: 110px;
                        left: 40px;
                        right: 40px;
                        height: 4px;
                        background: rgba(255, 255, 255, 0.15);
                        border-radius: 10px;
                        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
                    }

                    .timeline-progress-bar {
                        position: absolute;
                        top: 0;
                        left: 0;
                        height: 100%;
                        background: linear-gradient(90deg, var(--accent-color), var(--info-color));
                        border-radius: 10px;
                        width: 0%;
                        transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 0 20px rgba(56, 178, 172, 0.5);
                    }

                    .timeline-handle {
                        position: absolute;
                        right: -12px;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 24px;
                        height: 24px;
                        background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
                        border: 3px solid var(--accent-color);
                        border-radius: 50%;
                        box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), var(--shadow-medium);
                        z-index: 100;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }

                    .timeline-handle::after {
                        content: '';
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        background: rgba(56, 178, 172, 0.3);
                        border-radius: 50%;
                        animation: pulse-timeline 2s infinite;
                    }

                    @keyframes pulse-timeline {
                        0% {
                            transform: scale(1);
                            opacity: 0.8;
                        }

                        100% {
                            transform: scale(2.5);
                            opacity: 0;
                        }
                    }

                    .timeline-time-badge {
                        position: absolute;
                        bottom: 25px;
                        background: transparent;
                        color: white;
                        font-weight: 800;
                        font-size: 1.1rem;
                        white-space: nowrap;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    }

                    .timeline-nodes {
                        position: absolute;
                        top: 110px;
                        left: 40px;
                        right: 40px;
                        height: 0;
                        pointer-events: none;
                    }

                    .t-node {
                        position: absolute;
                        top: 0;
                        transform: translate(-50%, -50%);
                        /* Correctly centers the dot on the point */
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        transition: transform 0.3s ease;
                        cursor: default;
                    }

                    .t-node:hover {
                        transform: translateX(-50%) translateY(-5px) !important;
                        /* Keep the X transform but lift up */
                        z-index: 10;
                        pointer-events: auto;
                    }

                    .t-time {
                        position: absolute;
                        bottom: 18px;
                        /* Time above dot */
                        font-weight: 700;
                        font-size: 0.9rem;
                        margin-bottom: 14px;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        color: white;
                    }

                    .t-dot {
                        width: 18px;
                        height: 18px;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.2);
                        border: 2px solid rgba(255, 255, 255, 0.6);
                        margin-bottom: 10px;
                        position: relative;
                        transition: all 0.3s ease;
                    }

                    .t-node:hover .t-dot {
                        background: rgba(255, 255, 255, 1);
                        box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
                    }

                    .t-dot.green {
                        background: var(--success-color);
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(72, 187, 120, 0.3);
                    }

                    .t-dot.web {
                        background: var(--info-color);
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.3);
                    }

                    .t-dot.remote {
                        background: var(--accent-color);
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(56, 178, 172, 0.3);
                    }

                    .t-dot.logout {
                        background: var(--danger-color);
                        border-color: #fff;
                        box-shadow: 0 0 0 4px rgba(245, 101, 101, 0.3);
                    }

                    .t-label {
                        font-size: 0.75rem;
                        font-weight: 600;
                        opacity: 0.9;
                        letter-spacing: 0.03em;
                        background: rgba(0, 0, 0, 0.15);
                        padding: 2px 8px;
                        border-radius: 4px;
                    }

                    .shift-footer {
                        background: rgba(0, 0, 0, 0.08);
                        padding: 18px 30px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-top: 1px solid rgba(255, 255, 255, 0.1);
                        position: relative;
                        z-index: 2;
                    }
                </style>


                <div class="shift-card animate-enter delay-100 mb-4">
                    <div class="shift-header">
                        <div class="d-flex align-items-center">
                            <div class="shift-icon-box">
                                <i class="far fa-clock"></i>
                            </div>
                            <div>
                                <h3 class="mb-1 fw-bold text-white">
                                    {% if assigned_shift %}{{ assigned_shift.name }}{% else %}General Shift{% endif %}
                                </h3>
                                <div class="opacity-75 fw-medium" style="font-size: 1.1rem; letter-spacing: 0.02em;">
                                    {% if assigned_shift %}
                                    {{ assigned_shift.start_time|time:"h:i A" }} - {{ assigned_shift.end_time|time:"h:i A" }}
                                    {% else %}
                                    09:00 AM - 06:00 PM
                                    {% endif %}
                                </div>
                            </div>

                        </div>
                        <div class="shift-badge"
                            style="background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%); color: var(--accent-color); border: 2px solid rgba(56, 178, 172, 0.2); box-shadow: var(--shadow-medium);">
                            {% if assigned_shift %}Active{% else %}Default{% endif %}
                        </div>
                    </div>

                    <style>
                        /* --- PRO ICONS --- */
                        .pro-icon-box {
                            width: 64px;
                            height: 64px;
                            border-radius: 20px;
                            background: rgba(255, 255, 255, 0.1);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            position: relative;
                            margin: 0 auto;
                        }

                        .pro-icon-box:hover {
                            transform: translateY(-5px) scale(1.05);
                            background: rgba(255, 255, 255, 0.2);
                            box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.3);
                            border-color: rgba(255, 255, 255, 0.5);
                        }

                        .pro-icon-box i {
                            transition: all 0.3s ease;
                            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
                        }

                        .pro-icon-box:hover i {
                            transform: scale(1.1);
                            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
                        }

                        .icon-ring {
                            position: absolute;
                            inset: -3px;
                            border-radius: 23px;
                            border: 2px solid rgba(255, 255, 255, 0.1);
                            opacity: 0;
                            transition: all 0.3s ease;
                        }

                        .pro-icon-box:hover .icon-ring {
                            opacity: 1;
                            inset: -6px;
                            border-color: rgba(255, 255, 255, 0.3);
                        }

                        /* Shift Card Clock Section */
                        .shift-clock-section {
                            display: flex;
                            justify-content: space-around;
                            align-items: center;
                            padding: 2rem 1.5rem;
                            flex-wrap: wrap;
                            gap: 1rem;
                        }

                        .shift-time-block {
                            text-align: center;
                            flex: 1;
                            min-width: 120px;
                        }

                        .shift-time-display {
                            font-size: 2rem;
                            font-weight: 800;
                            color: white;
                            margin-bottom: 0;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                            line-height: 1.2;
                        }

                        .shift-divider {
                            width: 1px;
                            height: 60px;
                            background: rgba(255, 255, 255, 0.2);
                            flex-shrink: 0;
                        }
                    </style>

                    <div class="d-flex justify-content-around align-items-center px-4 py-5 shift-clock-section">
                        <!-- Clock In Block -->
                        <div class="text-center shift-time-block">
                            <div class="mb-3">
                                <div class="pro-icon-box">
                                    <div class="icon-ring"></div>
                                    <i class="fas fa-fingerprint text-white fs-2"></i>
                                </div>
                            </div>
                            <div class="text-white opacity-75 small text-uppercase fw-bold mb-1">Clock In
                            </div>
                            <div class="fs-2 fw-bold text-white mb-0 shift-time-display"
                                style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                {% if attendance and attendance.clock_in %}
                                {{ attendance.clock_in|time:"h:i A" }}
                                {% else %}
                                --:--
                                {% endif %}
                            </div>
                        </div>

                        <!-- Divider Line (Vertical) -->
                        <div class="shift-divider" style="width: 1px; height: 60px; background: rgba(255,255,255,0.2);">
                        </div>

                        <!-- Clock Out Block -->
                        <div class="text-center shift-time-block">
                            <div class="mb-3">
                                <div class="pro-icon-box">
                                    <div class="icon-ring"></div>
                                    <i class="fas fa-sign-out-alt text-white fs-2"></i>
                                </div>
                            </div>
                            <div class="text-white opacity-75 small text-uppercase fw-bold mb-1">Clock Out
                            </div>
                            <div class="fs-2 fw-bold text-white mb-0 shift-time-display"
                                style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                {% if attendance and attendance.clock_out and not attendance.is_currently_clocked_in %}
                                {{ attendance.clock_out|time:"h:i A" }}
                                {% else %}
                                --:--
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if assigned_shift %}
                    <div class="shift-footer">
                        <!-- Break Information Section -->
                        <div>
                            <div class="small fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                                BREAKS</div>
                            {% if assigned_shift.breaks.all %}
                            {% for break_item in assigned_shift.breaks.all %}
                            <div class="fw-bold text-white" style="font-size: 0.85rem;">
                                {{ break_item.name }}: {{ break_item.start_time|time:"H:i" }} - {{ break_item.end_time|time:"H:i" }}
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="fw-bold text-white opacity-75" style="font-size: 0.85rem;">No breaks
                                configured
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="shift-footer">
                        <!-- Default Break Information -->
                        <div>
                            <div class="small fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                                BREAKS</div>
                            <div class="fw-bold text-white opacity-75" style="font-size: 0.85rem;">
                                Refreshment: 10:45 - 11:00<br>
                                Lunch Break: 13:00 - 13:45<br>
                                Evening Tea: 16:30 - 16:45
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Recent Activity Table -->
                <div class="keka-card animate-enter delay-200">
                    <div class="card-header-clean">
                        <span class="card-title-text"><i class="fas fa-list text-muted"></i> Attendance
                            Log</span>
                        <a href="{% url 'attendance_report' %}"
                            class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3">View All</a>
                    </div>
                    <div class="card-body-clean p-0">
                        <div class="table-responsive">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Check In</th>
                                        <th>Check Out</th>
                                        <th>Hours</th>
                                        <th>Status</th>
                                        <th class="text-center">
                                            <span class="d-none d-md-inline">Map</span>
                                            <span class="d-md-none"><i class="fas fa-map-marker-alt"></i></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for att in attendance_history|slice:":5" %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-dark">{{ att.date|date:"d M" }}</div>
                                            <div class="small text-muted">{{ att.date|date:"D" }}</div>
                                        </td>
                                        <td>
                                            {% if att.clock_in %}
                                            <div class="fw-bold text-dark">{{ att.clock_in|time:"h:i A" }}
                                            </div>
                                            {% else %}<span class="text-muted">-</span>{% endif %}
                                        </td>
                                        <td>
                                            {% if att.clock_out %}
                                            <div class="fw-bold text-dark">{{ att.clock_out|time:"h:i A" }}
                                            </div>
                                            {% else %}<span class="text-muted">-</span>{% endif %}
                                        </td>
                                        <td>
                                            <div class="fw-bold text-secondary">{{ att.effective_hours|default:"-" }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if att.status == 'PRESENT' %}
                                            <span class="status-badge status-present">Present</span>
                                            {% elif att.status == 'WFH' %}
                                            <span class="status-badge status-wfh">WFH</span>
                                            {% elif att.status == 'LEAVE' %}
                                            <span class="status-badge status-leave">Leave</span>
                                            {% elif att.status == 'WEEKLY_OFF' %}
                                            <span class="status-badge status-absent">Week Off</span>
                                            {% elif att.status == 'HOLIDAY' %}
                                            <span class="status-badge status-holiday">Holiday</span>
                                            {% elif att.status == 'MISSED' %}
                                            <span class="status-badge status-missed">Missed</span>
                                            {% elif att.status == 'NOT_LOGGED_IN' %}
                                            <span class="status-badge status-not-login">Not Login</span>
                                            {% else %}
                                            <span class="status-badge status-absent">{{
                                                att.status_display|default:att.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if att.location_in or att.location_out %}
                                            <a href="{% url 'attendance_map' att.id %}"
                                                class="btn btn-sm btn-light text-primary rounded-circle"
                                                style="width:32px;height:32px; display:flex;align-items:center;justify-content:center;"><i
                                                    class="fas fa-map-marker-alt"></i></a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">No records
                                            found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Right Column: Info & Widgets -->
        <div class="col-12 col-lg-3 order-2 order-lg-3">
            <div class="vstack gap-4">

                <!-- Working Days (Calendar visual) -->
                <div class="keka-card animate-enter delay-100">
                    <div class="card-body-clean">
                        <div class="text-label mb-3">This Week</div>
                        <div class="week-days">
                            <div class="day-badge">S</div>
                            <div class="day-badge active">M</div>
                            <div class="day-badge active">T</div>
                            <div class="day-badge active">W</div>
                            <div class="day-badge active">T</div>
                            <div class="day-badge active">F</div>
                            <div class="day-badge">S</div>
                        </div>
                    </div>
                </div>

                <!-- Today's Celebrations Widget -->
                <div class="keka-card animate-enter delay-150">
                    <div class="p-3"
                        style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="m-0 text-white fw-bold"><i class="fas fa-calendar-star me-2"></i>
                                Today's
                                Celebrations</h6>
                            <span class="badge bg-white text-dark">{{ today|date:"d M" }}</span>
                        </div>
                    </div>

                    <div class="p-0">
                        <div class="list-group list-group-flush">
                            <!-- Today's Birthdays -->
                            {% if todays_birthdays %}
                            {% for emp in todays_birthdays %}
                            <div class="list-group-item p-3 border-0 border-bottom">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0"
                                        style="width: 40px; height: 40px; background: #fce7f3; color: #db2777; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        {% if emp.profile_picture %}
                                        <img src="{{ emp.profile_picture.url }}" alt="{{ emp.user.get_full_name }}"
                                            style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                        <i class="fas fa-birthday-cake" style="font-size: 1rem;"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0 fw-bold text-dark">{{ emp.user.get_full_name }}</h6>
                                        <div class="text-muted small">Happy Birthday! 🎂</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}

                            <!-- Today's Work Anniversaries -->
                            {% if todays_anniversaries %}
                            {% for emp in todays_anniversaries %}
                            <div class="list-group-item p-3 border-0 border-bottom">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0"
                                        style="width: 40px; height: 40px; background: #fffbeb; color: #d97706; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        {% if emp.profile_picture %}
                                        <img src="{{ emp.profile_picture.url }}" alt="{{ emp.user.get_full_name }}"
                                            style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                        <i class="fas fa-medal" style="font-size: 1rem;"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0 fw-bold text-dark">{{ emp.user.get_full_name }}</h6>
                                        <div class="text-muted small">
                                            {% with years=emp.date_of_joining|timesince %}
                                            Work Anniversary 🌟
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}

                            {% if not todays_birthdays and not todays_anniversaries %}
                            <div class="text-center py-4 text-muted small">
                                No celebrations today
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Leave Balance Cards -->
                {% if leave_balance %}
                <div class="keka-card animate-enter delay-125">
                    <div class="card-header-clean">
                        <h6 class="card-title-text">
                            <div class="card-icon-soft primary"
                                style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            Leave Balance
                        </h6>
                    </div>
                    <div class="card-body-clean">
                        <!-- Casual Leave -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3"
                            style="background: rgba(99, 102, 241, 0.05); border-radius: 12px; border-left: 4px solid #6366f1;">
                            <div>
                                <div class="text-label mb-1">Casual Leave</div>
                                <div class="fw-bold text-primary" style="font-size: 1.25rem;">{{ leave_balance.casual_leave_balance|floatformat:1 }}</div>
                                <small class="text-muted">Days Available</small>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-mug-hot text-primary" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            </div>
                        </div>

                        <!-- Sick Leave -->
                        <div class="d-flex justify-content-between align-items-center p-3"
                            style="background: rgba(16, 185, 129, 0.05); border-radius: 12px; border-left: 4px solid #10b981;">
                            <div>
                                <div class="text-label mb-1">Sick Leave</div>
                                <div class="fw-bold text-success" style="font-size: 1.25rem;">{{ leave_balance.sick_leave_balance|floatformat:1 }}</div>
                                <small class="text-muted">Days Available</small>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-user-md text-success" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            </div>
                        </div>

                        <!-- Quick Apply Button -->
                        <div class="mt-3">
                            <a href="{% url 'my_leaves' %}" class="btn btn-primary w-100"
                                style="border-radius: 12px; padding: 12px;">
                                <i class="fas fa-plus me-2"></i>Apply for Leave
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if is_birthday or is_work_anniversary %}
                <!-- Overlay -->
                <div id="celebration-overlay">
                    <div class="text-center p-5 bg-white rounded-4 shadow-lg animate-enter" style="max-width: 500px;">
                        <div class="display-1 mb-3">&#127881;</div>
                        <h2 class="fw-bold text-primary mb-2">
                            {% if is_birthday %}Happy Birthday!{% elif is_work_anniversary %}Happy
                            Anniversary!{% endif %}
                        </h2>
                        <h4 class="fw-bold text-dark mb-4">{{ request.user.first_name }}</h4>
                        <p class="text-muted mb-4">Wishing you a fantastic day filled with joy and success!
                        </p>
                        <button class="btn btn-primary rounded-pill px-5 fw-bold"
                            onclick="document.getElementById('celebration-overlay').style.display='none'">Thank
                            You!</button>
                    </div>
                </div>
                {% endif %}
                <!-- Early Clock Out Confirmation Modal -->
                <div class="modal fade" id="clockOutConfirmModal" tabindex="-1" aria-hidden="true"
                    data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                            <div class="modal-header bg-warning bg-opacity-10 border-0 pt-4 px-4 pb-0">
                                <h5 class="modal-title fw-bold text-warning d-flex align-items-center gap-2">
                                    <i class="fas fa-exclamation-triangle"></i> Early Departure
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="mb-2">
                                        <span class="display-6 fw-bold text-dark" id="modal-remaining-hours">--</span>
                                        <span class="text-muted">hrs remaining</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success rounded-pill" role="progressbar"
                                            style="width: 0%" id="modal-progress-bar"></div>
                                    </div>
                                    <div class="d-flex justify-content-between small text-muted mt-1">
                                        <span id="modal-worked-hours">0h worked</span>
                                        <span id="modal-expected-hours">9h goal</span>
                                    </div>
                                </div>
                                <p class="text-muted text-center mb-0">
                                    You have not completed your full shift yet. Are you sure you want to
                                    clock out now?
                                </p>
                            </div>
                            <div class="modal-footer border-0 justify-content-center pb-4 bg-light">
                                <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-medium"
                                    data-bs-dismiss="modal" id="btn-cancel-clockout">Cancel</button>
                                <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold shadow-sm"
                                    id="btn-confirm-clockout">
                                    Yes, Clock Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Late Clock-In Warning Modal -->
                <div class="modal fade" id="lateWarningModal" tabindex="-1" aria-hidden="true"
                    data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                            <div class="modal-header border-0 pt-4 px-4 pb-0" id="late-modal-header">
                                <h5 class="modal-title fw-bold d-flex align-items-center gap-2" id="late-modal-title">
                                    <i class="fas fa-clock" id="late-modal-icon"></i> Late Arrival Warning
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="mb-3">
                                        <div class="display-1 mb-2" id="late-count-icon">⏰</div>
                                        <h4 class="fw-bold text-dark mb-2" id="late-warning-message">
                                            You have been late 0 times in the last 7 days.
                                        </h4>
                                    </div>
                                    <div class="alert mb-0" role="alert" id="late-action-alert">
                                        <strong>Action:</strong>
                                        <p class="mb-0 mt-2" id="late-action-text">Please ensure timely attendance to
                                            avoid LOP.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer border-0 justify-content-center pb-4 bg-light">
                                <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm"
                                    data-bs-dismiss="modal">
                                    I Understand
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    // Weekly Stats Scroll Indicator
    document.addEventListener('DOMContentLoaded', function () {
        const scrollContainer = document.querySelector('.weekly-stats-scroll-container');
        if (scrollContainer) {
            scrollContainer.addEventListener('scroll', function () {
                if (this.scrollLeft > 10) {
                    this.classList.add('scrolled');
                } else {
                    this.classList.remove('scrolled');
                }
            });
        }
    });

    // Clock
    function updateClock() {
        const now = new Date();
        const pageContext = document.getElementById('page-context');
        const userTimezone = pageContext ? pageContext.dataset.userTimezone : null;

        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' };

        if (userTimezone) {
            try {
                timeOptions.timeZone = userTimezone;
                dateOptions.timeZone = userTimezone;
            } catch (e) {
                console.error("Invalid timezone:", userTimezone);
            }
        }

        const timeString = now.toLocaleTimeString('en-US', timeOptions);
        const dateString = now.toLocaleDateString('en-US', dateOptions);

        document.getElementById('clock').innerText = timeString;
        document.getElementById('date-sub').innerText = dateString;

        // Header Date
        const headerDate = document.getElementById('header-date');
        if (headerDate) headerDate.innerText = dateString;

        // Update dynamic greeting based on time
        updateGreeting(now, userTimezone);
    }

    // Dynamic Greeting based on time of day
    function updateGreeting(now, userTimezone) {
        let hour = now.getHours();

        // If timezone is provided, we need to get the hour in that timezone
        if (userTimezone) {
            try {
                // Formatting to 24h format to parse the hour correctly in the target timezone
                const parts = new Intl.DateTimeFormat('en-US', {
                    hour: 'numeric',
                    hour12: false,
                    timeZone: userTimezone
                }).formatToParts(now);
                const hourPart = parts.find(p => p.type === 'hour');
                if (hourPart) {
                    hour = parseInt(hourPart.value, 10);
                }
            } catch (e) {
                console.error("Error calculating greeting hour:", e);
            }
        }

        const greetingElement = document.getElementById('dynamic-greeting');

        if (!greetingElement) return;

        let greeting;
        if (hour >= 5 && hour < 12) {
            greeting = 'Good Morning';
        } else if (hour >= 12 && hour < 17) {
            greeting = 'Good Afternoon';
        } else if (hour >= 17 && hour < 21) {
            greeting = 'Good Evening';
        } else {
            greeting = 'Good Night';
        }

        greetingElement.textContent = greeting;
    }

    setInterval(updateClock, 1000);
    updateClock();

    // Stats Ring Animation
    setTimeout(() => {
        // Mock calculation for circle progress (Max 8hrs = 100%)
        // stroke-dashoffset = 283 - (283 * percent / 100)
        const dataEl = document.getElementById('page-context');
        const avgHours = dataEl?.dataset.avgHours || "00:00"; // "HH:MM"
        const [h, m] = avgHours.split(':').map(Number);
        const decimalHours = h + (m / 60);
        const percent = Math.min((decimalHours / 9) * 100, 100); // 9 hours usually max

        const circle = document.getElementById('avg-progress');
        if (circle) {
            const offset = 283 - (283 * percent / 100);
            circle.style.strokeDashoffset = offset;
        }
    }, 500);

    // Active Day Highlight
    const currentDay = new Date().getDay(); // 0 = Sun, 1 = Mon...
    const dayBadges = document.querySelectorAll('.day-badge');
    if (dayBadges[currentDay]) {
        dayBadges.forEach(b => b.classList.remove('active'));
        dayBadges[currentDay].classList.add('active');
    }

    // Celebration Overlay
    const isBirthdayRaw = "{{ is_birthday|yesno:'true,false' }}";
    const isWorkAnniversaryRaw = "{{ is_work_anniversary|yesno:'true,false' }}";
    const isBirthday = isBirthdayRaw === "true";
    const isWorkAnniversary = isWorkAnniversaryRaw === "true";

    if (isBirthday || isWorkAnniversary) {
        setTimeout(() => {
            const ov = document.getElementById('celebration-overlay');
            if (ov) {
                ov.style.display = 'flex';
                ov.offsetHeight;
                ov.style.opacity = '1';
                ov.style.opacity = '1';
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
        }, 1000);
    }

    // Live Timer for clocked in
    {% if attendance.is_currently_clocked_in %}
    const dataEl = document.getElementById('page-context');
    // For timer, we want the CURRENT session start time, not the first clock-in of the day
    // We can rely on the fact that if we are clocked in, there is an active session.
    // However, data-clock-in in context might be the first clock in.
    // Let's rely on a calculated field or the generic attendance.clock_in if it matches.

    // We need to fetch the current session start time and previous duration.
    // Since we handle this in JS, we need these values in the DOM data attributes.
    // See the modification in the HTML above for data attributes.

    const currentSessionStartStr = "{{ attendance.get_current_session.clock_in.isoformat }}";
    const previousHours = parseFloat("{{ attendance.total_working_hours|default:0 }}");

    const clockInTime = new Date(currentSessionStartStr);

    function updateDuration() {
        if (!clockInTime) return;
        const now = new Date();
        const currentSessionDiff = now - clockInTime; // milliseconds

        if (currentSessionDiff < 0) {
            const timerEl = document.getElementById('timer-display');
            if (timerEl) timerEl.innerText = "00:00:00";
            return;
        }

        // Total duration = Previous Sessions (in ms) + Current Session (in ms)
        const totalMs = (previousHours * 3600 * 1000) + currentSessionDiff;

        const seconds = Math.floor((totalMs / 1000) % 60);
        const minutes = Math.floor((totalMs / (1000 * 60)) % 60);
        const hours = Math.floor((totalMs / (1000 * 60 * 60)));

        const formatted =
            String(hours).padStart(2, '0') + ':' +
            String(minutes).padStart(2, '0') + ':' +
            String(seconds).padStart(2, '0');

        const timerEl = document.getElementById('timer-display');
        if (timerEl) timerEl.innerText = formatted;

        // Update Total Today display with cumulative hours
        const totalHours = totalMs / (1000 * 60 * 60);
        const totalTodayEl = document.getElementById('total-today-display');
        if (totalTodayEl) {
            totalTodayEl.innerText = totalHours.toFixed(1) + ' hr';
        }
    }
    setInterval(updateDuration, 1000);
    updateDuration();
    {% endif %}

    // Clock Actions
    function handleClockAction(action, type, btnElement) {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser. Please use a mobile device with GPS for accurate attendance.");
            return;
        }

        // Get the button that was clicked
        const btn = btnElement || (event ? event.currentTarget : document.querySelector('.btn-clock'));
        const origText = btn.innerHTML;

        // Immediate feedback
        btn.innerHTML = '<span class="status-text me-2">Locating...</span> <i class="fas fa-satellite-dish fa-spin"></i>';
        btn.disabled = true;

        const csrfToken = document.getElementById('page-context')?.dataset.csrf || '';

        // --- STRICT LOCATION STRATEGY (Keka-like) ---
        // 1. Force High Accuracy
        // 2. Reject cached locations (maximumAge: 0)
        // 3. Continuous watching to let GPS 'settle'
        // 4. Strict thresholds: Aim for 20m, Reject > 100m

        let bestPosition = null;
        let watchId = null;

        const TARGET_ACCURACY = 100;      // Keka-like: Aim for high precision (100m)
        const ACCEPTABLE_ACCURACY = 3000; // Fallback: 3km (Desktops)
        const MAX_WAIT_TIME = 10000;       // increased timeout to 10s to allow slower GPS lock

        // Clean up function
        const stopLocationWatch = () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        };

        const finishLocationSearch = () => {
            stopLocationWatch();

            if (!bestPosition) {
                // If we have NO position after timeout, offer fallback options
                btn.innerHTML = origText;
                btn.disabled = false;

                // Show user-friendly options instead of blocking them
                const allowWithoutLocation = confirm(
                    "Could not acquire location signal. This may be due to:\n" +
                    "• GPS disabled on your device\n" +
                    "• Poor GPS signal\n" +
                    "• Browser location permissions denied\n\n" +
                    "Would you like to proceed without location tracking?\n" +
                    "(Your attendance will still be recorded, but without location data)"
                );

                if (allowWithoutLocation) {
                    // Proceed without location
                    submitClockRequest(null);
                } else {
                    alert("Please enable GPS/location services and try again.");
                }
                return;
            }

            const acc = bestPosition.coords.accuracy;

            // STRICT CHECK - REMOVED CONFIRMATION for speed
            // If acc > ACCEPTABLE_ACCURACY, we just log it but proceed to avoid blocking user

            // If good enough (or best we have), submit
            submitClockRequest(bestPosition);
        };

        const timeoutId = setTimeout(finishLocationSearch, MAX_WAIT_TIME);

        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 25000,
            maximumAge: 0
        };

        watchId = navigator.geolocation.watchPosition(
            (pos) => {
                const acc = Math.round(pos.coords.accuracy);
                // Real-time feedback implementation like precise apps
                // We show lat/long only if accuracy is decent, else just 'Acquiring'
                // Actually showing Lat/Long gives confidence.
                const lat = pos.coords.latitude.toFixed(5);
                const lng = pos.coords.longitude.toFixed(5);

                console.log(`GPS Update: Accuracy ${acc}m at ${lat},${lng}`);

                btn.innerHTML = `<div class="d-flex flex-column align-items-center" style="line-height:1.2">
                    <span style="font-size:0.85rem">Accuracy: ${acc}m</span>
                    <span style="font-size:0.7rem; opacity:0.8">${lat}, ${lng}</span>
                </div>`;

                // Logic to track best position
                if (!bestPosition || pos.coords.accuracy < bestPosition.coords.accuracy) {
                    bestPosition = pos;
                }

                // If we hit target (20m), stop immediately
                if (pos.coords.accuracy <= TARGET_ACCURACY) {
                    clearTimeout(timeoutId);
                    finishLocationSearch();
                }
            },
            (err) => {
                console.warn("GPS Error:", err.message);
                if (err.code === 1) { // PERMISSION_DENIED
                    clearTimeout(timeoutId);
                    stopLocationWatch();
                    btn.innerHTML = origText;
                    btn.disabled = false;

                    const allowWithoutLocation = confirm(
                        "Location access was denied. This may be due to:\n" +
                        "• Browser location permissions denied\n" +
                        "• Privacy settings blocking location access\n\n" +
                        "Would you like to proceed without location tracking?\n" +
                        "(Your attendance will still be recorded, but without location data)"
                    );

                    if (allowWithoutLocation) {
                        // Proceed without location
                        submitClockRequest(null);
                    } else {
                        alert("Please enable location permissions in your browser and try again.");
                    }
                }
            },
            geoOptions
        );

        function submitClockRequest(pos) {
            // Update status based on whether we have location or not
            if (pos) {
                const acc = Math.round(pos.coords.accuracy);
                btn.innerHTML = `<span class="status-text me-2">Verifying (${acc}m)...</span> <i class="fas fa-spinner fa-spin"></i>`;
            } else {
                btn.innerHTML = `<span class="status-text me-2">Processing...</span> <i class="fas fa-spinner fa-spin"></i>`;
            }

            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

            const requestData = {
                latitude: pos ? pos.coords.latitude : null,
                longitude: pos ? pos.coords.longitude : null,
                accuracy: pos ? pos.coords.accuracy : null,
                type: type,
                timezone: userTimezone
            };

            const apiUrl = action === 'in' ? "{% url 'api_clock_in' %}" : "{% url 'api_clock_out' %}";

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            })
                .then(r => {
                    if (!r.ok) {
                        return r.text().then(text => {
                            console.error("Server Error Detail:", text);
                            throw new Error(`Server Error: ${r.status} - ${text.substring(0, 150)}...`)
                        });
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Start or stop background location tracking based on action
                        if (action === 'in') {
                            // Starting work - enable background tracking
                            if (window.backgroundLocationTracker) {
                                const employeeId = '{{ request.user.employee_profile.id|default:"" }}';
                                const clockInTime = new Date().toISOString();
                                window.backgroundLocationTracker.startTracking(employeeId, clockInTime)
                                    .then(started => {
                                        if (started) {
                                            console.log('Background location tracking started successfully');
                                        } else {
                                            console.warn('Background location tracking could not be started');
                                        }
                                    });
                            }
                        } else if (action === 'out') {
                            // Clocking out - stop background tracking
                            if (window.backgroundLocationTracker) {
                                window.backgroundLocationTracker.stopTracking();
                                console.log('Background location tracking stopped');
                            }
                        }

                        // Check if there's a late warning to display
                        if (data.late_warning && data.late_warning.show_warning) {
                            // Show late warning modal
                            showLateWarningModal(data.late_warning);
                        } else {
                            // Success Animation
                            if (typeof confetti === 'function') {
                                confetti({
                                    particleCount: 150,
                                    spread: 70,
                                    origin: { y: 0.6 },
                                    colors: ['#6366f1', '#10b981', '#f59e0b']
                                });
                            }
                            location.reload();
                        }
                    }
                    else if (data.status === 'confirmation_required' || data.requires_confirmation) {
                        handleConfirmationModal(data, pos, csrfToken, btn, origText);
                    }
                    else if (data.already_clocked_in) {
                        alert(data.message || 'You are already clocked in.');
                        location.reload(); // Reload to sync UI with backend state
                    }
                    else {
                        alert(data.message || 'An error occurred');
                        btn.innerHTML = origText;
                        btn.disabled = false;
                    }
                })
                .catch((error) => {
                    console.error("Fetch Error:", error);
                    alert("Unable to connect to server: " + error.message);
                    btn.innerHTML = origText;
                    btn.disabled = false;
                });
        }

        // Helper for Confirmation Modal
        function handleConfirmationModal(data, pos, csrfToken, btn, origText) {
            try {
                const workedHours = data.worked_hours || 0;
                const expectedHours = data.expected_hours || 9;
                const remainingHours = (expectedHours - workedHours).toFixed(1);
                const percent = data.completion_percentage || 0;

                // Update Modal Content
                const remainEl = document.getElementById('modal-remaining-hours');
                if (remainEl) remainEl.innerText = remainingHours;

                const workedEl = document.getElementById('modal-worked-hours');
                if (workedEl) workedEl.innerText = workedHours + 'h worked';

                const expectEl = document.getElementById('modal-expected-hours');
                if (expectEl) expectEl.innerText = expectedHours + 'h goal';

                const progEl = document.getElementById('modal-progress-bar');
                if (progEl) progEl.style.width = percent + '%';

                // Try to show Bootstrap Modal
                const modalEl = document.getElementById('clockOutConfirmModal');
                let bsModal = null;

                if (modalEl && typeof bootstrap !== 'undefined') {
                    bsModal = new bootstrap.Modal(modalEl);
                    bsModal.show();

                    const confirmBtn = document.getElementById('btn-confirm-clockout');
                    const cancelBtn = document.getElementById('btn-cancel-clockout');

                    // Clean up previous listeners
                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    newCancelBtn.addEventListener('click', () => {
                        btn.innerHTML = origText;
                        btn.disabled = false;
                    });

                    // Handle modal close via X or click outside
                    modalEl.addEventListener('hidden.bs.modal', function () {
                        if (btn.disabled && btn.innerHTML.includes('Verifying')) {
                            // If we didn't confirm, reset button
                            btn.innerHTML = origText;
                            btn.disabled = false;
                        }
                    }, { once: true });

                    newConfirmBtn.addEventListener('click', () => {
                        bsModal.hide();
                        executeClockOut(true);
                    });
                } else {
                    // Fallback if modal/bootstrap fails
                    console.warn("Bootstrap modal not available, using fallback confirm");
                    const proceed = confirm(
                        `Early Departure Warning:\n` +
                        `You have ${remainingHours} hours remaining in your shift.\n` +
                        `Worked: ${workedHours}h / Goal: ${expectedHours}h\n\n` +
                        `Are you sure you want to clock out?`
                    );

                    if (proceed) {
                        executeClockOut(true);
                    } else {
                        btn.innerHTML = origText;
                        btn.disabled = false;
                    }
                }
            } catch (e) {
                console.error("Modal Error:", e);
                // Last ditch fallback
                if (confirm("You are leaving early. Continue to clock out?")) {
                    executeClockOut(true);
                } else {
                    btn.innerHTML = origText;
                    btn.disabled = false;
                }
            }

            function executeClockOut(force) {
                btn.innerHTML = '<span class="status-text me-2">Processing...</span> <i class="fas fa-spinner fa-spin"></i>';

                fetch("{% url 'api_clock_out' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        force_clockout: true,
                        accuracy: pos.coords.accuracy
                    })
                })
                    .then(r => r.json())
                    .then(data2 => {
                        if (data2.status === 'success') {
                            location.reload();
                        } else {
                            alert(data2.message);
                            btn.innerHTML = origText;
                            btn.disabled = false;
                        }
                    })
                    .catch((err) => {
                        console.error(err);
                        alert("Network error during clock out.");
                        btn.innerHTML = origText;
                        btn.disabled = false;
                    });
            }
        }
    }

    // Function to show late warning modal
    function showLateWarningModal(lateWarning) {
        const modal = document.getElementById('lateWarningModal');
        const modalHeader = document.getElementById('late-modal-header');
        const modalTitle = document.getElementById('late-modal-title');
        const modalIcon = document.getElementById('late-modal-icon');
        const messageEl = document.getElementById('late-warning-message');
        const actionAlert = document.getElementById('late-action-alert');
        const actionText = document.getElementById('late-action-text');
        const countIcon = document.getElementById('late-count-icon');

        // Update modal content
        messageEl.textContent = lateWarning.message;
        actionText.textContent = lateWarning.action;

        // Style based on severity
        if (lateWarning.severity === 'critical') {
            // Critical styling (5+ late arrivals)
            modalHeader.className = 'modal-header bg-danger bg-opacity-10 border-0 pt-4 px-4 pb-0';
            modalTitle.className = 'modal-title fw-bold text-danger d-flex align-items-center gap-2';
            modalIcon.className = 'fas fa-exclamation-triangle';
            actionAlert.className = 'alert alert-danger mb-0';
            countIcon.textContent = '🚨';
        } else {
            // Warning styling (1-4 late arrivals)
            modalHeader.className = 'modal-header bg-warning bg-opacity-10 border-0 pt-4 px-4 pb-0';
            modalTitle.className = 'modal-title fw-bold text-warning d-flex align-items-center gap-2';
            modalIcon.className = 'fas fa-clock';
            actionAlert.className = 'alert alert-warning mb-0';
            countIcon.textContent = '⏰';
        }

        // Show modal
        if (typeof bootstrap !== 'undefined') {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Reload page when modal is closed
            modal.addEventListener('hidden.bs.modal', function () {
                location.reload();
            }, { once: true });
        } else {
            // Fallback if Bootstrap is not available
            alert(lateWarning.message + '\n\n' + lateWarning.action);
            location.reload();
        }
    }

    // Timeline Animation Removed



    // --- Location Tracking Service ---

    // 3D Tilt Effect for Shift Card
    const card = document.querySelector('.shift-card');
    if (card) {
        card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            const rotateX = ((y - centerY) / centerY) * -5;
            const rotateY = ((x - centerX) / centerX) * 5;

            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
        });

        card.addEventListener('mouseleave', () => {
            card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
        });
    }

    // Staggered Week Days Animation
    const badges = document.querySelectorAll('.day-badge');
    badges.forEach((badge, index) => {
        badge.style.opacity = '0';
        badge.style.transform = 'translateY(10px)';
        badge.style.transition = 'all 0.3s ease-out';
        setTimeout(() => {
            badge.style.opacity = '1';
            badge.style.transform = 'translateY(0)';
        }, 500 + (index * 100)); // Start after initial load 500ms
    });

    // Pulse Effect for Active Day (CSS handled)

    // Hourly Location Tracking
    let locationTrackingInterval;

    function startLocationTracking() {
        // Check location tracking status immediately
        checkLocationTrackingStatus();

        // Set up interval to check every 1 minute (to catch hourly marks precisely)
        locationTrackingInterval = setInterval(checkLocationTrackingStatus, 60000); // 1 minute
    }

    function checkLocationTrackingStatus() {
        fetch("{% url 'api_location_tracking_status' %}", {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.needs_location) {
                    requestLocationUpdate();
                } else if (data.tracking_stopped) {
                    // Server says stop (9 hours done)
                    console.log("Tracking stopped by server: " + data.message);
                    if (locationTrackingInterval) {
                        clearInterval(locationTrackingInterval);
                    }
                }
            })
            .catch(error => {
                console.log('Location tracking status check failed:', error);
            });
    }

    function requestLocationUpdate() {
        if (!navigator.geolocation) {
            console.log('Geolocation not supported');
            return;
        }

        // Show a subtle notification
        showLocationUpdateNotification();

        navigator.geolocation.getCurrentPosition(
            (position) => {
                submitHourlyLocation(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
            },
            (error) => {
                console.log('Location access denied or failed:', error);
                // Still try to submit with null coordinates to mark the attempt
                submitHourlyLocation(null, null, null);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
            }
        );
    }

    function submitHourlyLocation(lat, lng, accuracy) {
        const requestData = {
            latitude: lat,
            longitude: lng,
            accuracy: accuracy
        };

        fetch("{% url 'api_submit_hourly_location' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Hourly location updated successfully');
                    hideLocationUpdateNotification();
                } else if (data.status === 'tracking_stopped') {
                    console.log("Tracking stopped during submission: " + data.message);
                    hideLocationUpdateNotification();
                    if (locationTrackingInterval) clearInterval(locationTrackingInterval);
                } else {
                    console.log('Location update failed:', data.message);
                }
            })
            .catch(error => {
                console.log('Location update error:', error);
            });
    }

    function showLocationUpdateNotification() {
        // Create or show a subtle notification
        let notification = document.getElementById('location-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'location-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #6366f1; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px;">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    Updating location for attendance tracking...
                </div>
            `;
            document.body.appendChild(notification);
        }
        notification.style.display = 'block';
    }

    function hideLocationUpdateNotification() {
        const notification = document.getElementById('location-notification');
        if (notification) {
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }
    }

    // Start location tracking when page loads (only if user is clocked in)
    {% if attendance and attendance.is_currently_clocked_in %}
    document.addEventListener('DOMContentLoaded', function () {
        startLocationTracking();
    });
    {% endif %}

    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function () {
        if (locationTrackingInterval) {
            clearInterval(locationTrackingInterval);
        }
    });

    // Enhanced Mobile Table Experience
    document.addEventListener('DOMContentLoaded', function () {
        const tableResponsive = document.querySelector('.table-responsive');

        if (tableResponsive && window.innerWidth <= 768) {
            let scrollTimeout;

            // Hide swipe indicator after user scrolls
            tableResponsive.addEventListener('scroll', function () {
                this.classList.add('scrolled');

                // Clear existing timeout
                clearTimeout(scrollTimeout);

                // Show indicator again after 3 seconds of no scrolling
                scrollTimeout = setTimeout(() => {
                    this.classList.remove('scrolled');
                }, 3000);
            });

            // Add touch feedback for better mobile experience
            const tableRows = tableResponsive.querySelectorAll('tr');
            tableRows.forEach(row => {
                row.addEventListener('touchstart', function () {
                    this.style.backgroundColor = 'rgba(99, 102, 241, 0.05)';
                }, { passive: true });

                row.addEventListener('touchend', function () {
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 150);
                }, { passive: true });
            });

            // Auto-hide swipe indicator after 5 seconds
            setTimeout(() => {
                tableResponsive.classList.add('scrolled');
            }, 5000);
        }
    });

</script>
{% endblock %}