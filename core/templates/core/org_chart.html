{% extends 'core/base.html' %}
{% load static %}

{% block title %}Organisation Structure | {{ company.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Advanced Keka-Style Org Chart CSS */
    .org-container {
        padding: 40px 20px;
        background-color: #f8fafc;
        min-height: 80vh;
        overflow-x: auto;
        text-align: center;
        background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* The Tree */
    .tree {
        display: inline-block;
        margin: 0 auto;
        white-space: nowrap;
    }

    .tree ul {
        padding-top: 20px;
        position: relative;
        transition: all 0.5s;
        display: flex;
        justify-content: center;
    }

    .tree li {
        float: left;
        text-align: center;
        list-style-type: none;
        position: relative;
        padding: 20px 5px 0 5px;
        transition: all 0.5s;
    }

    /* Connectors */
    .tree li::before,
    .tree li::after {
        content: '';
        position: absolute;
        top: 0;
        right: 50%;
        border-top: 2px solid #cbd5e0;
        width: 50%;
        height: 20px;
    }

    .tree li::after {
        right: auto;
        left: 50%;
        border-left: 2px solid #cbd5e0;
    }

    /* Remove connectors from root */
    .tree li:only-child::after,
    .tree li:only-child::before {
        display: none;
    }

    .tree li:only-child {
        padding-top: 0;
    }

    .tree li:first-child::before,
    .tree li:last-child::after {
        border: 0 none;
    }

    .tree li:last-child::before {
        border-right: 2px solid #cbd5e0;
        border-radius: 0 5px 0 0;
    }

    .tree li:first-child::after {
        border-radius: 5px 0 0 0;
    }

    /* Downward lines from parents */
    .tree ul ul::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        border-left: 2px solid #cbd5e0;
        width: 0;
        height: 20px;
    }

    /* The Employee Card */
    .node-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        width: 220px;
        display: inline-block;
        text-decoration: none;
        color: #2d3748;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 2;
    }

    .node-card:hover {
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
        border-color: #3182ce;
    }

    /* Avatar */
    .node-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        overflow: hidden;
        border: 3px solid #f0f4f8;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #ebf8ff;
        color: #3182ce;
        font-size: 1.5rem;
    }

    .node-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .node-name {
        font-weight: 700;
        font-size: 0.95rem;
        margin-bottom: 2px;
        white-space: normal;
        /* Allow wrap */
    }

    .node-role {
        font-size: 0.8rem;
        color: #718096;
        margin-bottom: 8px;
        white-space: normal;
    }

    .node-dept {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background-color: #edf2f7;
        padding: 4px 8px;
        border-radius: 4px;
        color: #4a5568;
        font-weight: 600;
    }

    /* Toggle Button for collapsing (JS needed) */
    .node-toggler {
        position: absolute;
        bottom: -12px;
        left: 50%;
        transform: translateX(-50%);
        width: 24px;
        height: 24px;
        background-color: #fff;
        border: 1px solid #cbd5e0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #718096;
        z-index: 3;
        transition: all 0.2s;
    }

    .node-toggler:hover {
        background-color: #3182ce;
        color: white;
        border-color: #3182ce;
    }

    .node-toggled .node-toggler i {
        transform: rotate(180deg);
    }

    .collapsed>ul {
        display: none !important;
    }

    .collapsed>.node-card .node-toggler i {
        transform: rotate(180deg);
        /* Or change icon */
    }
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center bg-white p-4 border-bottom shadow-sm">
        <div>
            <h4 class="fw-bold m-0 text-dark">Organisation Hierarchy</h4>
            <p class="text-muted small m-0">
                Visualizing reporting structures for {{ company.name }}
                {% if department_filter %}
                <span class="badge bg-primary ms-2">{{ department_filter }} Department</span>
                {% endif %}
            </p>
        </div>
        <div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">Expand All</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">Collapse All</button>
            </div>
        </div>
    </div>

    <div class="org-container custom-scrollbar">
        <div class="tree">
            <ul>
                <!-- Recursive Rendering Macro/Include would be ideal, but looping is fine for root -->
                {% for root in roots %}
                {% include "core/org_node.html" with node=root %}
                {% empty %}
                <li>
                    <div class="node-card p-5">
                        <div class="text-muted">No employees found in structure.</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    function toggleNode(btn) {
        const li = btn.closest('li');
        li.classList.toggle('collapsed');
        const icon = btn.querySelector('i');
        if (li.classList.contains('collapsed')) {
            icon.classList.remove('fa-minus');
            icon.classList.add('fa-plus');
        } else {
            icon.classList.remove('fa-plus');
            icon.classList.add('fa-minus');
        }
    }

    function expandAll() {
        document.querySelectorAll('li.collapsed').forEach(li => {
            li.classList.remove('collapsed');
            const icon = li.querySelector('.node-toggler i');
            if (icon) {
                icon.classList.remove('fa-plus');
                icon.classList.add('fa-minus');
            }
        });
    }

    function collapseAll() {
        document.querySelectorAll('.tree li').forEach(li => {
            // Don't collapse root
            if (li.closest('ul').parentNode.className !== 'tree') {
                li.classList.add('collapsed');
                const icon = li.querySelector('.node-toggler i');
                if (icon) {
                    icon.classList.remove('fa-minus');
                    icon.classList.add('fa-plus');
                }
            }
        });
    }
</script>
{% endblock %}