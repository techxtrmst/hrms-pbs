{% extends 'core/base.html' %}
{% load static %}

{% block title %}Attendance Report {{ month_name }} {{ year }} | Petabytz{% endblock %}

{% block extra_css %}
<style>
    /* Table Styling for Large Data */
    .report-container {
        background-color: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

    .table-responsive-custom {
        overflow-x: auto;
        position: relative;
    }

    .table-report {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .table-report th,
    .table-report td {
        padding: 10px 12px;
        border: 1px solid #edf2f7;
        text-align: center;
    }

    .table-report th {
        background-color: #f7fafc;
        color: #4a5568;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Fixed first column (Name) */
    .table-report th:nth-child(1),
    .table-report td:nth-child(1),
    .table-report th:nth-child(2),
    .table-report td:nth-child(2) {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 5;
        border-right: 2px solid #e2e8f0;
    }

    .table-report th:nth-child(2),
    .table-report td:nth-child(2) {
        left: 80px;
        /* Adjust based on first column width */
    }

    .table-report th:nth-child(1),
    .table-report th:nth-child(2) {
        z-index: 12;
        /* Higher than normal headers */
        background-color: #f7fafc;
    }

    /* Status Colors */
    .status-p {
        color: #38a169;
        font-weight: bold;
        background-color: #f0fff4;
    }

    .status-a {
        color: #e53e3e;
        font-weight: bold;
        background-color: #fff5f5;
    }

    .status-l {
        color: #dd6b20;
        font-weight: bold;
        background-color: #fffaf0;
    }

    .status-wfh {
        color: #805ad5;
        font-weight: bold;
        background-color: #faf5ff;
    }

    .status-hd {
        color: #d69e2e;
        font-weight: bold;
        background-color: #fefcbf;
    }

    .status-od {
        color: #3182ce;
        font-weight: bold;
        background-color: #ebf8ff;
    }

    .status-wo {
        color: #718096;
        font-weight: bold;
        background-color: #f7fafc;
    }

    .status-h {
        color: #38b2ac;
        font-weight: bold;
        background-color: #e6fffa;
    }

    .status-mp {
        color: #c53030;
        font-weight: bold;
        background-color: #fed7d7;
    }

    .status-hy {
        color: #6b46c1;
        font-weight: bold;
        background-color: #f3f4f6;
    }

    .text-purple {
        color: #805ad5 !important;
    }

    /* Sticky column adjustments for more columns */
    .table-report th:nth-child(2),
    .table-report td:nth-child(2) {
        left: 100px; /* Adjust based on first column width */
    }

    /* Legend */
    .legend {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }

    .legend-item {
        display: inline-block;
        margin: 5px 10px;
        font-size: 0.85rem;
    }

    .legend-color {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 3px;
        margin-right: 5px;
        vertical-align: middle;
    }

    .action-bar {
        background-color: #fff;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-form select {
        padding: 6px 12px;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark m-0">Detailed Attendance Report</h4>
            <p class="text-muted small m-0 mt-1">Payroll Cycle: {{ cycle_label }}</p>
        </div>
        <div>
            <a href="{% url 'download_attendance' %}?month={{ month }}&year={{ year }}{% if location_filter %}&location={{ location_filter }}{% endif %}"
                class="btn btn-success">
                <i class="fas fa-file-excel me-2"></i> Export to Excel
            </a>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="action-bar">
        <form method="get" class="filter-form d-flex align-items-center">
            <label class="me-2 fw-bold text-secondary">Period:</label>
            <select name="month">
                <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
                <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
                <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
                <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
                <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
                <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
                <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
                <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
                <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
                <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
                <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
                <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
            </select>
            <select name="year">
                <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if year == 2026 %}selected{% endif %}>2026</option>
            </select>
            <select name="location">
                <option value="">All Locations</option>
                {% for loc in locations %}
                <option value="{{ loc.id }}" {% if location_filter == loc.id %}selected{% endif %}>{{ loc.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
        </form>
    </div>

    <!-- Legend -->
    <div class="legend">
        <h6 class="fw-bold mb-3">Status Legend:</h6>
        <div class="row">
            <div class="col-md-6">
                <div class="legend-item">
                    <span class="legend-color status-p"></span> P - Present (includes WFH)
                </div>
                <div class="legend-item">
                    <span class="legend-color status-a"></span> A - Absent
                </div>
                <div class="legend-item">
                    <span class="legend-color status-l"></span> L - Leave
                </div>
            </div>
            <div class="col-md-6">
                <div class="legend-item">
                    <span class="legend-color status-hd"></span> HD - Half Day
                </div>
                <div class="legend-item">
                    <span class="legend-color status-wo"></span> WO - Weekly Off
                </div>
                <div class="legend-item">
                    <span class="legend-color status-h"></span> H - Holiday
                </div>
            </div>
        </div>
    </div>

    <div class="report-container">
        <div class="table-responsive-custom">
            <table class="table-report">
                <thead>
                    <tr>
                        <th style="min-width: 100px;">ID</th>
                        <th style="min-width: 150px;">Employee</th>
                        <th class="text-center" title="Present Days (includes WFH)">P</th>
                        <th class="text-center" title="Absent Days">A</th>
                        <th class="text-center" title="Leave Days">L</th>
                        <th class="text-center" title="Half Day">HD</th>
                        <th class="text-center" title="Weekly Off">WO</th>
                        <th class="text-center" title="Holiday">H</th>
                        <th class="text-center" title="Working Days">WD</th>
                        <th class="text-center" title="Attendance %">%</th>
                        {% for day_info in days_display %}
                        <th class="text-center" style="min-width: 50px;">
                            {{ day_info.day }}<br>
                            <small style="font-size: 10px;">{{ day_info.month_short }}</small>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in reports %}
                    <tr>
                        <td>{{ item.employee.badge_id }}</td>
                        <td>
                            <div class="fw-bold">{{ item.employee.user.get_full_name }}</div>
                            <div class="text-muted small" style="font-size: 0.75rem;">{{ item.employee.designation }}
                            </div>
                        </td>
                        <td class="bg-light text-success fw-bold">{{ item.stats.present }}</td>
                        <td class="bg-light text-danger fw-bold">{{ item.stats.absent }}</td>
                        <td class="bg-light text-warning fw-bold">{{ item.stats.leave }}</td>
                        <td class="bg-light text-warning fw-bold">{{ item.stats.half_day }}</td>
                        <td class="bg-light text-secondary fw-bold">{{ item.stats.weekly_off }}</td>
                        <td class="bg-light text-primary fw-bold">{{ item.stats.holiday }}</td>
                        <td class="bg-light text-dark fw-bold">{{ item.working_days }}</td>
                        <td class="bg-light fw-bold {% if item.attendance_percentage >= 90 %}text-success{% elif item.attendance_percentage >= 75 %}text-warning{% else %}text-danger{% endif %}">
                            {{ item.attendance_percentage }}%
                        </td>

                        {% for status in item.days %}
                        <td
                            class="{% if status == 'P' %}status-p{% elif status == 'A' %}status-a{% elif status == 'L' %}status-l{% elif status == 'HD' %}status-hd{% elif status == 'WO' %}status-wo{% elif status == 'H' %}status-h{% endif %}">
                            {{ status }}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    
                    <!-- Summary Row -->
                    <tr class="table-info fw-bold">
                        <td colspan="2" class="text-center">TOTAL ({{ total_employees }} employees)</td>
                        <td class="text-success">{{ total_stats.present }}</td>
                        <td class="text-danger">{{ total_stats.absent }}</td>
                        <td class="text-warning">{{ total_stats.leave }}</td>
                        <td class="text-warning">{{ total_stats.half_day }}</td>
                        <td class="text-secondary">{{ total_stats.weekly_off }}</td>
                        <td class="text-primary">{{ total_stats.holiday }}</td>
                        <td colspan="2" class="text-center">-</td>
                        {% for day_info in days_display %}
                        <td>-</td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}