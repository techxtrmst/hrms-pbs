{% extends 'core/base.html' %}
{% load static %}

{% block title %}Attendance Report {{ month_name }} {{ year }} | Petabytz{% endblock %}

{% block extra_css %}
<style>
    /* Table Styling for Large Data */
    .report-container {
        background-color: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

    .table-responsive-custom {
        overflow-x: auto;
        position: relative;
    }

    .table-report {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .table-report th,
    .table-report td {
        padding: 10px 12px;
        border: 1px solid #edf2f7;
        text-align: center;
    }

    .table-report th {
        background-color: #f7fafc;
        color: #4a5568;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Fixed first column (Name) */
    .table-report th:nth-child(1),
    .table-report td:nth-child(1),
    .table-report th:nth-child(2),
    .table-report td:nth-child(2) {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 5;
        border-right: 2px solid #e2e8f0;
    }

    .table-report th:nth-child(2),
    .table-report td:nth-child(2) {
        left: 80px;
        /* Adjust based on first column width */
    }

    .table-report th:nth-child(1),
    .table-report th:nth-child(2) {
        z-index: 12;
        /* Higher than normal headers */
        background-color: #f7fafc;
    }

    /* Status Colors */
    .status-p {
        color: #38a169;
        font-weight: bold;
        background-color: #f0fff4;
    }

    .status-a {
        color: #e53e3e;
        font-weight: bold;
        background-color: #fff5f5;
    }

    .status-l {
        color: #dd6b20;
        font-weight: bold;
        background-color: #fffaf0;
    }

    .status-wfh {
        color: #805ad5;
        font-weight: bold;
        background-color: #faf5ff;
    }

    .action-bar {
        background-color: #fff;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-form select {
        padding: 6px 12px;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark m-0">Detailed Attendance Report</h4>
            <p class="text-muted small m-0 mt-1">Payroll Cycle: {{ cycle_label }}</p>
        </div>
        <div>
            <a href="{% url 'download_attendance' %}?month={{ month }}&year={{ year }}{% if location_filter %}&location={{ location_filter }}{% endif %}"
                class="btn btn-success">
                <i class="fas fa-file-excel me-2"></i> Export to Excel
            </a>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="action-bar">
        <form method="get" class="filter-form d-flex align-items-center">
            <label class="me-2 fw-bold text-secondary">Period:</label>
            <select name="month">
                <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
                <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
                <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
                <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
                <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
                <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
                <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
                <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
                <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
                <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
                <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
                <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
            </select>
            <select name="year">
                <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
            </select>
            <select name="location">
                <option value="">All Locations</option>
                {% for loc in locations %}
                <option value="{{ loc.id }}" {% if location_filter == loc.id %}selected{% endif %}>{{ loc.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
        </form>
    </div>

    <div class="report-container">
        <div class="table-responsive-custom">
            <table class="table-report">
                <thead>
                    <tr>
                        <th style="min-width: 100px;">ID</th>
                        <th style="min-width: 150px;">Employee</th>
                        <th class="text-center">Present</th>
                        <th class="text-center">Absent</th>
                        <th class="text-center">Leave</th>
                        {% for day_info in days_display %}
                        <th class="text-center" style="min-width: 50px;">
                            {{ day_info.day }}<br>
                            <small style="font-size: 10px;">{{ day_info.month_short }}</small>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in reports %}
                    <tr>
                        <td>{{ item.employee.badge_id }}</td>
                        <td>
                            <div class="fw-bold">{{ item.employee.user.get_full_name }}</div>
                            <div class="text-muted small" style="font-size: 0.75rem;">{{ item.employee.designation }}
                            </div>
                        </td>
                        <td class="bg-light text-success fw-bold">{{ item.stats.present }}</td>
                        <td class="bg-light text-danger fw-bold">{{ item.stats.absent }}</td>
                        <td class="bg-light text-warning fw-bold">{{ item.stats.leave }}</td>

                        {% for status in item.days %}
                        <td
                            class="{% if status  ==  'P' %}status-p{% elif status  ==  'A' %}status-a{% elif status  ==  'L' %}status-l{% elif status  ==  'WFH' %}status-wfh{% endif %}">
                            {{ status }}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}