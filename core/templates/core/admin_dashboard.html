{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard | Admin{% endblock %}

{% block extra_css %}
<style>
    :root {
        --keka-primary: #5b47fb;
        --keka-success: #00c48c;
        --keka-danger: #ff647c;
        --keka-warning: #ffa26b;
        --keka-info: #4da6ff;
        --keka-purple: #9b7dff;
        --keka-teal: #4fd1c5;
        --keka-bg: #f7f8fc;
        --keka-card: #ffffff;
        --keka-border: #e8ecf4;
        --keka-text-primary: #1e2139;
        --keka-text-secondary: #6c7293;
    }

    body {
        background: var(--keka-bg);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dashboard-header {
        background: white;
        padding: 20px 32px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--keka-border);
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--keka-text-primary);
        margin: 0;
    }

    .filter-bar {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .filter-select {
        padding: 8px 16px;
        border: 1.5px solid var(--keka-border);
        border-radius: 8px;
        font-size: 14px;
        background: white;
        color: var(--keka-text-primary);
    }

    /* Employee Search Bar Styles */
    .employee-search-container {
        margin-top: 20px;
        margin-bottom: 16px;
        max-width: 600px;
    }

    .search-wrapper {
        position: relative;
        width: 100%;
    }

    .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--keka-text-secondary);
        font-size: 16px;
        pointer-events: none;
        z-index: 1;
    }

    .employee-search-input {
        width: 100%;
        padding: 12px 16px 12px 48px;
        border: 2px solid var(--keka-border);
        border-radius: 12px;
        font-size: 15px;
        background: white;
        color: var(--keka-text-primary);
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }

    .employee-search-input:focus {
        outline: none;
        border-color: var(--keka-primary);
        box-shadow: 0 0 0 4px rgba(91, 71, 251, 0.1);
    }

    .employee-search-input::placeholder {
        color: var(--keka-text-secondary);
        opacity: 0.6;
    }

    .search-results {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--keka-border);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .search-result-item {
        padding: 14px 18px;
        border-bottom: 1px solid var(--keka-border);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: linear-gradient(90deg, rgba(91, 71, 251, 0.05) 0%, rgba(91, 71, 251, 0.02) 100%);
        padding-left: 22px;
    }

    .search-result-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--keka-primary), var(--keka-purple));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        flex-shrink: 0;
    }

    .search-result-details {
        flex: 1;
        min-width: 0;
    }

    .search-result-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--keka-text-primary);
        margin-bottom: 4px;
    }

    .search-result-meta {
        font-size: 13px;
        color: var(--keka-text-secondary);
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .search-result-meta span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .search-result-meta i {
        font-size: 11px;
        opacity: 0.7;
    }

    .search-no-results {
        padding: 32px 20px;
        text-align: center;
        color: var(--keka-text-secondary);
    }

    .search-no-results i {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    .search-loading {
        padding: 20px;
        text-align: center;
        color: var(--keka-text-secondary);
    }

    .search-loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Scrollbar Styling for Search Results */
    .search-results::-webkit-scrollbar {
        width: 6px;
    }

    .search-results::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .search-results::-webkit-scrollbar-thumb {
        background: var(--keka-primary);
        border-radius: 10px;
    }

    .search-results::-webkit-scrollbar-thumb:hover {
        background: #4a38ca;
    }


    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .stat-card.purple {
        border-left-color: var(--keka-purple);
    }

    .stat-card.green {
        border-left-color: var(--keka-success);
    }

    .stat-card.orange {
        border-left-color: var(--keka-warning);
    }

    .stat-card.blue {
        border-left-color: var(--keka-info);
    }

    .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: var(--keka-text-primary);
        margin-bottom: 4px;
        animation: countUp 0.5s ease-out;
    }

    @keyframes countUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stat-label {
        font-size: 13px;
        color: var(--keka-text-secondary);
        font-weight: 500;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--keka-text-primary);
        margin-bottom: 16px;
    }

    .requests-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .request-card {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        border: 1.5px solid var(--keka-border);
        border-radius: 12px;
        margin-bottom: 12px;
        transition: all 0.2s;
        gap: 12px;
        flex-wrap: wrap;
    }

    .request-card:hover {
        border-color: var(--keka-primary);
        box-shadow: 0 4px 12px rgba(91, 71, 251, 0.1);
    }

    .employee-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--keka-primary), var(--keka-purple));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 16px;
        flex-shrink: 0;
        margin-right: 0;
    }

    .request-info {
        flex: 1;
        min-width: 140px;
    }

    .employee-name {
        font-size: 14px;
        font-weight: 700;
        color: var(--keka-text-primary);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
    }

    .request-meta {
        font-size: 12px;
        color: var(--keka-text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .leave-badge {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 700;
        white-space: nowrap;
        vertical-align: middle;
        text-transform: uppercase;
        margin-left: 0;
    }

    .leave-badge.medical {
        background: #fef3c7;
        color: #92400e;
    }

    .leave-badge.personal {
        background: #dbeafe;
        color: #1e40af;
    }

    .leave-badge.sick {
        background: #fee2e2;
        color: #991b1b;
    }

    .request-actions {
        display: flex;
        gap: 6px;
        align-self: center;
        margin-left: auto;
    }

    .btn-action {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-reject {
        background: #fee2e2;
        color: #991b1b;
    }

    .btn-reject:hover {
        background: #fecaca;
    }

    .btn-approve {
        background: #d1fae5;
        color: #065f46;
    }

    .btn-approve:hover {
        background: #a7f3d0;
    }

    .calendar-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .month-nav {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .month-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: var(--keka-bg);
        color: var(--keka-text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .month-btn:hover {
        background: var(--keka-primary);
        color: white;
    }

    .month-label {
        font-size: 16px;
        font-weight: 600;
        color: var(--keka-text-primary);
    }

    .calendar-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
    }

    .calendar-table thead th {
        font-size: 11px;
        font-weight: 600;
        color: var(--keka-text-secondary);
        text-align: center;
        padding: 8px 4px;
        text-transform: uppercase;
    }

    .calendar-table tbody td {
        padding: 4px 2px;
    }

    .employee-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .employee-info {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 180px;
    }

    .employee-mini-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--keka-primary), var(--keka-purple));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .employee-details {
        flex: 1;
    }

    .employee-details-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--keka-text-primary);
    }

    .day-cell {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin: 0 auto;
        transition: all 0.2s;
        cursor: pointer;
    }

    .day-cell:hover {
        transform: scale(1.1);
    }

    .day-cell.wfh,
    .day-cell.present {
        background: transparent;
        color: var(--keka-text-primary);
        border: 1px solid #e5e7eb;
    }

    .day-cell.weekly-off {
        background: var(--keka-warning);
        color: white;
    }

    .day-cell.paid-leave,
    .day-cell.sick-leave {
        background: #dc2626;
        /* Red for all leaves */
        color: white;
    }

    .day-cell.no-attendance {
        background: #7c3aed;
        /* Purple for LOP */
        color: white;
    }

    .day-cell.holiday {
        background: var(--keka-info);
        color: white;
    }

    .day-cell.future {
        background: transparent;
        color: var(--keka-text-secondary);
        opacity: 0.4;
    }

    .day-cell.no-data {
        background: #f3f4f6;
        color: var(--keka-text-secondary);
        border: 1px dashed #d1d5db;
    }

    .legend {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--keka-text-secondary);
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--keka-text-secondary);
    }

    .refresh-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--keka-success);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Improved Announcements Widget */
    .announcements-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 400px;
        max-height: 600px;
    }

    .announcements-header {
        background: linear-gradient(135deg, var(--keka-primary), #4338ca);
        padding: 20px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .announcements-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .announcements-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .tab-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        backdrop-filter: blur(5px);
        white-space: nowrap;
        min-height: 32px;
        display: flex;
        align-items: center;
    }

    .tab-btn.active,
    .tab-btn:hover {
        background: white;
        color: var(--keka-primary);
        font-weight: 600;
    }

    .announcements-body {
        padding: 0;
        flex: 1;
        overflow: hidden;
        min-height: 300px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    /* Scrollable Announcement Content */
    .announcement-carousel {
        height: 100%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .announcement-slide {
        height: 100%;
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .announcement-slide:not(.d-none) {
        opacity: 1;
        transform: translateX(0);
        position: relative;
    }

    .announcement-content-wrapper {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
    }

    .announcement-content-wrapper::-webkit-scrollbar {
        width: 6px;
    }

    .announcement-content-wrapper::-webkit-scrollbar-track {
        background: transparent;
    }

    .announcement-content-wrapper::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }

    .announcement-content-wrapper::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
    }

    /* Tab Content Scrolling */
    .tab-content {
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
    }

    .tab-content::-webkit-scrollbar {
        width: 6px;
    }

    .tab-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .tab-content::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }

    .tab-content::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
    }

    .announcement-item {
        display: flex;
        align-items: flex-start;
        padding: 16px 20px;
        border-bottom: 1px solid var(--keka-border);
        transition: background 0.2s;
        min-height: 80px;
    }

    .announcement-item:last-child {
        border-bottom: none;
    }

    .announcement-item:hover {
        background: #fdfdfd;
    }

    .announcement-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-right: 16px;
        flex-shrink: 0;
    }

    .announcement-details {
        flex: 1;
        min-width: 0;
    }

    .announcement-text {
        font-size: 14px;
        font-weight: 600;
        color: var(--keka-text-primary);
        margin-bottom: 2px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .announcement-subtext {
        font-size: 12px;
        color: var(--keka-text-secondary);
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .announcement-date {
        font-size: 12px;
        font-weight: 600;
        color: var(--keka-primary);
        background: rgba(91, 71, 251, 0.08);
        padding: 4px 10px;
        border-radius: 8px;
        white-space: nowrap;
        flex-shrink: 0;
        margin-left: 12px;
        align-self: flex-start;
    }

    /* Horizontal Scrolling for Tabs on Mobile */
    .announcements-tabs-wrapper {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .announcements-tabs-wrapper::-webkit-scrollbar {
        display: none;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 40px;
        text-align: center;
        color: var(--keka-text-secondary);
    }

    .empty-state i {
        font-size: 32px;
        margin-bottom: 16px;
        opacity: 0.3;
    }

    /* Animation */
    .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Animation End */

    /* Maximize & Scrollable Calendar */
    .calendar-section {
        transition: all 0.3s ease;
        position: relative;
        background: white;
    }

    .calendar-section.maximized {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1050;
        /* Above navbar */
        border-radius: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        padding: 24px;
        overflow: hidden;
        /* Prevent body scroll, container handles it */
    }

    .calendar-section.maximized .calendar-scroll-area {
        height: 100%;
        max-height: calc(100vh - 140px);
        /* Adjust for header/legend space */
    }

    .calendar-scroll-area {
        overflow: auto;
        max-height: 500px;
        /* Default height constraint */
        border: 1px solid var(--keka-border);
        border-radius: 8px;
        position: relative;
    }

    /* Stick Headers */
    .calendar-table thead th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 20;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid var(--keka-border);
    }

    /* Sticky Name Column */
    .calendar-table td:first-child,
    .calendar-table th:first-child {
        position: sticky;
        left: 0;
        background: white;
        z-index: 21;
        box-shadow: 2px 0 2px -1px rgba(0, 0, 0, 0.1);
    }

    .calendar-table th:first-child {
        z-index: 25;
        /* Corner overlaps both top and left sticky */
        background: #f8f9fa;
    }

    /* Professional Announcement Styles */
    .announcement-icon-lg {
        width: 48px;
        height: 48px;
        background: #eff6ff;
        color: var(--keka-primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .announcement-title-large {
        font-size: 18px;
        font-weight: 700;
        color: var(--keka-text-primary);
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .announcement-meta-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        font-size: 13px;
        color: var(--keka-text-secondary);
        gap: 12px;
    }

    .announcement-hero-image {
        width: 100%;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        object-fit: contain;
        max-height: 300px;
        background-color: #f8f9fa;
    }

    .announcement-body-text {
        font-size: 14px;
        line-height: 1.7;
        color: #374151;
        white-space: pre-line;
    }

    .carousel-nav-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        color: var(--keka-primary);
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        bottom: 24px;
        right: 24px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
        font-size: 16px;
    }

    .carousel-nav-btn:hover {
        background: var(--keka-primary);
        color: white;
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 25px rgba(91, 71, 251, 0.25);
        border-color: var(--keka-primary);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 20px;
    }

    .carousel-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 16px;
        margin-top: auto;
        border-top: 1px solid var(--keka-border);
    }

    .carousel-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid var(--keka-border);
        background: white;
        color: var(--keka-text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .carousel-btn:hover {
        background: var(--keka-primary);
        color: white;
        border-color: var(--keka-primary);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(91, 71, 251, 0.2);
    }

    .carousel-btn:active {
        transform: scale(0.95);
    }

    .carousel-indicators {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #cbd5e1;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .indicator:hover {
        background: var(--keka-purple);
    }

    .indicator.active {
        background: var(--keka-primary);
        width: 24px;
        border-radius: 12px;
    }

    /* === RESPONSIVE ANNOUNCEMENTS === */
    @media (max-width: 1200px) {
        .announcements-card {
            min-height: 350px;
            max-height: 500px;
        }
        
        .announcements-header {
            padding: 18px;
        }
        
        .announcements-title {
            font-size: 16px;
        }
        
        .tab-btn {
            padding: 5px 10px;
            font-size: 11px;
        }
    }

    @media (max-width: 992px) {
        .announcements-card {
            min-height: 320px;
            max-height: 450px;
        }
        
        .announcements-header {
            padding: 16px;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }
        
        .announcements-title {
            font-size: 15px;
        }
        
        .announcements-tabs {
            width: 100%;
            justify-content: flex-start;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .announcements-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .announcement-content-wrapper {
            padding: 16px;
        }
        
        .announcement-item {
            padding: 14px 16px;
            min-height: 70px;
        }
        
        .announcement-icon {
            width: 38px;
            height: 38px;
            font-size: 16px;
            margin-right: 14px;
        }
        
        .announcement-text {
            font-size: 13px;
        }
        
        .announcement-subtext {
            font-size: 11px;
        }
        
        .announcement-date {
            font-size: 11px;
            padding: 3px 8px;
        }
    }

    @media (max-width: 768px) {
        .announcements-card {
            min-height: 280px;
            max-height: 400px;
        }
        
        .announcements-header {
            padding: 14px;
        }
        
        .announcements-title {
            font-size: 14px;
            gap: 8px;
        }
        
        .announcements-tabs {
            gap: 8px;
        }
        
        .tab-btn {
            padding: 4px 8px;
            font-size: 10px;
            min-height: 28px;
        }
        
        .announcement-content-wrapper {
            padding: 14px;
        }
        
        .announcement-item {
            padding: 12px 14px;
            min-height: 60px;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .announcement-item-header {
            display: flex;
            align-items: flex-start;
            width: 100%;
            gap: 12px;
        }
        
        .announcement-icon {
            width: 34px;
            height: 34px;
            font-size: 14px;
            margin-right: 0;
        }
        
        .announcement-details {
            flex: 1;
            min-width: 0;
        }
        
        .announcement-text {
            font-size: 12px;
            line-height: 1.4;
        }
        
        .announcement-subtext {
            font-size: 10px;
            line-height: 1.3;
        }
        
        .announcement-date {
            font-size: 10px;
            padding: 2px 6px;
            margin-left: 0;
            align-self: flex-end;
        }
        
        .announcement-title-large {
            font-size: 16px;
        }
        
        .announcement-meta-row {
            font-size: 11px;
            gap: 8px;
        }
        
        .announcement-hero-image {
            max-height: 200px;
            margin-bottom: 16px;
        }
        
        .carousel-controls {
            padding: 12px 14px;
        }
        
        .carousel-btn {
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
        }
        
        .carousel-indicators {
            max-width: 150px;
        }
    }

    @media (max-width: 576px) {
        .announcements-card {
            min-height: 250px;
            max-height: 350px;
        }
        
        .announcements-header {
            padding: 12px;
        }
        
        .announcements-title {
            font-size: 13px;
        }
        
        .announcements-tabs {
            gap: 6px;
        }
        
        .tab-btn {
            padding: 3px 6px;
            font-size: 9px;
            min-height: 24px;
        }
        
        .announcement-content-wrapper {
            padding: 12px;
        }
        
        .announcement-item {
            padding: 10px 12px;
            min-height: 50px;
        }
        
        .announcement-icon {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }
        
        .announcement-text {
            font-size: 11px;
        }
        
        .announcement-subtext {
            font-size: 9px;
        }
        
        .announcement-date {
            font-size: 9px;
            padding: 2px 4px;
        }
        
        .announcement-title-large {
            font-size: 14px;
        }
        
        .announcement-meta-row {
            font-size: 10px;
            gap: 6px;
        }
        
        .announcement-hero-image {
            max-height: 150px;
            margin-bottom: 12px;
        }
        
        .carousel-controls {
            padding: 10px 12px;
        }
        
        .carousel-btn {
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            font-size: 10px;
        }
        
        .carousel-indicators {
            max-width: 100px;
        }
        
        .indicator {
            width: 4px;
            height: 4px;
        }
        
        .indicator.active {
            width: 16px;
        }
    }

    @media (max-width: 400px) {
        .announcements-card {
            min-height: 220px;
            max-height: 300px;
        }
        
        .announcements-header {
            padding: 10px;
        }
        
        .announcements-title {
            font-size: 12px;
        }
        
        .tab-btn {
            padding: 2px 4px;
            font-size: 8px;
            min-height: 20px;
        }
        
        .announcement-content-wrapper {
            padding: 10px;
        }
        
        .announcement-item {
            padding: 8px 10px;
            min-height: 45px;
        }
        
        .announcement-icon {
            width: 26px;
            height: 26px;
            font-size: 11px;
        }
        
        .announcement-text {
            font-size: 10px;
        }
        
        .announcement-subtext {
            font-size: 8px;
        }
        
        .announcement-date {
            font-size: 8px;
        }
        
        .announcement-title-large {
            font-size: 12px;
        }
        
        .carousel-controls {
            padding: 8px 10px;
        }
    }

    /* Landscape orientation adjustments */
    @media (max-width: 896px) and (orientation: landscape) {
        .announcements-card {
            min-height: 200px;
            max-height: 280px;
        }
        
        .announcements-header {
            padding: 12px;
            flex-direction: row;
            gap: 8px;
        }
        
        .announcement-item {
            min-height: 50px;
            flex-direction: row;
            align-items: center;
        }
        
        .announcement-date {
            margin-left: 8px;
            align-self: center;
        }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
        .announcement-item:hover {
            background: #fdfdfd;
        }
        
        .tab-btn {
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .carousel-btn {
            min-width: 44px;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .indicator {
            min-width: 20px;
            min-height: 20px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Improve scrolling on touch devices */
        .announcement-content-wrapper,
        .tab-content {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .announcements-tabs {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
    }

    /* Insight Cards Hover */
    .insight-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .insight-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    .insight-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        opacity: 0;
        transition: opacity 0.3s;
    }

    .insight-card:hover::after {
        opacity: 1;
    }

    /* Insight Modal Styles */
    .insight-modal-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .insight-modal-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--keka-border);
        transition: background 0.2s;
        cursor: pointer;
    }

    .insight-modal-item:last-child {
        border-bottom: none;
    }

    .insight-modal-item:hover {
        background: #f8fafc;
    }

    .insight-employee-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--keka-primary), var(--keka-purple));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 12px;
    }

    .insight-employee-info {
        flex: 1;
    }

    .insight-employee-name {
        font-weight: 600;
        color: var(--keka-text-primary);
        font-size: 14px;
    }

    .insight-employee-dept {
        font-size: 12px;
        color: var(--keka-text-secondary);
    }

    .insight-time {
        font-size: 12px;
        color: var(--keka-primary);
        font-weight: 600;
        background: rgba(91, 71, 251, 0.05);
        padding: 4px 8px;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 pb-4">
    <!-- Row 1: Today's Insights & Announcements -->
    <div class="row mb-4">
        <!-- Today's Insights (Vertical Stack) -->
        <div class="col-md-4">
            <div class="keka-card h-100">
                <div class="card-title-keka mb-4">
                    <i class="fas fa-search me-2 text-primary"></i> Today's Insights
                </div>
                <div class="vstack gap-3">
                    <!-- Late Arrivals -->
                    <div class="p-3 rounded-3 d-flex justify-content-between align-items-center insight-card"
                        onclick="showInsightDetails('Late Arrivals', 'late')"
                        style="background: #fffbeb; border: 1px solid #fef3c7; cursor: pointer;">
                        <div>
                            <div class="h3 fw-bold mb-1 text-warning">{{ late_arrivals }}</div>
                            <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.7rem;">Late
                                Arrivals</div>
                        </div>
                        <div
                            style="width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-running text-warning"></i>
                        </div>
                    </div>

                    <!-- Early Departures -->
                    <div class="p-3 rounded-3 d-flex justify-content-between align-items-center insight-card"
                        onclick="showInsightDetails('Early Departures', 'early')"
                        style="background: #eff6ff; border: 1px solid #dbeafe; cursor: pointer;">
                        <div>
                            <div class="h3 fw-bold mb-1 text-primary">{{ early_departures }}</div>
                            <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.7rem;">Early
                                Departures</div>
                        </div>
                        <div
                            style="width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-sign-out-alt text-primary"></i>
                        </div>
                    </div>

                    <!-- On Duty -->
                    <div class="p-3 rounded-3 d-flex justify-content-between align-items-center insight-card"
                        onclick="showInsightDetails('On Duty', 'onduty')"
                        style="background: #ecfeff; border: 1px solid #cffafe; cursor: pointer;">
                        <div>
                            <div class="h3 fw-bold mb-1 text-info">{{ on_duty_count }}</div>
                            <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.7rem;">On Duty
                            </div>
                        </div>
                        <div
                            style="width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-briefcase text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Announcements Widget -->
        <div class="col-md-8">
            <div class="announcements-card">
                <div class="announcements-header">
                    <h3 class="announcements-title"><i class="fas fa-bullhorn"></i> Announcements</h3>
                    <div class="announcements-tabs-wrapper">
                        <div class="announcements-tabs">
                            <button class="tab-btn active" onclick="switchTab('announcements')">Announcements</button>
                            <button class="tab-btn" onclick="switchTab('birthdays')">Birthdays</button>
                            <button class="tab-btn" onclick="switchTab('anniv')">Work Anniv.</button>
                            <button class="tab-btn" onclick="switchTab('holidays')">Holidays</button>
                        </div>
                    </div>
                </div>

                <div class="announcements-body" id="announcementsContent">
                    <!-- 0. Custom Announcements Content -->
                    <div id="tab-announcements" class="tab-content fade-in" style="height: 100%; min-height: 300px;">
                        {% if announcements %}
                        <div class="announcement-carousel h-100 position-relative p-4">
                            {% for announcement in announcements %}
                            <div class="announcement-slide {% if not forloop.first %}d-none{% endif %} fade-in h-100 d-flex flex-column"
                                data-index="{{ forloop.counter0 }}">

                                <div class="announcement-content-wrapper custom-scrollbar pe-2"
                                    style="overflow-y: auto; flex: 1;">
                                    <div class="d-flex align-items-start mb-4">
                                        <div class="announcement-icon-lg me-3">
                                            <i class="fas fa-bullhorn"></i>
                                        </div>
                                        <div>
                                            <h4 class="announcement-title-large">{{ announcement.title }}</h4>
                                            <div class="announcement-meta-row">
                                                <span><i class="far fa-calendar-alt me-1"></i> {{ announcement.created_at|date:"d M Y" }}</span>
                                                {% if announcement.location %}
                                                <span class="text-primary bg-soft-primary px-2 py-1 rounded small"><i
                                                        class="fas fa-map-marker-alt me-1"></i> {{ announcement.location.name }}</span>
                                                {% else %}
                                                <span class="text-warning bg-soft-warning px-2 py-1 rounded small"><i
                                                        class="fas fa-globe me-1"></i> Global</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    {% if announcement.image %}
                                    <div class="mb-3">
                                        <img src="{{ announcement.image.url }}" alt="{{ announcement.title }}"
                                            class="announcement-hero-image">
                                    </div>
                                    {% endif %}

                                    <div class="announcement-content">
                                        {{ announcement.content|safe }}
                                    </div>
                                </div>

                                {% if announcements|length > 1 %}
                                <div class="carousel-controls">
                                    <button class="carousel-btn prev" onclick="previousAnnouncement()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="carousel-indicators">
                                        {% for ann in announcements %}
                                        <span class="indicator {% if forloop.first %}active{% endif %}"
                                            data-index="{{ forloop.counter0 }}"></span>
                                        {% endfor %}
                                    </div>
                                    <button class="carousel-btn next" onclick="nextAnnouncement()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bullhorn"></i>
                            <p>No announcements at this time</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 1. Birthdays Content -->
                    <div id="tab-birthdays" class="tab-content fade-in" style="display: none;">
                        {% if upcoming_birthdays %}
                        {% for birthday in upcoming_birthdays %}
                        <div class="announcement-item">
                            <div class="announcement-item-header">
                                <div class="announcement-icon" style="background: #fef3c7; color: #f59e0b;">
                                    <i class="fas fa-birthday-cake"></i>
                                </div>
                                <div class="announcement-details">
                                    <div class="announcement-text">{{ birthday.employee.user.get_full_name }}</div>
                                    <div class="announcement-subtext">
                                        {{ birthday.employee.designation|default:"N/A" }} • {{ birthday.employee.department|default:"N/A" }}
                                    </div>
                                </div>
                            </div>
                            <div class="announcement-date">
                                {% if birthday.is_today %}
                                Today!
                                {% elif birthday.days_left == 1 %}
                                Tomorrow
                                {% else %}
                                in {{ birthday.days_left }} days
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-birthday-cake"></i>
                            <p>No upcoming birthdays</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 2. Work Anniversaries Content -->
                    <div id="tab-anniv" class="tab-content fade-in" style="display: none;">
                        {% if upcoming_anniversaries %}
                        {% for anniversary in upcoming_anniversaries %}
                        <div class="announcement-item">
                            <div class="announcement-item-header">
                                <div class="announcement-icon" style="background: #e0e7ff; color: #6366f1;">
                                    <i class="fas fa-award"></i>
                                </div>
                                <div class="announcement-details">
                                    <div class="announcement-text">{{ anniversary.employee.user.get_full_name }}</div>
                                    <div class="announcement-subtext">
                                        {{ anniversary.employee.designation|default:"N/A" }} • {{ anniversary.employee.department|default:"N/A" }} • {{ anniversary.years }} year{{ anniversary.years|pluralize }}
                                    </div>
                                </div>
                            </div>
                            <div class="announcement-date">
                                {% if anniversary.is_today %}
                                Today!
                                {% elif anniversary.days_left == 1 %}
                                Tomorrow
                                {% else %}
                                in {{ anniversary.days_left }} days
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-award"></i>
                            <p>No upcoming work anniversaries</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 3. Holidays Content -->
                    <div id="tab-holidays" class="tab-content fade-in" style="display: none;">
                        {% if upcoming_holidays %}
                        {% for holiday in upcoming_holidays %}
                        <div class="announcement-item">
                            <div class="announcement-item-header">
                                <div class="announcement-icon" style="background: #d1fae5; color: #059669;">
                                    <i class="fas fa-umbrella-beach"></i>
                                </div>
                                <div class="announcement-details">
                                    <div class="announcement-text">{{ holiday.name }}</div>
                                    <div class="announcement-subtext">
                                        {{ holiday.get_location_display }} • {{ holiday.get_holiday_type_display }}
                                    </div>
                                </div>
                            </div>
                            <div class="announcement-date">
                                {{ holiday.date|date:"D, d M" }}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-umbrella-beach"></i>
                            <p>No upcoming holidays</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Department Performance & Leave Requests -->
    <div class="row mb-4">
        <!-- Department Performance -->
        <div class="col-md-8">
            <div class="keka-card h-100">
                <div class="card-title-keka mb-4">
                    <i class="fas fa-building me-2 text-primary"></i> Department Performance (Present %)
                </div>

                <div class="department-performance-container">
                    <table class="table table-borderless align-middle department-performance-table">
                        <thead class="text-muted small text-uppercase fw-bold"
                            style="border-bottom: 1px solid #f3f4f6;">
                            <tr>
                                <th class="ps-0">Department</th>
                                <th class="text-center">Present</th>
                                <th class="text-center">Total</th>
                                <th style="width: 40%;">Presence</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in department_performance %}
                            <tr>
                                <td class="ps-0 fw-bold text-dark py-3">{{ dept.name }}</td>
                                <td class="text-center text-muted">{{ dept.present }}</td>
                                <td class="text-center text-muted">{{ dept.total }}</td>
                                <td>
                                    <div class="department-progress-container">
                                        <div class="department-progress-bar">
                                            <div class="department-progress-fill" 
                                                style="width: {{ dept.percentage }}%;"
                                                role="progressbar"
                                                aria-valuenow="{{ dept.percentage }}" 
                                                aria-valuemin="0"
                                                aria-valuemax="100"></div>
                                        </div>
                                        <span class="department-percentage">{{ dept.percentage }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">No department data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Leave Requests -->
        <div class="col-md-4">
            <div class="requests-section" style="height: 100%;">
                <h2 class="section-title">Leave Requests</h2>
                <div id="leaveRequests">
                    {% if pending_leave_requests %}
                    {% for request in pending_leave_requests %}
                    <div class="request-card">
                        <div class="employee-avatar">
                            {{ request.employee.user.first_name|first }}{{ request.employee.user.last_name|first }}
                        </div>
                        <div class="request-info">
                            <div class="employee-name">
                                {{ request.employee.user.get_full_name }}
                                <span
                                    class="leave-badge {% if request.leave_type == 'SL' %}sick{% elif request.leave_type == 'CL' %}personal{% else %}medical{% endif %}">
                                    {{ request.get_leave_type_display|upper }}
                                </span>
                            </div>
                            <div class="request-meta">
                                {{ request.start_date|date:"jS M" }} - {{ request.end_date|date:"jS M" }}
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn-action btn-reject"
                                onclick="handleLeaveAction({{ request.id }}, 'reject')">Reject</button>
                            <button class="btn-action btn-approve"
                                onclick="handleLeaveAction({{ request.id }}, 'approve')">Approve</button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p style="text-align: center; color: var(--keka-text-secondary); padding: 40px;">
                        No pending leave requests
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Calendar -->
    <div class="calendar-section" id="calendarSection">
        <div class="calendar-header">
            <h2 class="section-title" style="margin: 0;">{{ current_month }} {{ current_year }}</h2>
            <div class="d-flex align-items-center gap-2">
                <div class="month-nav">
                    <a href="?month={{ prev_month }}&year={{ prev_year }}" class="month-btn text-decoration-none">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <span class="month-label">{{ current_month }} {{ current_year }}</span>
                    <a href="?month={{ next_month }}&year={{ next_year }}" class="month-btn text-decoration-none">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
                <button class="btn btn-sm btn-light border ms-2" onclick="toggleMaximizeCalendar()"
                    title="Maximize/Minimize">
                    <i class="fas fa-expand" id="maximizeIcon"></i>
                </button>
            </div>
        </div>

        <div class="calendar-scroll-area">
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th style="text-align: left; min-width: 180px;">Employee</th>
                        {% for day in employee_calendar_data.0.days %}
                        <th>{{ day.day }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for emp_data in employee_calendar_data %}
                    <tr>
                        <td>
                            <div class="employee-info">
                                <div class="employee-mini-avatar">
                                    {{ emp_data.employee.user.first_name|first }}
                                    {{ emp_data.employee.user.last_name|first }}
                                </div>
                                <div class="employee-details">
                                    <div class="employee-details-name">{{ emp_data.employee.user.get_full_name }}</div>
                                </div>
                            </div>
                        </td>
                        {% for day in emp_data.days %}
                        <td>
                            <div class="day-cell {{ day.status }}" title="{{ day.date|date:'d M Y' }}">
                                {{ day.day }}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: transparent; border: 1px solid #e5e7eb;"></div>
                <span>Present</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--keka-warning);"></div>
                <span>Weekly off</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #dc2626;"></div>
                <span>Leave</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #7c3aed;"></div>
                <span>LOP</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--keka-info);"></div>
                <span>Holiday</span>
            </div>
        </div>
    </div>

    <!-- Insight Details Modal -->
    <div class="modal fade" id="insightModal" tabindex="-1" aria-labelledby="insightModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark" id="insightModalLabel">Insight Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-3">
                    <div id="insightModalContent">
                        <!-- Content will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Insight Modal Logic
    const insightData = {
        late: [
            {% for att in late_arrivals_list %}
    {
        name: "{{ att.employee.user.get_full_name }}",
            designation: "{{ att.employee.designation|default:'N/A' }}",
                dept: "{{ att.employee.department|default:'N/A' }}",
                    time: "{{ att.clock_in|time:'h:i A' }}",
                        id: "{{ att.employee.id }}",
                            initials: "{{ att.employee.user.first_name|first }}{{ att.employee.user.last_name|first }}"
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
        ],
    early: [
        {% for att in early_departures_list %}
    {
        name: "{{ att.employee.user.get_full_name }}",
            designation: "{{ att.employee.designation|default:'N/A' }}",
                dept: "{{ att.employee.department|default:'N/A' }}",
                    time: "{{ att.clock_out|time:'h:i A' }}",
                        id: "{{ att.employee.id }}",
                            initials: "{{ att.employee.user.first_name|first }}{{ att.employee.user.last_name|first }}"
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
        ],
    onduty: [
        {% for att in on_duty_list %}
    {
        name: "{{ att.employee.user.get_full_name }}",
            designation: "{{ att.employee.designation|default:'N/A' }}",
                dept: "{{ att.employee.department|default:'N/A' }}",
                    time: "{% if att.clock_in %}{{ att.clock_in|time:'h:i A' }}{% else %}N/A{% endif %}",
                        id: "{{ att.employee.id }}",
                            initials: "{{ att.employee.user.first_name|first }}{{ att.employee.user.last_name|first }}"
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
        ]
    };

    function showInsightDetails(title, type) {
        const modal = new bootstrap.Modal(document.getElementById('insightModal'));
        document.getElementById('insightModalLabel').innerText = title;

        const container = document.getElementById('insightModalContent');
        const data = insightData[type];

        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-user-slash mb-3" style="font-size: 3rem; opacity: 0.2;"></i>
                    <p>No employees found for this category</p>
                </div>
            `;
        } else {
            let html = '<div class="insight-modal-list">';
            data.forEach(item => {
                html += `
                    <div class="insight-modal-item" onclick="window.location.href='/employees/${item.id}/detail/'">
                        <div class="insight-employee-avatar">${item.initials.toUpperCase()}</div>
                        <div class="insight-employee-info">
                            <div class="insight-employee-name">${item.name}</div>
                            <div class="insight-employee-dept">${item.designation}</div>
                        </div>
                        <div class="insight-time">${item.time}</div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        modal.show();
    }

    // Real-time auto-refresh
    let refreshInterval;

    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            refreshDashboardData();
        }, 30000); // Refresh every 30 seconds
    }

    async function refreshDashboardData() {
        try {
            // In a real implementation, this would fetch from an API endpoint
            // For now, we'll just reload the page
            // location.reload();

            // Simulate real-time update with animation
            animateStatUpdate();
        } catch (error) {
            console.error('Error refreshing dashboard:', error);
        }
    }

    function animateStatUpdate() {
        const statValues = document.querySelectorAll('.stat-value');
        statValues.forEach(stat => {
            stat.style.animation = 'none';
            setTimeout(() => {
                stat.style.animation = 'countUp 0.5s ease-out';
            }, 10);
        });
    }

    function handleLeaveAction(requestId, action) {
        if (action === 'approve') {
            if (confirm('Are you sure you want to approve this leave request?')) {
                // Submit approval
                window.location.href = `/leaves/requests/?action=approve&id=${requestId}`;
            }
        } else {
            const reason = prompt('Please enter rejection reason:');
            if (reason) {
                // Submit rejection
                window.location.href = `/leaves/requests/?action=reject&id=${requestId}&reason=${encodeURIComponent(reason)}`;
            }
        }
    }

    function changeMonth(direction) {
        // Implement month navigation
        console.log('Change month:', direction);
    }

    // Start auto-refresh on page load
    document.addEventListener('DOMContentLoaded', () => {
        startAutoRefresh();
    });

    // Stop auto-refresh when page is hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            clearInterval(refreshInterval);
        } else {
            startAutoRefresh();
        }
    });

    // Tab Switching Logic
    function switchTab(tabName) {
        // Hide all contents
        document.querySelectorAll('.tab-content').forEach(el => {
            el.style.display = 'none';
        });

        // Remove active class from buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected content
        document.getElementById(`tab-${tabName}`).style.display = 'block';

        // Activate button
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => {
            if (btn.getAttribute('onclick').includes(tabName)) {
                btn.classList.add('active');
            }
        });
    }

    function toggleMaximizeCalendar() {
        const section = document.getElementById('calendarSection');
        const icon = document.getElementById('maximizeIcon');

        section.classList.toggle('maximized');

        if (section.classList.contains('maximized')) {
            icon.classList.remove('fa-expand');
            icon.classList.add('fa-compress');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        } else {
            icon.classList.remove('fa-compress');
            icon.classList.add('fa-expand');
            document.body.style.overflow = ''; // Restore background scrolling
        }
    }

    // Employee Search Functionality
    let searchTimeout;
    const searchInput = document.getElementById('employeeSearchInput');
    const searchResults = document.getElementById('searchResults');

    if (searchInput) {
        // Search on input with debouncing
        searchInput.addEventListener('input', function () {
            const query = this.value.trim();

            // Clear previous timeout
            clearTimeout(searchTimeout);

            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            // Show loading state
            searchResults.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
            searchResults.style.display = 'block';

            // Debounce search (wait 300ms after user stops typing)
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // Close search results when clicking outside
        document.addEventListener('click', function (e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Reopen results when clicking on input if there's content
        searchInput.addEventListener('focus', function () {
            if (this.value.trim().length >= 2 && searchResults.innerHTML) {
                searchResults.style.display = 'block';
            }
        });
    }

    function performSearch(query) {
        fetch(`/api/search-employees/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.employees);
            })
            .catch(error => {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="search-no-results"><i class="fas fa-exclamation-circle"></i><div>Error performing search</div></div>';
            });
    }

    function displaySearchResults(employees) {
        if (employees.length === 0) {
            searchResults.innerHTML = `
                <div class="search-no-results">
                    <i class="fas fa-user-slash"></i>
                    <div>No employees found</div>
                </div>
            `;
            return;
        }

        let html = '';
        employees.forEach(emp => {
            // Get initials for avatar
            const nameParts = emp.name.split(' ');
            const initials = nameParts.length > 1
                ? nameParts[0][0] + nameParts[nameParts.length - 1][0]
                : nameParts[0][0];

            html += `
                <div class="search-result-item" onclick="navigateToEmployee('${emp.profile_url}')">
                    <div class="search-result-avatar">${initials.toUpperCase()}</div>
                    <div class="search-result-details">
                        <div class="search-result-name">${emp.name}</div>
                        <div class="search-result-meta">
                            <span><i class="fas fa-id-badge"></i> ${emp.employee_id}</span>
                            <span><i class="fas fa-briefcase"></i> ${emp.designation}</span>
                            <span><i class="fas fa-building"></i> ${emp.department}</span>
                            <span><i class="fas fa-map-marker-alt"></i> ${emp.location}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        searchResults.innerHTML = html;
    }

    function navigateToEmployee(url) {
        window.location.href = url;
    }

    // Auto-rotate tabs occasionally if user is idle? Maybe too distracting.
    // Let's keep it manual for now as requested "advance css js" implies sleekness not necessarily chaos.

    // Announcement Carousel Logic
    let currentAnnouncementIndex = 0;

    function updateCarousel() {
        const slides = document.querySelectorAll('.announcement-slide');
        if (!slides.length) return;

        slides.forEach((slide, index) => {
            if (index === currentAnnouncementIndex) {
                slide.classList.remove('d-none');

                // Update indicators for this slide's control bar
                const indicators = slide.querySelectorAll('.indicator');
                indicators.forEach((ind, i) => {
                    if (i === currentAnnouncementIndex) {
                        ind.classList.add('active');
                    } else {
                        ind.classList.remove('active');
                    }
                });
            } else {
                slide.classList.add('d-none');
            }
        });
    }

    function nextAnnouncement() {
        const slides = document.querySelectorAll('.announcement-slide');
        if (!slides.length) return;

        currentAnnouncementIndex = (currentAnnouncementIndex + 1) % slides.length;
        updateCarousel();
    }

    function previousAnnouncement() {
        const slides = document.querySelectorAll('.announcement-slide');
        if (!slides.length) return;

        currentAnnouncementIndex = (currentAnnouncementIndex - 1 + slides.length) % slides.length;
        updateCarousel();
    }

    // Optional: Auto-rotate specific logic if needed, but manual control is often preferred for announcements
    // function autoRotateAnnouncements() {
    //     setInterval(() => {
    //         nextAnnouncement();
    //     }, 5000);
    // }

    // Enhanced scrolling behavior for announcements
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth scrolling behavior to tab content
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.style.scrollBehavior = 'smooth';
        });

        // Add touch scroll indicators for mobile
        const announcementWrapper = document.querySelector('.announcement-content-wrapper');
        if (announcementWrapper) {
            let isScrolling = false;
            
            announcementWrapper.addEventListener('scroll', function() {
                if (!isScrolling) {
                    isScrolling = true;
                    this.classList.add('scrolling');
                    
                    // Remove scrolling class after scroll ends
                    clearTimeout(this.scrollTimeout);
                    this.scrollTimeout = setTimeout(() => {
                        this.classList.remove('scrolling');
                        isScrolling = false;
                    }, 150);
                }
            });
        }

        // Enhanced tab scrolling for mobile
        const tabsWrapper = document.querySelector('.announcements-tabs-wrapper');
        if (tabsWrapper) {
            let scrollIndicatorTimeout;
            
            // Add scroll indicator on mobile
            if (window.innerWidth <= 768) {
                const tabs = tabsWrapper.querySelector('.announcements-tabs');
                if (tabs.scrollWidth > tabs.clientWidth) {
                    tabs.classList.add('has-scroll');
                    
                    // Add scroll event listener
                    tabs.addEventListener('scroll', function() {
                        clearTimeout(scrollIndicatorTimeout);
                        this.classList.add('scrolling');
                        
                        scrollIndicatorTimeout = setTimeout(() => {
                            this.classList.remove('scrolling');
                        }, 1000);
                    });
                }
            }
        }

        // Optimize carousel controls for touch devices
        const carouselBtns = document.querySelectorAll('.carousel-btn');
        carouselBtns.forEach(btn => {
            btn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.classList.add('touch-active');
            });
            
            btn.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.classList.remove('touch-active');
                this.click();
            });
        });

        // Add keyboard navigation for accessibility
        document.addEventListener('keydown', function(e) {
            if (e.target.closest('.announcements-card')) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousAnnouncement();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextAnnouncement();
                }
            }
        });

        // Auto-adjust announcement height based on content
        function adjustAnnouncementHeight() {
            const announcementCards = document.querySelectorAll('.announcements-card');
            announcementCards.forEach(card => {
                const header = card.querySelector('.announcements-header');
                const body = card.querySelector('.announcements-body');
                
                if (header && body) {
                    const headerHeight = header.offsetHeight;
                    const availableHeight = card.offsetHeight - headerHeight;
                    body.style.height = `${availableHeight}px`;
                }
            });
        }

        // Adjust on load and resize
        adjustAnnouncementHeight();
        window.addEventListener('resize', adjustAnnouncementHeight);

        // Department Performance Table Scroll Handling
        const deptContainer = document.querySelector('.department-performance-container');
        if (deptContainer) {
            let scrollTimeout;
            
            deptContainer.addEventListener('scroll', function() {
                // Add scrolled class to hide scroll indicator
                this.classList.add('scrolled');
                
                // Remove scrolled class after scroll ends
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    this.classList.remove('scrolled');
                }, 2000);
            });
            
            // Add touch feedback for mobile
            if (window.innerWidth <= 768) {
                deptContainer.addEventListener('touchstart', function() {
                    this.style.boxShadow = '0 4px 25px rgba(91, 71, 251, 0.15)';
                });
                
                deptContainer.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    }, 200);
                });
            }
        }

        // Animate progress bars on load
        function animateProgressBars() {
            const progressBars = document.querySelectorAll('.department-progress-fill');
            progressBars.forEach((bar, index) => {
                const width = bar.style.width;
                bar.style.width = '0%';
                
                setTimeout(() => {
                    bar.style.transition = 'width 1s ease-out';
                    bar.style.width = width;
                }, index * 200);
            });
        }
        
        // Animate progress bars after a short delay
        setTimeout(animateProgressBars, 500);
    });

</script>
{% endblock %}